name: EOD Latest (NASDAQ-100)

on:
  schedule:
    - cron: "10 22 * * 1-5"
  workflow_dispatch:
    inputs:
      universe:
        description: "Universe"
        default: "nasdaq100"
        required: false

permissions:
  contents: write

concurrency:
  group: eod-latest-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  dry-run:
    name: EOD Latest Dry-Run (no secrets)
    if: ${{ vars.RV_CI_MODE == 'dry' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install deps
        run: npm ci
      - name: Contracts (dry-run)
        run: npm run test:contracts

  run:
    if: ${{ vars.RV_CI_MODE != 'dry' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      RV_UNIVERSE: ${{ github.event.inputs.universe || 'nasdaq100' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm ci

      - name: Export Tiingo token (typo-safe)
        run: |
          set -euo pipefail
          if [ -n "${{ secrets.TIINGO_API_KEY }}" ]; then
            echo "TIINGO_API_KEY=${{ secrets.TIINGO_API_KEY }}" >> "$GITHUB_ENV"
          elif [ -n "${{ secrets.TIIANGO_API_KEY }}" ]; then
            echo "TIINGO_API_KEY=${{ secrets.TIIANGO_API_KEY }}" >> "$GITHUB_ENV"
          fi
          if [ -n "${{ secrets.EODHD_API_KEY }}" ]; then
            echo "EODHD_API_KEY=${{ secrets.EODHD_API_KEY }}" >> "$GITHUB_ENV"
          fi

      - name: Preflight (blocking checks)
        run: node scripts/ops/preflight-check.mjs --mode eod-latest

      - name: Provider diagnostics
        run: |
          set -euo pipefail
          echo "universe=${RV_UNIVERSE}"
          if [ -n "${EODHD_API_KEY:-}" ]; then
            echo "provider_eodhd=present"
          else
            echo "provider_eodhd=missing"
          fi
          if [ -n "${TIINGO_API_KEY:-}" ]; then
            echo "provider_tiingo=present"
          else
            echo "provider_tiingo=missing"
          fi

      - name: Build EOD latest
        run: node scripts/eod/build-eod-latest.mjs --universe "$RV_UNIVERSE" --chunk-size 500 --out public/data

      - name: Build safety snapshot
        run: node scripts/ops/build-safety-snapshot.mjs

      - name: Build ops-daily snapshot
        run: npm run rv:ops

      - name: Build ops summary
        run: node scripts/ops/build-mission-control-summary.mjs

      - name: Build ops pulse
        run: node scripts/ops/build-ops-pulse.mjs

      - name: Validate ops summary
        run: node scripts/ops/validate-ops-summary.mjs

      - name: Mission-control blocking gate
        env:
          MC_GATE_STRICT: "1"
        run: node scripts/ci/assert-mission-control-gate.mjs

      - name: Commit + push (if changed)
        run: |
          set -euo pipefail
          git config user.name "RubikVault Bot"
          git config user.email "bot@rubikvault.com"
          git add public/data/eod public/data/pipeline public/data/ops public/data/ops-daily.json docs/architecture/data-layout-law-v1.md
          if git diff --cached --quiet; then
            echo "No staged changes"
            exit 0
          fi
          git commit -m "data(eod): update nasdaq100 latest" || exit 0

          for i in 1 2 3; do
            if git push origin HEAD:main; then
              exit 0
            fi
            echo "push failed (attempt $i); retrying in 5s" >&2
            sleep 5
            git pull --rebase origin main || true
          done
          echo "GREEN-SKIP: push failed after retries (likely concurrent writer); publish deferred." >&2
          echo "GREEN-SKIP: push failed after retries (likely concurrent writer); publish deferred." >> "$GITHUB_STEP_SUMMARY"
          exit 0
