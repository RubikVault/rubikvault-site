name: Ops Daily Snapshot

on:
  schedule:
    - cron: "5 7 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ops-daily-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  dry-run:
    name: Ops Daily Dry-Run (no secrets)
    if: ${{ vars.RV_CI_MODE == 'dry' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install deps
        run: npm ci
      - name: Contracts (dry-run)
        run: npm run test:contracts

  run:
    if: ${{ vars.RV_CI_MODE != 'dry' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm ci

      - name: Preflight (blocking checks)
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN || secrets.CF_API_KEY }}
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
        run: node scripts/ops/preflight-check.mjs --mode ops-daily

      - name: Build MarketPhase from KV (NASDAQ-100)
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN || secrets.CF_API_KEY }}
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
        run: node scripts/pipeline/build-marketphase-from-kv.mjs --universe nasdaq100

      - name: Build pipeline truth (NASDAQ-100)
        run: node scripts/pipeline/build-ndx100-pipeline-truth.mjs

      - name: Build safety snapshot
        run: node scripts/ops/build-safety-snapshot.mjs

      - name: Build ops-daily snapshot
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN || secrets.CF_API_KEY }}
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
        run: node scripts/ops/build-ops-daily.mjs

      - name: Build ops summary
        run: node scripts/ops/build-mission-control-summary.mjs

      - name: Build ops pulse
        run: node scripts/ops/build-ops-pulse.mjs

      - name: Validate ops summary
        run: node scripts/ops/validate-ops-summary.mjs

      - name: Mission-control gate (softfail config-blocked)
        id: mc-gate
        run: |
          set -euo pipefail
          gate_log="${RUNNER_TEMP}/ops-mc-gate.log"
          set +e
          MC_GATE_STRICT=1 node scripts/ci/assert-mission-control-gate.mjs 2>&1 | tee "$gate_log"
          gate_exit=$?
          set -e
          if [ "$gate_exit" -ne 0 ]; then
            if grep -Eq 'NO_API_KEY' "$gate_log"; then
              echo "skip_publish=true" >> "$GITHUB_OUTPUT"
              echo "GREEN-SKIP: Mission-control blocked on NO_API_KEY; publish skipped, last_good preserved." >> "$GITHUB_STEP_SUMMARY"
              exit 0
            fi
            exit "$gate_exit"
          fi
          echo "skip_publish=false" >> "$GITHUB_OUTPUT"

      - name: Commit + push (if changed)
        if: steps.mc-gate.outputs.skip_publish != 'true'
        run: |
          set -euo pipefail
          git config user.name "RubikVault Bot"
          git config user.email "bot@rubikvault.com"
          git add public/data/pipeline/*.json public/data/ops public/data/ops-daily.json
          if git diff --cached --quiet; then
            echo "No staged changes"
            exit 0
          fi
          git commit -m "chore(ops): update ops-daily snapshot" || exit 0

          for i in 1 2 3; do
            if git push origin HEAD:main; then
              exit 0
            fi
            echo "push failed (attempt $i); retrying in 5s" >&2
            sleep 5
            git pull --rebase origin main || true
          done
          echo "push failed after retries" >&2
          exit 1
