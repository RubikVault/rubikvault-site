name: Monitor Production Artifacts

on:
  schedule:
    - cron: "0 6,18 * * *"
  workflow_dispatch:
    inputs:
      remote_mode:
        description: "Run remote endpoint probes (requires RV_MONITOR_REMOTE=1 or manual override)"
        required: false
        default: "off"

permissions:
  contents: read

concurrency:
  group: monitor-prod-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  repo-contracts:
    name: Repo Artifact Contracts (WAF-safe)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Verify critical artifact contracts
        env:
          RV_MIN_MARKET_PRICE_ROWS: "517"
          RV_MIN_FORECAST_ROWS: "1"
        run: node scripts/ci/verify-artifacts.mjs

      - name: Validate mission-control gate from committed summary
        env:
          MC_GATE_STRICT: "0"
        run: node scripts/ci/assert-mission-control-gate.mjs

  remote-probe:
    name: Optional Remote Probes (auth-aware)
    if: ${{ vars.RV_MONITOR_REMOTE == '1' || github.event.inputs.remote_mode == 'remote' }}
    runs-on: ubuntu-latest
    steps:
      - name: Ensure jq
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi
          jq --version

      - name: Probe remote JSON contracts
        env:
          BASE_URL: ${{ vars.RV_PROD_BASE || 'https://rubikvault.com' }}
          RV_ADMIN_TOKEN: ${{ secrets.RV_ADMIN_TOKEN }}
        run: |
          set -euo pipefail

          auth_header=()
          if [ -n "${RV_ADMIN_TOKEN:-}" ]; then
            auth_header=(-H "X-Admin-Token: ${RV_ADMIN_TOKEN}")
          fi

          fetch_json() {
            local endpoint="$1"
            local out="$2"
            local headers="$3"
            local url="${BASE_URL%/}${endpoint}"
            local status
            local attempt
            for attempt in 1 2 3; do
              status=$(curl -sS -o "$out" -D "$headers" -w "%{http_code}" \
                -H "Cache-Control: no-cache" \
                "${auth_header[@]}" \
                "$url") || status=""
              if [ "$status" = "200" ]; then
                break
              fi
              sleep 2
            done
            if [ "$status" != "200" ]; then
              echo "Remote probe failed: ${endpoint} HTTP=${status:-none}" >&2
              sed -n '1,20p' "$headers" >&2 || true
              head -c 400 "$out" >&2 || true
              exit 1
            fi
            if ! grep -qi '^content-type:.*application/json' "$headers"; then
              echo "Remote probe failed: ${endpoint} content-type is not JSON" >&2
              sed -n '1,20p' "$headers" >&2 || true
              exit 1
            fi
            jq -e . "$out" >/dev/null
            echo "✅ ${endpoint}"
          }

          fetch_json "/data/snapshots/market-prices/latest.json" /tmp/market_prices.json /tmp/market_prices.h
          fetch_json "/data/forecast/latest.json" /tmp/forecast_latest.json /tmp/forecast_latest.h
          fetch_json "/data/forecast/system/status.json" /tmp/forecast_status.json /tmp/forecast_status.h
          fetch_json "/data/marketphase/index.json" /tmp/marketphase_index.json /tmp/marketphase_index.h
          fetch_json "/api/mission-control/summary?debug=1" /tmp/mission_control.json /tmp/mission_control.h
          fetch_json "/api/elliott-scanner" /tmp/elliott_scanner.json /tmp/elliott_scanner.h
          fetch_json "/data/ops/pulse.json" /tmp/ops_pulse.json /tmp/ops_pulse.h

          jq -e '
            ((.schema_version // .schemaVersion // .schema) != null) and
            (((.metadata.record_count // 0) >= 517) or ((.data | length) >= 517))
          ' /tmp/market_prices.json >/dev/null
          jq -e '
            ((.schema_version // .schemaVersion // .schema) != null) and
            ((.data.forecasts | length) > 0)
          ' /tmp/forecast_latest.json >/dev/null
          jq -e '
            ((.schema_version // .schemaVersion // .schema) != null) and
            ((.status // .meta.status) != null)
          ' /tmp/forecast_status.json >/dev/null
          jq -e '
            ((.schema_version // "") | tostring | length > 0) and
            ((.meta.status // "") | tostring | length > 0)
          ' /tmp/mission_control.json >/dev/null
          jq -e '
            ((.ok // false) == true) and
            ((.meta.mode // "") | tostring | length > 0) and
            ((.meta.universeSource // "") | tostring | length > 0)
          ' /tmp/elliott_scanner.json >/dev/null
          jq -e '
            ((.schema_version // "") | tostring | length > 0) and
            ((.meta.build_id // "") | tostring | length > 0) and
            ((.meta.generatedAt // "") | tostring | length > 0)
          ' /tmp/ops_pulse.json >/dev/null

      - name: Remote probe summary
        run: |
          echo "## Remote Probe" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Base: ${{ vars.RV_PROD_BASE || 'https://rubikvault.com' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Result: ✅ JSON contracts verified" >> "$GITHUB_STEP_SUMMARY"
