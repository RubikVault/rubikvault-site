name: 'Forecast v6 Publish (Option A)'

on:
  workflow_dispatch:
    inputs:
      date:
        description: 'Trading date (YYYY-MM-DD), empty for auto'
        required: false
        type: string
  schedule:
    - cron: '0 21 * * 1-5'

concurrency:
  group: forecast-v6-publish
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  NODE_VERSION: '20'
  OMP_NUM_THREADS: '1'
  MKL_NUM_THREADS: '1'
  OPENBLAS_NUM_THREADS: '1'

jobs:
  forecast-v6-publish:
    name: 'Forecast v6 CI Publish'
    runs-on: ubuntu-latest
    timeout-minutes: 35

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Secrecy scan (CI gate)
        run: node scripts/forecast/v6/lib/secrecy_scan.mjs --mode=CI

      - name: Run v6 publish-only pipeline
        id: pipeline
        run: |
          DATE_ARG=""
          if [ -n "${{ inputs.date }}" ]; then
            DATE_ARG="--date=${{ inputs.date }}"
          fi

          node scripts/forecast/v6/run_daily_v6.mjs --mode=CI $DATE_ARG 2>&1 | tee pipeline.log

      - name: Validate published v6 artifacts
        run: |
          DATE_ARG="${{ inputs.date }}"
          if [ -n "$DATE_ARG" ]; then
            node scripts/forecast/v6/lib/validate_published_v6.mjs --date="$DATE_ARG"
          else
            node scripts/forecast/v6/lib/validate_published_v6.mjs
          fi

      - name: Commit and push v6 artifacts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add mirrors/forecast/ledgers/ || true
          git add mirrors/forecast/last_good/pointers.json || true
          git add public/data/forecast/v6/ || true

          if git diff --staged --quiet; then
            echo "No v6 artifact changes to commit"
          else
            git commit -m "chore(forecast-v6): publish $(date +%Y-%m-%d)"
            git push
          fi

      - name: Upload pipeline log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: forecast-v6-pipeline-log
          path: pipeline.log
          retention-days: 30

      - name: Summary
        if: always()
        run: |
          echo "## Forecast v6 Publish" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Option A mode: CI publish-only" >> $GITHUB_STEP_SUMMARY
          echo "- CI never loads weights" >> $GITHUB_STEP_SUMMARY
          echo "- Missing predictions degrades to last_good with success exit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See forecast-v6-pipeline-log artifact for details." >> $GITHUB_STEP_SUMMARY
