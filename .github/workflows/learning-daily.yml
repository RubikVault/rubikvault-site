name: Learning Report Daily

on:
  schedule:
    # Run daily at 19:00 UTC = 20:00 CET (after all daily pipelines)
    - cron: '0 19 * * 1-5'
  workflow_dispatch:
    inputs:
      date:
        description: 'Override date (YYYY-MM-DD)'
        required: false

concurrency:
  group: learning-report-daily
  cancel-in-progress: false

jobs:
  learning-cycle:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run daily learning cycle
        run: |
          DATE_ARG=""
          if [ -n "${{ inputs.date }}" ]; then
            DATE_ARG="--date=${{ inputs.date }}"
          fi
          node scripts/learning/run-daily-learning-cycle.mjs $DATE_ARG

      - name: Generate PDF and send email
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          DATE_ARG=""
          if [ -n "${{ inputs.date }}" ]; then
            DATE_ARG="--date=${{ inputs.date }}"
          fi
          node scripts/learning/email-pdf-report.mjs $DATE_ARG

      - name: Commit learning report
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add mirrors/learning/ public/data/reports/learning-report-latest.json
          if git diff --cached --quiet; then
            echo "No learning data changes to commit"
          else
            git commit -m "chore(learning): daily learning report $(date +%Y-%m-%d)"
            git push
          fi
