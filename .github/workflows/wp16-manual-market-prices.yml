name: WP16 Manual - Market Prices (Stooq)

"on":
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: wp16-manual-market-prices
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm ci

      - name: Build market-prices (real provider chain)
        env:
          ARTIFACTS_DIR: ${{ runner.temp }}/artifacts
          BARS_ARTIFACTS_DIR: ${{ runner.temp }}/artifacts
          EODHD_API_KEY: ${{ secrets.EODHD_API_KEY }}
          TIINGO_API_KEY: ${{ secrets.TIINGO_API_KEY }}
          RV_PRICES_FORCE_REAL: "1"
          RV_FORCE_PROVIDER: eodhd
        run: |
          mkdir -p "$ARTIFACTS_DIR/market-prices"
          node scripts/providers/market-prices-v3.mjs

      - name: WP16 DEBUG (artifact dump)
        env:
          ARTIFACTS_DIR: ${{ runner.temp }}/artifacts
        run: |
          set +e
          echo "== ARTIFACTS_DIR =="
          ls -lah "$ARTIFACTS_DIR" || true
          echo
          echo "== market-prices files =="
          find "$ARTIFACTS_DIR/market-prices" -maxdepth 2 -type f -print -exec wc -c {} \; || true
          echo
          if [ -f "$ARTIFACTS_DIR/market-prices/snapshot.json" ]; then
            echo "== snapshot head =="
            sed -n '1,160p' "$ARTIFACTS_DIR/market-prices/snapshot.json"
            echo
            echo "== snapshot summary =="
            jq -r '{
              schema_version,
              meta_source: (.meta.source // null),
              meta_status: (.meta.status // null),
              meta_reason: (.meta.reason // null),
              metadata_source: (.metadata.source // null),
              metadata_provider: (.metadata.provider // null),
              as_of: (.metadata.as_of // null),
              record_count: (.metadata.record_count // .meta.record_count // null),
              data_len: (if (.data|type)=="array" then (.data|length) else null end),
              error: (.error // null)
            }' "$ARTIFACTS_DIR/market-prices/snapshot.json" || true
          else
            echo "MISSING: $ARTIFACTS_DIR/market-prices/snapshot.json"
          fi
          exit 0

      - name: Finalize (publish into repo path)
        env:
          ARTIFACTS_DIR: ${{ runner.temp }}/artifacts
        run: |
          node scripts/aggregator/finalize.mjs

      - name: Guard market-prices (block stub overwrite)
        id: guard
        run: |
          set -euo pipefail
          node scripts/wp16/guard-market-prices.mjs
      - name: Commit + push (only if guard valid)
        if: steps.guard.outputs.valid == 'true'
        run: |
          git config user.name "RubikVault Bot"
          git config user.email "bot@rubikvault.com"
          git add public/data/snapshots/market-prices/latest.json public/data/snapshots/market-prices/ || true
          git add public/data/snapshots public/data/state/modules/*.json public/data/manifest.json public/data/provider-state.json 2>/dev/null || true
          if git diff --cached --quiet; then
            echo "No staged changes"
            exit 0
          fi
          git commit -m "WP16: manual publish real stooq market-prices" || exit 0
          git push origin HEAD:main

      - name: Summary
        if: always()
        run: |
          echo "guard.valid=${{ steps.guard.outputs.valid }}" >> $GITHUB_STEP_SUMMARY
          echo "guard.reason=${{ steps.guard.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
