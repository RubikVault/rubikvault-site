name: v3 Scrape Template

on:
  schedule:
    # Run at 22:30 UTC on market days
    - cron: "30 22 * * 1-5"
  workflow_dispatch:
    inputs:
      modules:
        description: 'Modules to scrape (comma-separated, or "all")'
        required: false
        default: 'all'

concurrency:
  group: v3-scrape-template-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Determine which modules to scrape
  prepare:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: "WP16 DEBUG: dump market-prices artifacts"
        if: always()
        env:
          ARTIFACTS_DIR: ${{ runner.temp }}/artifacts
        run: |
          set -euo pipefail
          echo "=== DEBUG: artifacts root ==="
          ls -lah "$ARTIFACTS_DIR" || true
          echo ""
          echo "=== DEBUG: find snapshot.json/module-state.json ==="
          find "$ARTIFACTS_DIR" -maxdepth 4 -type f \( -name "snapshot.json" -o -name "module-state.json" \) -print -exec wc -c {} \; || true
          echo ""
          echo "=== DEBUG: print market-prices snapshot.json (first 120 lines) ==="
          if [ -f "$ARTIFACTS_DIR/market-prices/snapshot.json" ]; then
            sed -n '1,120p' "$ARTIFACTS_DIR/market-prices/snapshot.json"
            echo ""
            echo "=== DEBUG: jq key fields ==="
            jq -r '{
              schema_version: (.schema_version // null),
              meta_source: (.meta.source // null),
              metadata_source: (.metadata.source // null),
              metadata_provider: (.metadata.provider // null),
              record_count: (.metadata.record_count // null),
              data_len: (if ((.data|type)=="array") then (.data|length) else 0 end),
              error: (.error // null)
            }' "$ARTIFACTS_DIR/market-prices/snapshot.json"
          else
            echo "MISSING: $ARTIFACTS_DIR/market-prices/snapshot.json"
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate module matrix
        id: set-matrix
        run: |
          # Read enabled modules from registry (fallback-safe)
          MODULES=$(node -e "
            const fs = require('fs');
            const path = require('path');
            const candidates = [
              path.join(process.cwd(), 'public/data/registry/modules.json'),
              path.join(process.cwd(), 'functions/api/_shared/registry/modules.json')
            ];
            let modules = [];
            for (const file of candidates) {
              try {
                const doc = JSON.parse(fs.readFileSync(file, 'utf8'));
                modules = Object.entries(doc.modules || doc)
                  .filter(([name, config]) => {
                    if (name === 'schema_version' || name === 'generated_at' || name === 'modules' || name === 'tiers' || name === 'policies') return false;
                    return config && config.enabled !== false;
                  })
                  .map(([name]) => name);
                if (modules.length > 0) break;
              } catch (_) {}
            }
            if (modules.length === 0) {
              modules = ['market-prices'];
            }
            console.log(JSON.stringify(modules));
          ")
          
          echo "Available modules: $MODULES"
          
          # If manual trigger with specific modules
          INPUT_MODULES='${{ github.event.inputs.modules }}'
          if [ ! -z "$INPUT_MODULES" ] && [ "$INPUT_MODULES" != "all" ]; then
            # Parse comma-separated list
            MODULES=$(echo "$INPUT_MODULES" | jq -R 'split(",") | map(gsub("^\\s+|\\s+$";""))')
          fi
          
          echo "matrix={\"module\":$MODULES}" >> $GITHUB_OUTPUT
          echo "Scraping modules: $MODULES"

  # Scrape modules in parallel (matrix)
  scrape:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      actions: read
    
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false  # Continue even if one module fails
      max-parallel: 5   # Limit parallel jobs to avoid rate limits
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Run provider for ${{ matrix.module }}
        env:
          MODULE: ${{ matrix.module }}
          ARTIFACTS_DIR: ${{ runner.temp }}/artifacts
          EODHD_API_KEY: ${{ secrets.EODHD_API_KEY }}
          TIINGO_API_KEY: ${{ secrets.TIINGO_API_KEY || secrets.TIIANGO_API_KEY }}
          RV_PRICES_FORCE_REAL: '1'
          # API Keys (all available)
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          ALPHAVANTAGE_API_KEY: ${{ secrets.ALPHAVANTAGE_API_KEY }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          TWELVEDATA_API_KEY: ${{ secrets.TWELVEDATA_API_KEY }}
          # Yahoo/Proxy settings
          ALLOW_YAHOO: ${{ vars.ALLOW_YAHOO || '0' }}
          YAHOO_MARKET_URL: ${{ vars.YAHOO_MARKET_URL || '' }}
        run: |
          echo "ðŸ”„ Scraping module: $MODULE"
          
          PROVIDER_SCRIPT=""
          for SUFFIX in "-v3" "-v2" "-v1" ""; do
            CANDIDATE="scripts/providers/${MODULE}${SUFFIX}.mjs"
            if [ -f "$CANDIDATE" ]; then
              PROVIDER_SCRIPT="$CANDIDATE"
              break
            fi
          done
          
          if [ -z "$PROVIDER_SCRIPT" ]; then
            echo "âŒ No provider script found for module: $MODULE"
            exit 1
          fi
          
          echo "âœ… Found provider: $PROVIDER_SCRIPT"
          node "$PROVIDER_SCRIPT"

      - name: Verify artifact structure
        run: |
          MODULE="${{ matrix.module }}"
          ARTIFACT_DIR="${{ runner.temp }}/artifacts/${MODULE}"
          
          echo "Verifying artifact for: $MODULE"
          
          if [ ! -d "$ARTIFACT_DIR" ]; then
            echo "âŒ Artifact directory not created: $ARTIFACT_DIR"
            exit 1
          fi
          
          if [ ! -f "$ARTIFACT_DIR/snapshot.json" ]; then
            echo "âŒ snapshot.json missing"
            exit 1
          fi
          
          if [ ! -f "$ARTIFACT_DIR/module-state.json" ]; then
            echo "âŒ module-state.json missing"
            exit 1
          fi
          
          echo "âœ… Artifact structure valid"
          echo "Files:"
          ls -lh "$ARTIFACT_DIR/"
          
          echo ""
          echo "Snapshot preview:"
          head -n 20 "$ARTIFACT_DIR/snapshot.json"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: module-${{ matrix.module }}
          path: ${{ runner.temp }}/artifacts/${{ matrix.module }}/
          retention-days: 1
          if-no-files-found: error
          compression-level: 9  # Maximum compression

      - name: Summary
        run: |
          MODULE="${{ matrix.module }}"
          STATUS="${{ job.status }}"
          
          echo "## ðŸ“¦ Module: $MODULE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Status: $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact: module-$MODULE" >> $GITHUB_STEP_SUMMARY
          
          if [ "$STATUS" = "success" ]; then
            ARTIFACT_DIR="${{ runner.temp }}/artifacts/${MODULE}"
            
            if [ -f "$ARTIFACT_DIR/snapshot.json" ]; then
              RECORD_COUNT=$(jq -r '.metadata.record_count // .meta.record_count // "unknown"' "$ARTIFACT_DIR/snapshot.json")
              FETCHED_AT=$(jq -r '.metadata.fetched_at // .meta.fetchedAt // "unknown"' "$ARTIFACT_DIR/snapshot.json")
              echo "- Records: $RECORD_COUNT" >> $GITHUB_STEP_SUMMARY
              echo "- Fetched: $FETCHED_AT" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -f "$ARTIFACT_DIR/module-state.json" ]; then
              STATE_STATUS=$(jq -r '.status // "unknown"' "$ARTIFACT_DIR/module-state.json")
              PUBLISHED=$(jq -r '.published // false' "$ARTIFACT_DIR/module-state.json")
              echo "- State: $STATE_STATUS" >> $GITHUB_STEP_SUMMARY
              echo "- Published: $PUBLISHED" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  market-stats-pipeline:
    needs: scrape
    if: ${{ success() }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Download market-prices artifact
        uses: actions/download-artifact@v4
        with:
          name: module-market-prices
          path: ${{ runner.temp }}/artifacts/market-prices

      - name: Build market-stats from artifact
        env:
          ARTIFACTS_DIR: ${{ runner.temp }}/artifacts
          BARS_ARTIFACTS_DIR: ${{ runner.temp }}/artifacts
        run: |
          test -f "${ARTIFACTS_DIR}/market-prices/snapshot.json"
          echo "Building market-stats from downloaded market-prices artifact..."
          node scripts/providers/market-stats-v3.mjs


      - name: "WP16 DEBUG: dump market-prices artifacts"
        env:
          ARTIFACTS_DIR: ${{ runner.temp }}/artifacts
        run: |
          set -euo pipefail
          echo "=== DEBUG: artifacts root ==="
          ls -lah "$ARTIFACTS_DIR" || true
          echo ""
          echo "=== DEBUG: find snapshot.json/module-state.json ==="
          find "$ARTIFACTS_DIR" -maxdepth 4 -type f \( -name "snapshot.json" -o -name "module-state.json" \) -print -exec wc -c {} \; || true
          echo ""
          echo "=== DEBUG: print market-prices snapshot.json (first 120 lines) ==="
          if [ -f "$ARTIFACTS_DIR/market-prices/snapshot.json" ]; then
            sed -n '1,120p' "$ARTIFACTS_DIR/market-prices/snapshot.json"
            echo ""
            echo "=== DEBUG: jq key fields ==="
            jq -r '{
              schema_version: (.schema_version // null),
              meta_source: (.meta.source // null),
              metadata_source: (.metadata.source // null),
              metadata_provider: (.metadata.provider // null),
              record_count: (.metadata.record_count // null),
              data_len: ((.data|type)=="array" and (.data|length) or 0),
              error: (.error // null)
            }' "$ARTIFACTS_DIR/market-prices/snapshot.json"
          else
            echo "MISSING: $ARTIFACTS_DIR/market-prices/snapshot.json"
          fi
      - name: Finalize artifacts (softfail quality-gate)
        id: finalize
        env:
          ARTIFACTS_DIR: ${{ runner.temp }}/artifacts
          RV_FINALIZER_SKIP_INVALID: "1"
        run: |
          set -euo pipefail
          echo "Running finalizer to publish market-prices and market-stats"
          log_file="${RUNNER_TEMP}/v3-scrape-finalize.log"
          if ! node scripts/aggregator/finalize.mjs 2>&1 | tee "$log_file"; then
            if grep -Eq "VALIDATION_FAILED|drop_threshold|SKIP_INVALID" "$log_file"; then
              echo "mode=green-skip" >> "$GITHUB_OUTPUT"
              echo "GREEN-SKIP: quality gate failed; publish skipped, last_good retained." >> "$GITHUB_STEP_SUMMARY"
              exit 0
            fi
            exit 1
          fi
          if grep -Eq "SKIP_INVALID|all artifacts were skipped as invalid" "$log_file"; then
            echo "mode=green-skip" >> "$GITHUB_OUTPUT"
            echo "GREEN-SKIP: invalid artifacts skipped by finalizer; publish held." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "mode=published" >> "$GITHUB_OUTPUT"
          fi

      - name: Summary
        run: |
          echo "## ðŸ” Market Stats Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Built market-prices and market-stats artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Finalizer mode: ${{ steps.finalize.outputs.mode || 'unknown' }}" >> $GITHUB_STEP_SUMMARY

  # Wait for all scrapes to complete, then trigger finalizer
  trigger-finalizer:
    needs: scrape
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## ðŸŽ¯ Scrape Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All scrape jobs have completed." >> $GITHUB_STEP_SUMMARY
          echo "Finalizer will be triggered automatically via workflow_run." >> $GITHUB_STEP_SUMMARY
