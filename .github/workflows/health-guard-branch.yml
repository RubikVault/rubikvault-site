name: Health Guard (Branch)

on:
  pull_request:

env:
  PREVIEW_URL: ${{ vars.PREVIEW_URL || 'https://c13cbfaf.rubikvault-site.pages.dev' }}

jobs:
  health-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Soft check preview health
        run: |
          set -euo pipefail
          if [[ -z "${PREVIEW_URL}" ]]; then
            echo "No PREVIEW_URL configured; skipping health guard."
            exit 0
          fi

          BUSTER=$(date +%s)
          if ! health=$(curl -fsSL -L "${PREVIEW_URL}/api/health-report?_=${BUSTER}"); then
            echo "WARN: unable to fetch health-report from ${PREVIEW_URL}"
            exit 0
          fi
          echo "$health" > health-preview.json

          blocks=$(echo "$health" | jq -r '.summary.blocks // 0')
          okBlocks=$(echo "$health" | jq -r '.summary.okBlocks // 0')
          coreScore=$(echo "$health" | jq -r '.summary.coreHealthScore // empty')
          if [[ -z "$coreScore" ]]; then
            if [[ "$blocks" -gt 0 ]]; then
              coreScore=$(awk -v ok="$okBlocks" -v total="$blocks" 'BEGIN{ if (total==0) print 0; else print (ok/total)*100 }')
            else
              coreScore=0
            fi
          fi
          missingMeta=$(echo "$health" | jq -r '.summary.missingMetaBlocks // 0')

          warn=0
          if ! awk -v score="$coreScore" 'BEGIN{ exit (score>=85)?0:1 }'; then
            echo "WARN: coreHealthScore below threshold (${coreScore})"
            warn=1
          fi
          if [[ "${missingMeta}" -gt 0 ]]; then
            echo "WARN: missingMetaBlocks detected (${missingMeta})"
            warn=1
          fi

          printf 'coreHealthScore=%.2f\nmissingMetaBlocks=%s\n' "$coreScore" "$missingMeta"

          if [[ "$warn" -eq 1 ]]; then
            echo "Soft fail: investigate preview health."
          else
            echo "Preview health within soft thresholds."
          fi
      - name: Upload preview health (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preview-health
          path: health-preview.json
          if-no-files-found: ignore
