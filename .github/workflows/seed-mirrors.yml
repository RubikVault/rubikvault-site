name: Seed Mirrors
# PR-based mirror updates:
# - mirrors are committed to mirrors-auto branch
# - PR is created/updated to main
# - requires secret: RV_GH_PUSH_TOKEN

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: seed-mirrors
  cancel-in-progress: true

jobs:
  seed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Preflight secrets
        env:
          RV_GH_PUSH_TOKEN: ${{ secrets.RV_GH_PUSH_TOKEN }}
        run: |
          if [ -z "$RV_GH_PUSH_TOKEN" ]; then
            echo "::error::Missing secret RV_GH_PUSH_TOKEN (PAT with contents + pull-requests write)."
            exit 1
          fi

      - name: Seed mirrors
        env:
          ALPHAVANTAGE_API_KEY: ${{ secrets.ALPHAVANTAGE_API_KEY }}
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          MARKETAUX_KEY: ${{ secrets.MARKETAUX_KEY }}
          MIN_OK_FEATURES: ${{ secrets.MIN_OK_FEATURES }}
          MAX_FAIL_FEATURES: ${{ secrets.MAX_FAIL_FEATURES }}
          CRITICAL_FEATURES: ${{ secrets.CRITICAL_FEATURES }}
          ALLOW_YAHOO: ${{ secrets.ALLOW_YAHOO }}
          ALLOW_TREASURY: ${{ secrets.ALLOW_TREASURY }}
        run: |
          node scripts/seed-mirrors.mjs | tee /tmp/seed-mirrors.log
          if grep -q '"summary"' /tmp/seed-mirrors.log; then
            grep '"summary"' /tmp/seed-mirrors.log | tail -n 1 > /tmp/seed-summary.json
          else
            echo '{"summary":{"note":"summary_line_missing"}}' > /tmp/seed-summary.json
          fi

      - name: Audit reality snapshot
        run: |
          node scripts/audit/generate-reality.mjs

      - name: Build feature registry
        run: |
          node scripts/audit/build-feature-registry.mjs --mode discover

      - name: Generate stub mirrors
        run: |
          node scripts/audit/generate-stub-mirrors.mjs

      - name: Build mirrors artifacts
        run: |
          node scripts/audit/build-artifacts.mjs

      - name: Audit mirrors (local, informational)
        run: |
          node scripts/audit-site.mjs --mode local --base public --format json --fail-on none > /tmp/audit-report.json
          node scripts/audit-site.mjs --mode local --base public --format github --fail-on none

      - name: Audit summary
        run: |
          if [ -f /tmp/audit-report.json ]; then
            echo "Audit summary:" >> "$GITHUB_STEP_SUMMARY"
            jq -r '
              def countStatus(s): [.blocks[] | select(.status == s)] | length;
              "featureCount=\(.blocks|length) ok=\(countStatus(\"OK\")) warn=\(countStatus(\"WARN\")) error=\(countStatus(\"ERROR\"))"
            ' /tmp/audit-report.json >> "$GITHUB_STEP_SUMMARY" || true
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Top reason codes:" >> "$GITHUB_STEP_SUMMARY"
            jq -r '
              (.summary.byReasonCode // {})
              | to_entries
              | sort_by(-.value, .key)
              | .[0:5]
              | map("\(.key): \(.value)")
              | .[]
            ' /tmp/audit-report.json >> "$GITHUB_STEP_SUMMARY" || true
          fi

      - name: Upload mirrors artifact
        uses: actions/upload-artifact@v4
        with:
          name: mirrors-output
          path: |
            public/mirrors/**
            /tmp/seed-summary.json
            /tmp/audit-report.json
            scripts/audit/REALITY.md
          retention-days: 365

      - name: Commit mirrors to PR branch if changed
        env:
          RV_GH_PUSH_TOKEN: ${{ secrets.RV_GH_PUSH_TOKEN }}
          GH_TOKEN: ${{ secrets.RV_GH_PUSH_TOKEN }}
        run: |
          if ! git status --porcelain | grep -q "public/mirrors/"; then
            echo "No mirror changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -B mirrors-auto
          git add public/mirrors/
          git commit -m "chore: update mirrors"
          git remote set-url origin "https://x-access-token:${RV_GH_PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git push --force-with-lease origin mirrors-auto
          printf "Seed Mirrors summary (%s)\n\n" "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" > /tmp/pr-body.txt
          cat /tmp/seed-summary.json >> /tmp/pr-body.txt
          PR_NUMBER=$(gh pr list --head mirrors-auto --base main --json number --jq '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            gh pr edit "$PR_NUMBER" --title "chore: update mirrors" --body-file /tmp/pr-body.txt
            gh pr comment "$PR_NUMBER" --body-file /tmp/pr-body.txt
          else
            gh pr create --head mirrors-auto --base main --title "chore: update mirrors" --body-file /tmp/pr-body.txt
          fi


      - name: Install dependencies
        run: npm ci
