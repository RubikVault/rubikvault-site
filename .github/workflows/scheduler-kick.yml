name: Scheduler Kick

on:
  schedule:
    - cron: "15 * * * *"
  workflow_dispatch:
    inputs:
      workflows:
        description: "Comma-separated workflow files to dispatch (manual only)"
        required: false
        default: "eod-latest.yml,ops-daily.yml,forecast-daily.yml"

permissions:
  actions: write
  contents: read

concurrency:
  group: scheduler-kick-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  dry-run:
    name: Scheduler Kick Dry-Run (no secrets)
    if: ${{ vars.RV_CI_MODE == 'dry' || vars.RV_PROD_BASE == '' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: npm ci
      - name: Contracts (dry-run)
        run: npm run test:contracts

  kick:
    if: ${{ github.ref == 'refs/heads/main' && vars.RV_CI_MODE != 'dry' }}
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch downstream workflows (GitHub-native, no WAF)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_WORKFLOWS: ${{ github.event.inputs.workflows }}
        run: |
          set -euo pipefail

          if [ -z "${GH_TOKEN:-}" ]; then
            echo "MISSING_SECRET:GITHUB_TOKEN (required for workflow dispatch)" >&2
            exit 1
          fi

          if ! command -v gh >/dev/null 2>&1; then
            echo "gh CLI missing on runner" >&2
            exit 1
          fi

          event_name="${GITHUB_EVENT_NAME:-unknown}"
          hour_utc="$(date -u +%H)"
          weekday_utc="$(date -u +%u)" # 1..7 (Mon..Sun)
          workflows=""

          if [ "$event_name" = "schedule" ]; then
            if [ "$weekday_utc" -gt 5 ]; then
              echo "Weekend schedule: no dispatch (weekday=${weekday_utc})"
              exit 0
            fi
            case "$hour_utc" in
              07) workflows="ops-daily.yml" ;;
              21) workflows="forecast-daily.yml" ;;
              22) workflows="eod-latest.yml" ;;
              *) workflows="" ;;
            esac
            if [ -z "$workflows" ]; then
              echo "No dispatch window configured for hour=${hour_utc} UTC; exiting cleanly."
              exit 0
            fi
          else
            workflows="${INPUT_WORKFLOWS:-eod-latest.yml,ops-daily.yml,forecast-daily.yml}"
          fi

          echo "dispatch_target_raw=${workflows}"
          IFS=',' read -r -a wf_list <<< "$workflows"

          dispatched=0
          for wf in "${wf_list[@]}"; do
            wf="$(echo "$wf" | xargs)"
            if [ -z "$wf" ]; then
              continue
            fi
            if [ "$wf" = "eod-latest.yml" ]; then
              gh workflow run "$wf" --ref main -f universe=nasdaq100
            else
              gh workflow run "$wf" --ref main
            fi
            run_url="$(gh run list --workflow "$wf" --limit 1 --json url,createdAt,headBranch | jq -r '.[0].url // empty')"
            echo "dispatched_workflow=${wf} run=${run_url:-unknown}"
            dispatched=$((dispatched + 1))
            sleep 1
          done

          if [ "$dispatched" -eq 0 ]; then
            echo "No workflows dispatched (empty target list)." >&2
            exit 1
          fi
          echo "dispatch_count=${dispatched}"
