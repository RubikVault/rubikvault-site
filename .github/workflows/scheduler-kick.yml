name: Scheduler Kick

on:
  schedule:
    - cron: "15 * * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dry-run:
    name: Scheduler Kick Dry-Run (no secrets)
    if: ${{ vars.RV_CI_MODE == 'dry' || vars.RV_PROD_BASE == '' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: npm ci
      - name: Contracts (dry-run)
        run: npm run test:contracts

  kick:
    if: ${{ github.ref == 'refs/heads/main' && vars.RV_CI_MODE != 'dry' && vars.RV_PROD_BASE != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger scheduler
        env:
          RV_PROD_BASE: ${{ vars.RV_PROD_BASE }}
          RV_ADMIN_TOKEN: ${{ secrets.RV_ADMIN_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "${RV_PROD_BASE:-}" ]; then
            echo "RV_PROD_BASE is not set (GitHub Actions variable)" >&2
            exit 1
          fi
          if [ -z "${RV_ADMIN_TOKEN:-}" ]; then
            echo "RV_ADMIN_TOKEN is not set" >&2
            exit 1
          fi

          payload='{"job":"eod_stock","mode":"s2","universe":"nasdaq100"}'
          status=$(curl -sS -o /tmp/scheduler.json -w "%{http_code}" \
            -X POST "${RV_PROD_BASE%/}/api/scheduler/run" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${RV_ADMIN_TOKEN}" \
            --data "$payload")

          if [ "$status" -lt 200 ] || [ "$status" -ge 300 ]; then
            echo "Scheduler kick failed (HTTP $status)" >&2
            cat /tmp/scheduler.json >&2 || true
            exit 1
          fi

          jq -e '.ok | type == "boolean"' /tmp/scheduler.json >/dev/null
          jq -e '.meta.status | type == "string"' /tmp/scheduler.json >/dev/null
          jq -e '.meta.data_date | type == "string"' /tmp/scheduler.json >/dev/null

          jq -r '{ok, meta_status:.meta.status, job:(.data.job // null), run_id:(.data.run_id // null)}' /tmp/scheduler.json
