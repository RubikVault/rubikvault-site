name: v3 Finalizer

on:
  workflow_run:
    workflows: 
      - "v3 Pilot - Market Health"
      - "v3 Scrape Template"
    types:
      - completed
  workflow_dispatch:
    inputs:
      artifact_name:
        description: 'Artifact name to finalize (default: all)'
        required: false
        default: ''
      skip_kv_write:
        description: 'Skip KV writes (for testing)'
        required: false
        default: 'false'

jobs:
  finalize:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Single-flight: cancel any in-progress runs
    concurrency:
      group: rv-finalizer
      cancel-in-progress: true
    
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Precheck upstream status
        id: precheck
        run: |
          set -euo pipefail
          skip="false"
          reason="ok"
          if [ "${{ github.event_name }}" = "workflow_run" ] && [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            skip="true"
            reason="upstream_${{ github.event.workflow_run.conclusion }}"
            echo "GREEN-SKIP: upstream workflow conclusion=${{ github.event.workflow_run.conclusion }}; finalizer publish skipped." >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "skip=${skip}" >> "$GITHUB_OUTPUT"
          echo "reason=${reason}" >> "$GITHUB_OUTPUT"

      - name: Download artifacts from v3-pilot-market
        if: steps.precheck.outputs.skip != 'true'
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: v3-pilot-market.yml
          name: module-market-health
          path: artifacts/module-market-health
          if_no_artifact_found: warn
        continue-on-error: true

      - name: Download artifacts from v3-scrape-template
        if: steps.precheck.outputs.skip != 'true'
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: v3-scrape-template.yml
          name_is_regexp: true
          name: module-.*
          path: artifacts/
          if_no_artifact_found: warn
        continue-on-error: true

      - name: Organize artifacts
        if: steps.precheck.outputs.skip != 'true'
        run: |
          set +e  # Disable exit on error for this step
          
          # Reorganize artifacts into expected structure
          mkdir -p artifacts-organized
          
          echo "Checking for downloaded artifacts..."
          if [ ! -d "artifacts" ] || [ -z "$(ls -A artifacts 2>/dev/null)" ]; then
            echo "⚠ No artifacts directory found or directory is empty"
            echo "This is expected if the Pilot workflow hasn't run yet"
            echo "Finalizer will generate empty provider-state.json"
            exit 0  # Success - this is OK, finalizer handles empty state
          fi
          
          echo "Artifacts directory contents:"
          ls -la artifacts/ 2>/dev/null || echo "No artifacts directory"
          
          artifact_count=0
          for dir in artifacts/module-*; do
            # Check if glob matched anything
            if [ ! -e "$dir" ]; then
              echo "No module-* directories found"
              break
            fi
            
            if [ -d "$dir" ]; then
              module_name=$(basename "$dir" | sed 's/module-//')
              echo "Processing module: $module_name"
              mkdir -p "artifacts-organized/$module_name"
              
              # Find and copy snapshot.json and module-state.json
              if find "$dir" -name "snapshot.json" -exec cp {} "artifacts-organized/$module_name/" \; 2>/dev/null; then
                echo "  ✓ Copied snapshot.json"
              else
                echo "  ⚠ snapshot.json not found in $dir"
              fi
              
              if find "$dir" -name "module-state.json" -exec cp {} "artifacts-organized/$module_name/" \; 2>/dev/null; then
                echo "  ✓ Copied module-state.json"
              else
                echo "  ⚠ module-state.json not found in $dir"
              fi
              
              # Verify both files exist
              if [ -f "artifacts-organized/$module_name/snapshot.json" ] && [ -f "artifacts-organized/$module_name/module-state.json" ]; then
                echo "✓ Organized artifact: $module_name"
                artifact_count=$((artifact_count + 1))
              else
                echo "  ⚠ Incomplete artifact for $module_name, removing directory"
                rm -rf "artifacts-organized/$module_name"
              fi
            fi
          done
          
          echo ""
          echo "Artifact organization complete. Found $artifact_count module(s)."
          
          # Verify structure (only if artifacts were found)
          if [ $artifact_count -gt 0 ]; then
            echo "Artifacts organized successfully!"
          else
            echo "No artifacts to organize. Finalizer will generate empty state."
          fi
          
          # Always exit with success - empty artifacts are OK
          exit 0

      - name: Run Finalizer
        if: steps.precheck.outputs.skip != 'true'
        id: run-finalizer
        env:
          ARTIFACTS_DIR: artifacts-organized
          RV_FINALIZER_SKIP_INVALID: "1"
        run: |
          set -euo pipefail
          echo "Running finalizer with ARTIFACTS_DIR=$ARTIFACTS_DIR"
          echo "Current directory: $(pwd)"
          echo "Artifacts directory contents:"
          ls -la $ARTIFACTS_DIR/ 2>&1 || echo "Artifacts dir does not exist or is empty"
          echo ""
          echo "Looking for module directories:"
          find $ARTIFACTS_DIR -type d -mindepth 1 -maxdepth 1 2>&1 || echo "No directories found"
          echo ""
          echo "Looking for JSON files:"
          find $ARTIFACTS_DIR -name "*.json" -type f 2>&1 || echo "No JSON files found"
          echo ""
          echo "=== RUNNING FINALIZER ==="
          log_file="${RUNNER_TEMP}/v3-finalizer.log"
          set +e
          node scripts/aggregator/finalize.mjs 2>&1 | tee "$log_file"
          FINALIZER_EXIT=$?
          set -e
          echo ""
          echo "=== FINALIZER COMPLETED ==="
          echo "Exit code: $FINALIZER_EXIT"
          
          if [ $FINALIZER_EXIT -ne 0 ]; then
            if grep -Eq "VALIDATION_FAILED|drop_threshold|SKIP_INVALID" "$log_file"; then
              echo "mode=green-skip" >> "$GITHUB_OUTPUT"
              echo "GREEN-SKIP: quality gate failed; publish skipped, last_good retained." >> "$GITHUB_STEP_SUMMARY"
              exit 0
            fi
            echo ""
            echo "❌ ERROR: Finalizer failed with exit code $FINALIZER_EXIT"
            echo "Check the logs above for detailed error information"
            exit $FINALIZER_EXIT
          else
            echo "✅ Finalizer completed successfully"
            if grep -Eq "SKIP_INVALID|all artifacts were skipped as invalid" "$log_file"; then
              echo "mode=green-skip" >> "$GITHUB_OUTPUT"
              echo "GREEN-SKIP: invalid artifacts skipped by finalizer; publish held." >> "$GITHUB_STEP_SUMMARY"
            else
              echo "mode=published" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Verify core snapshots
        if: steps.precheck.outputs.skip != 'true'
        run: |
          set -euo pipefail
          missing=false
          for module in universe market-prices market-stats market-score; do
            path="public/data/snapshots/${module}/latest.json"
            if [ ! -s "$path" ]; then
              echo "❌ Missing or empty snapshot: $path"
              missing=true
            else
              echo "✓ Snapshot exists: $path ($(wc -c < "$path") bytes)"
            fi
          done
          if [ "$missing" = true ]; then
            echo "Missing core snapshots, aborting publish"
            exit 1
          fi

      - name: Guard market-prices snapshot
        if: steps.precheck.outputs.skip != 'true'
        id: market-prices-guard
        run: |
          set -euo pipefail
          node scripts/wp16/guard-market-prices.mjs

      - name: Check for changes
        if: steps.precheck.outputs.skip != 'true'
        id: changes
        run: |
          if git diff --quiet public/data; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff --stat public/data
          fi

      - name: Commit and push
        if: steps.precheck.outputs.skip != 'true' && steps.changes.outputs.changed == 'true' && steps.market-prices-guard.outputs.valid == 'true'
        run: |
          git config user.name "RubikVault Bot"
          git config user.email "bot@rubikvault.com"
          
          # Add files only if they exist
          git add public/data/snapshots 2>/dev/null || echo "No snapshot files to add"
          git add public/data/state/modules/*.json 2>/dev/null || echo "No module state files to add"
          git add public/data/manifest.json 2>/dev/null || echo "No manifest to add"
          git add public/data/provider-state.json 2>/dev/null || echo "No provider-state to add"
          
          # Commit only if there are staged changes
          if git diff --cached --quiet; then
            echo "No files staged for commit"
            exit 0
          fi
          
          git commit -m "data: v3.0 publish via finalizer" || exit 0
          
          # Retry push with merge handling
          for i in 1 2 3; do
            if git push origin HEAD:${{ github.ref_name }}; then
              echo "Push succeeded"
              exit 0
            fi
            echo "Push failed (attempt $i), retrying..."
            git fetch origin ${{ github.ref_name }}
            if git merge origin/${{ github.ref_name }} --no-edit || git merge --abort || true; then
              git push origin HEAD:${{ github.ref_name }} || true
            fi
            sleep $((i * 3))
          done

      - name: Summary
        if: always()
        run: |
          echo "## Finalizer v3.0" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Precheck skip: ${{ steps.precheck.outputs.skip }}" >> $GITHUB_STEP_SUMMARY
          echo "- Precheck reason: ${{ steps.precheck.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "- Finalizer mode: ${{ steps.run-finalizer.outputs.mode || 'n/a' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Changes: ${{ steps.changes.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
          if [ -f public/data/manifest.json ]; then
            echo "- Manifest: ✓" >> $GITHUB_STEP_SUMMARY
          fi
