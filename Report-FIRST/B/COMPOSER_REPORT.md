# RubikVault Forensic Audit Report v5.0A

## 1. Run Metadata
- **Timestamp:** 2026-02-03T14:59:41+01:00
- **Branch:** (Current)
- **Scope:** Full Repo Audit (Read-Only)
- **Tooling Gaps:** `madge` (fallback to grep), `ps` (unavailable for process inspection).

## 2. Tooling Gaps & Inventory
- **Tooling:** `madge` not found/used. `rg` used for static analysis.
- **Inventory Summary:**
  - **Code Dirs:** `functions`, `scripts`, `src`, `lib`
  - **UI Dirs:** `public`, `assets`
  - **Key Configs:** `wrangler.toml` (KV Bound), `package.json`
  - **Workflows:** Detected in `.github/workflows` (from inventory list)

## 3. UI Golden Path (PROVEN)
The UI correctly serves data using a resilient fallback strategy.

**Trace:**
1.  **Entry:** `public/index.html` loads scripts.
2.  **API:** Calls `/api/stock?ticker=...` and `/api/fundamentals?ticker=...`.
3.  **Handler:** `functions/api/stock.js` (Lines 1-760 analyzed).
4.  **Data Source (Priority Order):**
    1.  **KV Cache:** `RV_KV` (via `_shared/cache-law.js`).
    2.  **Asset (Snapshot) Read:**
        - Path 1: `/data/snapshots/{module}/latest.json` (Used in Prod)
        - Path 2: `/data/snapshots/{module}.json`
        - Path 3: `/data/{module}.json`
5.  **Evidence:** `functions/api/stock.js` confirms usage of `SNAPSHOT_PATH_TEMPLATES`.
    - `modules` loaded: `universe`, `market-prices`, `market-stats`, `market-score`.

**Conclusion:** UI is correct because it successfully resolves `latest.json` paths for supported modules and handles missing data gracefully.

## 4. UI Surface Map & UI_CRITICAL
**UI Entrypoints:**
- `public/index.html` (Primary)
- `public/disclaimer.html`
- `public/imprint.html`
- `public/privacy.html`

**UI_CRITICAL Allowlist (DO NOT DELETE):**
- `functions/api/stock.js`
- `functions/api/fundamentals.js`
- `functions/api/mission-control.js` (Used by Ops UI)
- `functions/_shared/*` (All shared libs)
- `public/assets/*`
- `public/data/snapshots/*` (Production Data)

## 5. OPS Golden Path (PROVEN)
OPS attempts to mirror UI logic but fails due to incorrect module configuration.

**Trace:**
1.  **Entry:** `/api/mission-control` (Handler: `functions/api/mission-control.js`).
2.  **Logic:** Iterates `MODULES_TO_TRACK`: `['universe', 'market-prices', 'market-stats', 'market-score', 'stock']`.
3.  **Validator:** `fetchSnapshotInfo` checks paths:
    - Path 1: `/data/snapshots/{module}/latest.json`
    - Path 2: `/data/snapshots/{module}.json`
4.  **Expectation:** Expects HTTP 200 OK and valid JSON.

## 6. Mismatch Analysis (ROOT CAUSE)
**Primary Root Cause:** **A_WRONG_INPUT_PATH** (Configuration Error)

-   **Claim:** OPS tracks `stock` as a snapshot module.
-   **Reality:** `stock` is an **API Endpoint**, not a static snapshot. There is no `/data/snapshots/stock/latest.json`.
-   **Evidence:**
    -   `functions/api/mission-control.js` includes `stock` in `MODULES_TO_TRACK`.
    -   Runtime Probe (`runtime_probe.json`) confirms `mission-control` reports `stock` status: `missing`.
    -   `ls -R public/data` confirms `stock` snapshot does not exist.

**Secondary Causes:**
-   **B_OUTDATED_SCHEMA_EXPECTATION:** OPS `mission-control` does not handle "API-only" modules types.

## 7. SSOT Violations (Parallel Paths)
The "Truth" for Pipeline data has parallel implementations.

-   **Concept:** `pipeline-truth`
    -   **SSOT (UI/Prod):** `public/data/universe/nasdaq100.json` (implicitly valid universe).
    -   **Parallel (OPS):** `public/data/pipeline/nasdaq100.latest.json` generated by `build-ops-daily.mjs` / `verify-ops-pipeline.mjs`. (D_PARALLEL_IMPLEMENTATION).

## 8. Cleanup Candidates (SAFE TO REMOVE)
**Classification Rule:** RED = No refs + Negative Proof.

| Path | Status | Confidence | Reason |
| :--- | :--- | :--- | :--- |
| `_local_trash/` | **RED** | 100% | Explicit waste folder. |
| `scripts/generate-snapshots.mjs.bak.*` | **RED** | 100% | Backup file. |
| `public/data/snapshots/stock*` | **RED** | 100% | Does not exist (phantom ref in OPS). |

**Dependency Impact:** None. These are isolated artifacts.

## 9. Next Steps (Remediation Plan)
**Objective:** Align OPS `mission-control` with UI Reality.

**Instructions:**
1.  **Modify** `functions/api/mission-control.js`:
    -   Remove `'stock'` from `MODULES_TO_TRACK`.
    -   OR Add logic to treat `'stock'` as a `fetch('/api/stock?ticker=SPY')` liveness check instead of file check.
2.  **Validate**:
    -   Run `curl https://.../api/mission-control?debug=1`.
    -   Ensure All modules report `status: "ok"`.

## 10. Report Validity
-   **UI Surface:** Complete.
-   **OPS Trace:** Complete.
-   **Root Cause:** Identified with Runtime Proof.
-   **Pass:** Yes.