<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ops â€” RubikVault</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
      background: #0b1220;
      color: #e5e7eb;
    }

    .wrap {
      max-width: 1180px;
      margin: 0 auto;
      padding: 24px;
    }

    h1 {
      margin: 0 0 6px;
      font-size: 28px;
      letter-spacing: -0.02em;
    }

    .sub {
      color: #94a3b8;
      margin-bottom: 18px;
      font-size: 14px;
    }

    .card {
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.7);
      border-radius: 12px;
      padding: 14px;
      overflow: hidden;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    .grid2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .k {
      color: #94a3b8;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .v {
      margin-top: 6px;
      font-size: 22px;
      font-weight: 800;
    }

    .small {
      color: #94a3b8;
      font-size: 12px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin: 12px 0 18px;
    }

    .btn {
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.25);
      color: #e5e7eb;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      font-size: 12px;
      color: #e5e7eb;
    }

    .pill.ok {
      border-color: rgba(52, 211, 153, 0.35);
      color: #a7f3d0;
    }

    .pill.warn {
      border-color: rgba(251, 191, 36, 0.35);
      color: #fde68a;
    }

    .pill.bad {
      border-color: rgba(251, 113, 133, 0.35);
      color: #fecdd3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      text-align: left;
      padding: 10px 8px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
      font-size: 13px;
    }

    th {
      color: #94a3b8;
      font-weight: 700;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    @media (max-width: 860px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .grid2 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="ops-render-status" data-status="boot" data-reason="starting" class="small"
      style="margin-bottom: 10px; color: #94a3b8;">
      Render status: <span id="ops-render-status-text">boot</span>
    </div>

    <h1>Ops</h1>
    <div class="sub">Owner-grade view (static-first, read-only). No auto refresh.</div>

    <div class="controls card">
      <button id="btn-refresh" class="btn">Refresh (LIVE)</button>
      <span class="small">Baseline asOf: <span id="baseline-asof" class="mono">â€”</span></span>
      <span class="small"><span id="live-asof-label">Runtime asOf</span>: <span id="live-asof" class="mono">â€”</span></span>
      <span class="small">Source: <span id="data-source" class="mono">â€”</span></span>
      <span class="small">Served from: <span id="served-from" class="mono">â€”</span></span>
      <span style="flex:1"></span>
      <span class="small" id="last-refresh"></span>
    </div>

    <div id="ops-alert" class="card"
      style="display:none; margin-bottom: 12px; border-color: rgba(251, 191, 36, 0.5); background: rgba(120, 53, 15, 0.18);">
      <div class="k">Warning</div>
      <div class="small" id="ops-alert-text"></div>
    </div>

    <div id="ops-render-error" class="card"
      style="display:none; margin-bottom: 12px; border-color: rgba(248, 113, 113, 0.5); background: rgba(120, 20, 30, 0.18);">
      <div class="k">Render error</div>
      <div class="small" id="ops-render-error-text"></div>
    </div>

    <div id="loading" class="card">No data loaded. Click Refresh (LIVE).</div>

    <div id="main" style="display:none;">
      <div class="card" style="margin-bottom: 12px;">
        <div class="k">Overall status</div>
        <div class="v" id="overall">â€”</div>
        <div class="small" id="overall-reason">â€”</div>
        <div class="small" id="what-to-fix" style="margin-top:6px;"></div>
      </div>

      <div class="card" style="margin-bottom: 12px;">
        <div class="k">Render diagnostics</div>
        <div class="small">Last summary fetch: <span id="ops-last-fetch" class="mono">â€”</span></div>
        <div class="small" style="margin-top: 6px;">Scheduler expected: <span id="ops-scheduler-expected">â€”</span></div>
        <div class="small" id="ops-scheduler-expected-reason" style="margin-top: 4px;">â€”</div>
      </div>

      <div class="grid" style="margin-bottom: 12px;">
        <div class="card">
          <div class="k">Costs today (Workers)</div>
          <div class="v" id="workers-used">â€”</div>
          <div class="small" id="workers-budget">â€”</div>
        </div>
        <div class="card">
          <div class="k">Runtime mode</div>
          <div class="v" id="runtime-mode">â€”</div>
          <div class="small" id="runtime-note">â€”</div>
        </div>
        <div class="card">
          <div class="k">Safety locks</div>
          <div class="v" id="safety-kv-writes">â€”</div>
          <div class="small" id="safety-note">â€”</div>
        </div>
      </div>

      <div class="grid2" style="margin-bottom: 12px;">
        <div class="card">
          <div class="k" style="margin-bottom: 10px;">Provider budgets (monthly)</div>
          <table>
            <thead>
              <tr>
                <th>Provider</th>
                <th>Used</th>
                <th>Limit</th>
                <th>Remaining</th>
                <th>Reset</th>
                <th id="providers-calls-label">Runtime calls today</th>
              </tr>
            </thead>
            <tbody id="providers"></tbody>
          </table>
        </div>
        <div class="card">
          <div class="k" style="margin-bottom: 10px;">MarketPhase pipeline (NASDAQ-100)</div>
          <table>
            <thead>
              <tr>
                <th>Stage</th>
                <th>Count</th>
                <th>Expected</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="pipeline-marketphase"></tbody>
          </table>
          <div id="pipeline-marketphase-note" class="small" style="margin-top: 10px;"></div>

          <div style="margin-top: 14px; padding-top: 12px; border-top: 1px solid rgba(148, 163, 184, 0.15);">
            <div class="k" style="margin-bottom: 10px;">EOD fetch pipeline (NASDAQ-100)</div>
            <table>
              <thead>
                <tr>
                  <th>Stage</th>
                  <th>Count</th>
                  <th>Expected</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="pipeline-eod"></tbody>
            </table>
            <div id="pipeline-eod-note" class="small" style="margin-top: 10px;"></div>
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-bottom: 12px;">
        <div class="card">
          <div class="k" style="margin-bottom: 10px;">Data freshness</div>
          <div class="small" id="freshness-global">â€”</div>
          <div class="small" id="freshness-stale" style="margin-top: 8px;">â€”</div>
          <div class="small" id="freshness-list" style="margin-top: 8px;"></div>
        </div>
        <div class="card" id="scheduler-card" data-testid="scheduler-card">
          <div class="k" style="margin-bottom: 10px;">Scheduler status</div>
          <div class="small" id="scheduler-expected">â€”</div>
          <div class="small" id="scheduler-note" style="margin-top: 8px;">â€”</div>
        </div>
      </div>

      <div class="card" style="margin-bottom: 12px;" id="truth-chain-section" data-testid="truth-chain">
        <div class="k" style="margin-bottom: 10px;">Truth Chain (NASDAQ-100)</div>
        <div id="truth-chain-steps" style="display: flex; flex-direction: column; gap: 6px;"></div>
        <div id="truth-chain-blocker" class="small"
          style="margin-top: 10px; padding: 8px; border-radius: 6px; display: none;"></div>
        <div class="small" style="margin-top: 12px; color: #94a3b8;">
          Artifacts:
          <a href="/data/pipeline/nasdaq100.pipeline-truth.json"
            style="color:#60a5fa; margin-left: 8px;">pipeline-truth.json</a>
          <a href="/data/pipeline/missing.json" style="color:#60a5fa; margin-left: 8px;">missing.json</a>
          <a href="/data/marketphase/missing.json" style="color:#60a5fa; margin-left: 8px;">marketphase missing</a>
        </div>
      </div>

      <details id="ops-raw-json" style="margin-bottom: 12px;">
        <summary>Raw mission-control summary (sanitized)</summary>
        <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
          <button id="ops-raw-copy" class="btn" type="button">Copy JSON</button>
          <span class="small" id="ops-raw-mode">sanitized</span>
        </div>
        <pre id="ops-raw-json-pre"
          style="margin-top: 8px; white-space: pre-wrap; word-break: break-word; background: rgba(15, 23, 42, 0.7); padding: 10px; border-radius: 8px;"></pre>
      </details>

      <div class="small" style="margin-top: 14px;">
        Source: <a href="/api/mission-control/summary" style="color:#60a5fa;">/api/mission-control/summary</a>
        <span class="small" id="asof" style="margin-left:10px;"></span>
      </div>
      <div class="small" style="margin-top: 6px;">
        Static artifacts:
        <a href="/data/pipeline/nasdaq100.latest.json" style="color:#60a5fa; margin-left: 4px;">latest</a>
        <a href="/data/pipeline/nasdaq100.static-ready.json" style="color:#60a5fa; margin-left: 4px;">static-ready</a>
        <a href="/data/pipeline/nasdaq100.pipeline-truth.json"
          style="color:#60a5fa; margin-left: 4px;">pipeline-truth</a>
        <a href="/data/pipeline/missing.json" style="color:#60a5fa; margin-left: 4px;">missing</a>
        <a href="/data/marketphase/missing.json" style="color:#60a5fa; margin-left: 4px;">marketphase missing</a>
      </div>
    </div>
  </div>

  <script>
    function esc(s) {
      return String(s == null ? '' : s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function fmtNum(n) {
      const v = Number(n);
      if (!Number.isFinite(v)) return 'â€”';
      return v.toLocaleString();
    }

    function pill(text, cls) {
      return '<span class="pill ' + cls + '">' + esc(text) + '</span>';
    }

    function pctClass(p) {
      const v = Number(p);
      if (!Number.isFinite(v)) return 'warn';
      if (v >= 90) return 'bad';
      if (v >= 70) return 'warn';
      return 'ok';
    }

    const renderStatusEl = document.getElementById('ops-render-status');
    const renderStatusText = document.getElementById('ops-render-status-text');
    const renderErrorEl = document.getElementById('ops-render-error');
    const renderErrorText = document.getElementById('ops-render-error-text');

    function setRenderStatus(status, reason, asOf) {
      if (renderStatusEl) {
        renderStatusEl.dataset.status = status || 'unknown';
        renderStatusEl.dataset.reason = reason || '';
        if (asOf) renderStatusEl.dataset.asof = asOf;
      }
      if (renderStatusText) {
        renderStatusText.textContent = status || 'unknown';
      }
      if (renderErrorEl && renderErrorText) {
        if (status === 'error') {
          renderErrorEl.style.display = 'block';
          renderErrorText.textContent = reason || 'unknown';
        } else {
          renderErrorEl.style.display = 'none';
          renderErrorText.textContent = '';
        }
      }
    }

    function setManualTs(ts) {
      try {
        localStorage.setItem('rv_ops_last_manual_refresh', ts);
      } catch { }
      const el = document.getElementById('manual-ts');
      if (el) el.textContent = ts;
    }

    function getManualTs() {
      try {
        return localStorage.getItem('rv_ops_last_manual_refresh');
      } catch {
        return null;
      }
    }

    function fmtTracked(value) {
      if (value === null || value === undefined) return 'not tracked';
      if (typeof value === 'number' && !Number.isFinite(value)) return 'not tracked';
      return String(value);
    }

    function pickUniverse(universes, id) {
      if (!Array.isArray(universes) || universes.length === 0) return null;
      const match = universes.find((u) => u && u.id === id);
      return match || universes[0];
    }

    let LAST_PIPELINE_COUNTS = null;

    function setSourceLabel(text) {
      const sourceEl = document.getElementById('data-source');
      if (sourceEl) sourceEl.textContent = text;
    }

    function showAlert(html) {
      const alertEl = document.getElementById('ops-alert');
      const textEl = document.getElementById('ops-alert-text');
      if (!alertEl || !textEl) return;
      textEl.innerHTML = html;
      alertEl.style.display = 'block';
    }

    function clearAlert() {
      const alertEl = document.getElementById('ops-alert');
      const textEl = document.getElementById('ops-alert-text');
      if (textEl) textEl.textContent = '';
      if (alertEl) alertEl.style.display = 'none';
    }

    function computeStatusFromCounts(counts) {
      const expected = Number(counts?.expected);
      const staticReady = Number(counts?.static_ready);
      if (!Number.isFinite(expected) || expected <= 0) return 'UNKNOWN';
      if (!Number.isFinite(staticReady)) return 'UNKNOWN';
      if (staticReady >= expected) return 'OK';
      if (staticReady > 0) return 'WARN';
      return 'MISSING';
    }

    function normalizePipelineLatestDoc(doc) {
      if (!doc || typeof doc !== 'object') return null;
      const counts = doc.counts && typeof doc.counts === 'object' ? doc.counts : {};
      const toNumOrNull = (value) => {
        const n = Number(value);
        return Number.isFinite(n) ? n : null;
      };
      return {
        generated_at: typeof doc.generated_at === 'string' ? doc.generated_at : null,
        source: '/data/pipeline/nasdaq100.latest.json',
        counts: {
          expected: toNumOrNull(counts.expected),
          fetched: toNumOrNull(counts.fetched),
          validated: toNumOrNull(counts.validated),
          computed: toNumOrNull(counts.computed),
          static_ready: toNumOrNull(counts.static_ready)
        }
      };
    }

    function extractCountsFromSummary(summary, universeId) {
      const universe = pickUniverse(summary?.universes, universeId);
      if (!universe) return null;
      return {
        expected: Number(universe.expected || 0),
        fetched: Number(universe.fetched || 0),
        validated: Number(universe.validated || 0),
        computed: Number(universe.computed || 0),
        static_ready: Number(universe.static_ready || 0)
      };
    }

    function overlaySummaryWithPipeline(summary, pipelineCounts) {
      if (!summary || !pipelineCounts) return summary;
      const universe = pickUniverse(summary.universes, 'nasdaq100');
      if (!universe) return summary;
      universe.expected = pipelineCounts.expected;
      universe.fetched = pipelineCounts.fetched;
      universe.validated = pipelineCounts.validated;
      universe.computed = pipelineCounts.computed;
      universe.static_ready = pipelineCounts.static_ready;
      universe.status = computeStatusFromCounts(pipelineCounts);
      summary.overall = summary.overall || {};
      summary.overall.status = universe.status;
      return summary;
    }

    function renderSummary(summary) {
      const loading = document.getElementById('loading');
      const main = document.getElementById('main');

      const baselineAsOfEl = document.getElementById('baseline-asof');
      if (baselineAsOfEl) baselineAsOfEl.textContent = summary?.ops_daily?.generated_at || 'â€”';
      const liveLabelEl = document.getElementById('live-asof-label');
      const liveAsOfEl = document.getElementById('live-asof');
      const servedFrom = summary?.served_from || null;
      if (liveLabelEl) {
        liveLabelEl.textContent = servedFrom === 'RUNTIME' ? 'Runtime asOf' : 'Snapshot asOf';
      }
      if (liveAsOfEl) liveAsOfEl.textContent = summary?.runtime_asof || summary?.generated_at || 'â€”';

      const overallStatus = summary?.overall?.status || 'UNKNOWN';
      const overallReasons = Array.isArray(summary?.overall?.reasons) ? summary.overall.reasons : [];
      const overallLabel = overallStatus === 'OK' ? 'OK âœ…' : (overallStatus === 'WARN' ? 'WARN ðŸŸ ' : 'RISK ðŸ”´');
      document.getElementById('overall').textContent = overallLabel;
      document.getElementById('overall-reason').textContent = overallReasons.length ? overallReasons.join(' â€¢ ') : 'OK';
      const fixHint = overallReasons.find((r) => r.startsWith('PIPELINE_STATIC_READY'))
        ? 'Check MarketPhase computed/static-ready coverage and KV availability.'
        : overallReasons.find((r) => r.startsWith('SNAPSHOT_STALE'))
          ? 'Check snapshot freshness and scheduler.'
          : overallReasons.length ? 'Review pipeline consistency.' : '';
      document.getElementById('what-to-fix').textContent = fixHint;

      const workersToday = summary?.costs?.workers?.requests_today ?? null;
      const workersLast24h = summary?.costs?.workers?.requests_last_24h ?? null;
      document.getElementById('workers-used').textContent = workersToday == null ? 'not tracked' : fmtNum(workersToday);
      document.getElementById('workers-budget').textContent = workersLast24h == null ? 'not tracked' : `Last 24h: ${fmtNum(workersLast24h)}`;

      const runtime = summary?.runtime || {};
      const runtimeMode = runtime?.isPreview
        ? 'PREVIEW'
        : runtime?.isProduction
          ? 'PROD'
          : 'STATIC';
      document.getElementById('runtime-mode').textContent = runtimeMode;
      document.getElementById('runtime-note').textContent = runtime?.isPreview
        ? 'Preview/Static environment (cron not expected).'
        : runtime?.isProduction
          ? 'Production runtime.'
          : 'Static summary artifact (no runtime auth).';
      const callsHeader = document.getElementById('providers-calls-label');
      if (callsHeader) {
        callsHeader.textContent = runtime?.isProduction ? 'Runtime calls today' : 'Runtime calls today (static)';
      }

      const lastFetchEl = document.getElementById('ops-last-fetch');
      if (lastFetchEl) lastFetchEl.textContent = summary?.generated_at || summary?.asof || 'â€”';
      const schedulerExpectedEl = document.getElementById('ops-scheduler-expected');
      if (schedulerExpectedEl) schedulerExpectedEl.textContent =
        runtime?.schedulerExpected === true ? 'YES' : runtime?.schedulerExpected === false ? 'NO' : 'UNKNOWN';
      const schedulerExpectedReasonEl = document.getElementById('ops-scheduler-expected-reason');
      if (schedulerExpectedReasonEl) schedulerExpectedReasonEl.textContent = runtime?.schedulerExpectedReason || 'â€”';

      const safetyKvWrites = summary?.safety?.kv_writes_today ?? null;
      document.getElementById('safety-kv-writes').textContent = safetyKvWrites == null ? 'not tracked' : fmtNum(safetyKvWrites);
      document.getElementById('safety-note').textContent = summary?.safety?.note || 'Static-only view.';

      const providers = summary?.providers && typeof summary.providers === 'object'
        ? Object.entries(summary.providers)
        : [];
      document.getElementById('providers').innerHTML = providers.length
        ? providers.sort(([a], [b]) => a.localeCompare(b)).map(([name, entry]) => {
          const budget = entry?.budget || null;
          const used = budget?.usedMonth ?? null;
          const lim = budget?.limitMonth ?? null;
          const rem = budget?.remainingMonth ?? null;
          const remPct = budget?.remainingPct ?? null;
          const callsToday = budget?.runtimeCallsToday ?? null;
          const status = remPct == null ? 'warn' : pctClass(100 - Number(remPct));
          const remText = remPct == null
            ? 'not tracked'
            : (pill(String(remPct) + '%', status) + ' <span class="small">' + esc(rem) + '</span>');
          return '<tr>' +
            '<td>' + esc(name) + '</td>' +
            '<td>' + esc(fmtTracked(used)) + '</td>' +
            '<td>' + esc(fmtTracked(lim)) + '</td>' +
            '<td>' + remText + '</td>' +
            '<td class="small">' + esc(budget?.resetDate || 'â€”') + '</td>' +
            '<td>' + esc(fmtTracked(callsToday)) + '</td>' +
            '</tr>';
        }).join('')
        : '<tr><td colspan="6" class="small">No provider budgets</td></tr>';

      const universe = pickUniverse(summary?.universes, 'nasdaq100');
      const latestCounts = summary?.pipeline_latest?.counts || {};
      const expected = Number.isFinite(Number(latestCounts?.expected))
        ? Number(latestCounts.expected)
        : (Number.isFinite(Number(universe?.expected)) ? Number(universe.expected) : null);
      const fetched = Number.isFinite(Number(latestCounts?.fetched))
        ? Number(latestCounts.fetched)
        : (Number.isFinite(Number(universe?.fetched)) ? Number(universe.fetched) : null);
      const validated = Number.isFinite(Number(latestCounts?.validated))
        ? Number(latestCounts.validated)
        : (Number.isFinite(Number(universe?.validated)) ? Number(universe.validated) : null);
      const computed = Number.isFinite(Number(latestCounts?.computed))
        ? Number(latestCounts.computed)
        : (Number.isFinite(Number(universe?.computed)) ? Number(universe.computed) : null);
      const staticReady = Number.isFinite(Number(latestCounts?.static_ready))
        ? Number(latestCounts.static_ready)
        : (Number.isFinite(Number(universe?.static_ready)) ? Number(universe.static_ready) : null);
      const missingList = Array.isArray(universe?.missing) ? universe.missing : [];

      const stageRow = (label, value, expectedValue) => {
        const hasExpected = Number.isFinite(expectedValue) && expectedValue > 0;
        const hasValue = Number.isFinite(value);
        let cls = 'warn';
        let statusLabel = 'UNKNOWN';
        if (hasExpected && hasValue) {
          if (value >= expectedValue) {
            cls = 'ok';
            statusLabel = 'OK';
          } else if (value > 0) {
            cls = 'warn';
            statusLabel = 'WARN';
          } else {
            cls = 'bad';
            statusLabel = 'MISSING';
          }
        }
        return '<tr>' +
          '<td>' + esc(label) + '</td>' +
          '<td>' + esc(hasValue ? String(value) : 'â€”') + '</td>' +
          '<td>' + esc(hasExpected ? String(expectedValue) : 'â€”') + '</td>' +
          '<td>' + pill(statusLabel, cls) + '</td>' +
          '</tr>';
      };

      document.getElementById('pipeline-marketphase').innerHTML =
        stageRow('Fetched', fetched, expected) +
        stageRow('Validated', validated, expected) +
        stageRow('Computed', computed, expected) +
        stageRow('Static-ready', staticReady, expected);

      const pipelineStatus = computeStatusFromCounts({ expected, static_ready: staticReady });
      const pipelineSource = summary?.pipeline_latest?.source || '/data/pipeline/nasdaq100.latest.json';
      document.getElementById('pipeline-marketphase-note').textContent = universe
        ? `Status: ${pipelineStatus} â€¢ Missing: ${missingList.length} â€¢ Source: ${pipelineSource}`
        : 'Status: UNKNOWN';

      const eodLatest = summary?.pipeline_latest || null;
      const eodCounts = eodLatest?.counts || {};
      const eodExpected = Number.isFinite(Number(eodCounts.expected)) ? Number(eodCounts.expected) : null;
      const eodFetched = Number.isFinite(Number(eodCounts.fetched)) ? Number(eodCounts.fetched) : null;
      const eodValidated = Number.isFinite(Number(eodCounts.validated)) ? Number(eodCounts.validated) : null;

      document.getElementById('pipeline-eod').innerHTML =
        stageRow('Fetched (EOD)', eodFetched, eodExpected) +
        stageRow('Validated (EOD)', eodValidated, eodExpected);

      document.getElementById('pipeline-eod-note').textContent = eodLatest
        ? `Source: ${eodLatest.source || '/data/pipeline/nasdaq100.latest.json'} â€¢ asOf: ${eodLatest.generated_at || 'â€”'}`
        : 'EOD pipeline latest not available';

      const expectedTradingDay = summary?.overall?.expected_trading_day || null;
      const staleSymbols = summary?.overall?.stale_symbols_count ?? null;
      document.getElementById('freshness-global').textContent = expectedTradingDay
        ? `Expected trading day: ${expectedTradingDay}`
        : 'Freshness: not tracked';
      document.getElementById('freshness-stale').textContent = staleSymbols == null
        ? 'Stale symbols: not tracked'
        : `Stale symbols: ${staleSymbols}`;
      document.getElementById('freshness-list').textContent = '';

      document.getElementById('asof').textContent = '';

      loading.style.display = 'none';
      main.style.display = 'block';
    }

    function redactKeys(value) {
      const redaction = '[REDACTED]';
      const deny = /apiKey|token|secret|authorization|headers/i;
      if (Array.isArray(value)) {
        return value.map((item) => redactKeys(item));
      }
      if (value && typeof value === 'object') {
        const out = {};
        for (const [key, val] of Object.entries(value)) {
          if (deny.test(key)) {
            out[key] = redaction;
          } else {
            out[key] = redactKeys(val);
          }
        }
        return out;
      }
      return value;
    }

    function updateRawJson(payload, allowFull) {
      const pre = document.getElementById('ops-raw-json-pre');
      const modeEl = document.getElementById('ops-raw-mode');
      const details = document.getElementById('ops-raw-json');
      if (!pre || !payload) return;
      const redacted = redactKeys(payload);
      const output = allowFull ? redacted : redacted;
      pre.textContent = JSON.stringify(output, null, 2);
      if (modeEl) modeEl.textContent = allowFull ? 'sanitized (debug)' : 'sanitized';
      if (details && allowFull) details.open = true;
    }

    function setupCopyJson() {
      const btn = document.getElementById('ops-raw-copy');
      const pre = document.getElementById('ops-raw-json-pre');
      if (!btn || !pre) return;
      btn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(pre.textContent || '');
          btn.textContent = 'Copied';
          setTimeout(() => {
            btn.textContent = 'Copy JSON';
          }, 1200);
        } catch {
          btn.textContent = 'Copy failed';
          setTimeout(() => {
            btn.textContent = 'Copy JSON';
          }, 1200);
        }
      });
    }

    function buildSummaryFromLegacy(payload, pipelineCountsOverride) {
      const baseline = payload?.data?.opsBaseline?.baseline || null;
      if (!baseline || typeof baseline !== 'object') {
        return null;
      }

      const pipeline = baseline.pipeline || {};
      const toNumOrNull = (value) => {
        const n = Number(value);
        return Number.isFinite(n) ? n : null;
      };

      // Prefer pipelineLatest from summary if available, as 'baseline.pipeline' may be legacy/null
      const plCounts = payload?.data?.opsBaseline?.pipelineLatest?.counts || {};
      const expected = toNumOrNull(pipelineCountsOverride?.expected ?? plCounts.expected ?? pipeline.expected ?? baseline.expectedUniverse);

      const fetched = toNumOrNull(pipelineCountsOverride?.fetched ?? plCounts.fetched ?? pipeline.fetched);
      const validated = toNumOrNull(pipelineCountsOverride?.validated ?? plCounts.validated ?? pipeline.validatedStored);
      const computed = toNumOrNull(pipelineCountsOverride?.computed ?? plCounts.computed ?? pipeline.computed);
      const staticReady = toNumOrNull(pipelineCountsOverride?.static_ready ?? plCounts.static_ready ?? pipeline.staticReady);

      const status = computeStatusFromCounts({
        expected,
        fetched,
        validated,
        computed,
        static_ready: staticReady
      });

      const providers = Array.isArray(baseline.providers)
        ? baseline.providers.reduce((acc, entry) => {
          const name = String(entry?.name || '').trim();
          if (!name) return acc;
          acc[name] = {
            configured: true,
            mode: 'unknown',
            note: null,
            budget: {
              usedMonth: entry?.usedMonth ?? null,
              limitMonth: entry?.limitMonth ?? null,
              remainingMonth: entry?.remainingMonth ?? null,
              remainingPct: entry?.remainingPct ?? null,
              resetDate: entry?.resetDate ?? null,
              runtimeCallsToday: entry?.runtimeCallsToday ?? null
            }
          };
          return acc;
        }, {})
        : {};

      const freshness = baseline.freshness || {};
      const staleCount = Number.isFinite(Number(freshness.staleCount)) ? Number(freshness.staleCount) : null;
      const expectedTradingDay = typeof freshness.expectedTradingDay === 'string' ? freshness.expectedTradingDay : null;

      const overall = payload?.data?.opsBaseline?.overall || {};
      const verdict = status === 'OK' ? 'OK' : (status === 'WARN' ? 'WARN' : (overall.verdict === 'HEALTHY' ? 'OK' : (overall.verdict || 'RISK')));
      const reasons = overall.reason ? [String(overall.reason)] : [];

      // Extract runtime and truthChain for new UI elements
      const runtime = payload?.data?.opsBaseline?.runtime || {};
      const truthChain = payload?.data?.opsBaseline?.truthChain || {};
      const pipelineLatest = payload?.data?.opsBaseline?.pipelineLatest || payload?.data?.opsComputed?.pipelineLatest || null;

      const summary = {
        schema_version: 'ops.summary.v1',
        generated_at: payload?.meta?.asOf || payload?.data?.asOf || null,
        asof: payload?.meta?.baselineAsOf || payload?.data?.asOf || null,
        runtime_asof: payload?.meta?.asOf || payload?.data?.asOf || null,
        served_from: payload?.metadata?.served_from || null,
        overall: {
          status: verdict,
          reasons,
          stale_universes: [],
          stale_symbols_count: staleCount == null ? 0 : staleCount,
          expected_trading_day: expectedTradingDay
        },
        universes: [
          {
            id: 'nasdaq100',
            generated_at: payload?.meta?.baselineAsOf || payload?.data?.asOf || null,
            asof: payload?.meta?.baselineAsOf || payload?.data?.asOf || null,
            expected,
            fetched,
            validated,
            computed,
            static_ready: staticReady,
            missing: Array.isArray(pipeline.missing) ? pipeline.missing : [],
            status,
            refs: {
              pipeline: '/data/pipeline/nasdaq100.latest.json',
              manifest: '/data/eod/manifest.latest.json',
              batch0: '/data/eod/batches/eod.latest.000.json'
            },
            providers_used: Object.keys(providers)
          }
        ],
        providers,
        pipeline_latest: pipelineLatest,
        ops_daily: {
          generated_at: payload?.meta?.baselineAsOf || null,
          ref: '/data/ops-daily.json'
        },
        costs: {
          workers: {
            requests_today: payload?.data?.opsLive?.cloudflare?.requestsToday ?? null,
            requests_last_24h: payload?.data?.opsLive?.cloudflare?.requestsLast24h ?? null
          }
        },
        safety: {
          kv_writes_today: baseline?.safety?.kvWritesToday ?? null,
          note: 'Static-only view.'
        },
        runtime,
        truthChain
      };

      return summary;
    }

    function renderTruthChain(truthDoc) {
      const stepsEl = document.getElementById('truth-chain-steps');
      const blockerEl = document.getElementById('truth-chain-blocker');
      if (!stepsEl || !blockerEl) return;

      if (!truthDoc || !Array.isArray(truthDoc.steps)) {
        stepsEl.innerHTML = '<div class="small">Truth chain data not available</div>';
        blockerEl.style.display = 'none';
        return;
      }

      const firstBlocker = truthDoc?.first_blocker_id || truthDoc?.first_blocker?.id || null;
      stepsEl.dataset.firstBlocker = firstBlocker || '';

      const statusIcon = (s) => {
        if (s === 'OK') return 'âœ…';
        if (s === 'WARN') return 'âš ï¸';
        if (s === 'FAIL') return 'âŒ';
        return 'â“';
      };

      stepsEl.innerHTML = truthDoc.steps.map(step => {
        const isBlocker = step.id === firstBlocker;
        const borderStyle = isBlocker ? 'border: 1px solid rgba(251, 113, 133, 0.5); background: rgba(120, 20, 30, 0.15);' : 'border: 1px solid rgba(148, 163, 184, 0.15);';

        const detailText = typeof step.detail === 'string'
          ? step.detail
          : (typeof step.details === 'string' ? step.details : '');
        let evidenceStr = '';
        if (step.evidence && typeof step.evidence === 'object') {
          evidenceStr = Object.entries(step.evidence)
            .map(([k, v]) => `${k}: ${v === null ? 'â€”' : v}`)
            .join(', ');
        } else if (typeof step.evidence === 'string') {
          evidenceStr = step.evidence;
        } else if (!detailText) {
          evidenceStr = '';
        }

        return `<div class="truth-step" data-step-id="${esc(step.id)}" data-step-status="${esc(step.status || 'UNKNOWN')}" style="padding: 8px 10px; border-radius: 6px; ${borderStyle} margin-bottom: 8px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 16px;">${statusIcon(step.status)}</span>
            <span style="font-weight: 600; font-size: 13px;">${esc(step.id)}</span>
            <span style="flex: 1; font-size: 13px;">${esc(step.title)}</span>
            ${isBlocker ? '<span class="pill bad">BLOCKER</span>' : ''}
          </div>
          ${evidenceStr ? `<div class="small" style="margin-top: 4px; color: #94a3b8;">${esc(evidenceStr)}</div>` : ''}
          ${detailText ? `<div class="small" style="margin-top: 2px; color: #fecdd3;">${esc(detailText)}</div>` : ''}
        </div>`;
      }).join('');

      if (firstBlocker) {
        const blockerStep = truthDoc.steps.find(s => s.id === firstBlocker);
        blockerEl.style.display = 'block';
        blockerEl.style.background = 'rgba(120, 20, 30, 0.18)';
        blockerEl.style.borderColor = 'rgba(251, 113, 133, 0.35)';
        blockerEl.innerHTML = `<strong>First blocker:</strong> ${esc(firstBlocker)} â€” ${esc(blockerStep?.title || '')}`;
      } else {
        blockerEl.style.display = 'none';
      }
    }

    function renderSchedulerStatus(runtime) {
      const expectedEl = document.getElementById('scheduler-expected');
      const noteEl = document.getElementById('scheduler-note');
      if (!expectedEl || !noteEl) return;

      const expected = runtime?.schedulerExpected;
      const reason = runtime?.schedulerExpectedReason || '';
      const hostname = runtime?.hostname || '';

      if (expected === true) {
        expectedEl.innerHTML = '<span class="pill ok">Scheduler expected: YES</span>';
        noteEl.textContent = reason || 'Production environment';
      } else if (expected === false) {
        expectedEl.innerHTML = '<span class="pill warn">Scheduler expected: NO</span>';
        noteEl.textContent = reason || 'Preview/Static mode';
      } else {
        expectedEl.textContent = 'Scheduler expected: UNKNOWN';
        noteEl.textContent = `Runtime: ${hostname || 'unknown'}`;
      }
    }

    async function refreshSummary(options = {}) {
      const statusEl = document.getElementById('loading');
      const last = document.getElementById('last-refresh');
      if (last) last.textContent = `Last action: ${new Date().toLocaleString()}`;
      const t = Date.now();
      const debugEnabled = new URLSearchParams(window.location.search).get('debug') === '1';
      const summaryUrl = `/api/mission-control/summary${debugEnabled ? '?debug=1' : ''}${debugEnabled ? '&' : '?'}t=${t}`;

      try {
        setRenderStatus('boot', 'fetching');
        const [summaryRes, truthRes, latestRes] = await Promise.all([
          fetch(summaryUrl, { cache: 'no-store' }),
          fetch('/data/pipeline/nasdaq100.pipeline-truth.json', { cache: 'no-store' }),
          fetch('/data/pipeline/nasdaq100.latest.json', { cache: 'no-store' })
        ]);

        if (!summaryRes.ok) {
          if (statusEl) statusEl.textContent = `Failed to load summary (HTTP ${summaryRes.status}).`;
          setRenderStatus('error', 'fetch_failed');
          return;
        }

        const payload = await summaryRes.json();
        const truthDoc = truthRes.ok ? await truthRes.json() : null;
        const latestDoc = latestRes.ok ? await latestRes.json() : null;
        const latestNormalized = normalizePipelineLatestDoc(latestDoc);

        if (latestNormalized) {
          payload.data = payload.data || {};
          payload.data.opsBaseline = payload.data.opsBaseline || {};
          const existingLatest = payload?.data?.opsBaseline?.pipelineLatest || {};
          const mergedCounts = {
            expected: Number.isFinite(Number(existingLatest?.counts?.expected)) ? existingLatest.counts.expected : latestNormalized.counts.expected,
            fetched: Number.isFinite(Number(existingLatest?.counts?.fetched)) ? existingLatest.counts.fetched : latestNormalized.counts.fetched,
            validated: Number.isFinite(Number(existingLatest?.counts?.validated)) ? existingLatest.counts.validated : latestNormalized.counts.validated,
            computed: Number.isFinite(Number(existingLatest?.counts?.computed)) ? existingLatest.counts.computed : latestNormalized.counts.computed,
            static_ready: Number.isFinite(Number(existingLatest?.counts?.static_ready)) ? existingLatest.counts.static_ready : latestNormalized.counts.static_ready
          };
          payload.data.opsBaseline.pipelineLatest = {
            ...latestNormalized,
            ...existingLatest,
            counts: mergedCounts
          };
        }

        const displaySummary = buildSummaryFromLegacy(payload, null);
        clearAlert();

        const servedFromEl = document.getElementById('served-from');
        if (servedFromEl) servedFromEl.textContent = payload?.metadata?.served_from || 'â€”';

        if (!displaySummary) {
          if (statusEl) statusEl.textContent = 'Summary unavailable (legacy or missing).';
          setRenderStatus('error', 'json_invalid');
          return;
        }

        setSourceLabel(options.sourceLabel || 'static');
        renderSummary(displaySummary);
        renderTruthChain(truthDoc);
        renderSchedulerStatus(displaySummary?.runtime);
        updateRawJson(payload, debugEnabled);
        setRenderStatus('ok', 'rendered', payload?.meta?.asOf || payload?.metadata?.fetched_at || null);

        if (options.triggerLive) {
          attemptLiveRefresh({ force: options.forceLive });
        }
      } catch (err) {
        if (statusEl) statusEl.textContent = 'Failed to load summary.';
        setRenderStatus('error', 'json_invalid');
      }
    }

    function getOpsKeyFromUrl() {
      try {
        const params = new URLSearchParams(window.location.search);
        return params.get('ops_key') || params.get('opsKey') || null;
      } catch {
        return null;
      }
    }

    function getOpsKeyFromSession() {
      try {
        return sessionStorage.getItem('rv_ops_key');
      } catch {
        return null;
      }
    }

    function setOpsKey(key) {
      try {
        sessionStorage.setItem('rv_ops_key', key);
      } catch { }
    }

    async function refreshLiveWithKey(key) {
      try {
        const [res, truthRes, latestRes] = await Promise.all([
          fetch('/api/mission-control/summary?live=1', {
            cache: 'no-store',
            headers: {
              'X-OPS-KEY': key
            }
          }),
          fetch('/data/pipeline/nasdaq100.pipeline-truth.json', { cache: 'no-store' }),
          fetch('/data/pipeline/nasdaq100.latest.json', { cache: 'no-store' })
        ]);
        if (!res.ok) {
          setSourceLabel('live locked');
          return;
        }
        const payload = await res.json();
        const truthDoc = truthRes.ok ? await truthRes.json() : null;
        const latestDoc = latestRes.ok ? await latestRes.json() : null;
        const latestNormalized = normalizePipelineLatestDoc(latestDoc);
        if (latestNormalized) {
          payload.data = payload.data || {};
          payload.data.opsBaseline = payload.data.opsBaseline || {};
          const existingLatest = payload?.data?.opsBaseline?.pipelineLatest || {};
          const mergedCounts = {
            expected: Number.isFinite(Number(existingLatest?.counts?.expected)) ? existingLatest.counts.expected : latestNormalized.counts.expected,
            fetched: Number.isFinite(Number(existingLatest?.counts?.fetched)) ? existingLatest.counts.fetched : latestNormalized.counts.fetched,
            validated: Number.isFinite(Number(existingLatest?.counts?.validated)) ? existingLatest.counts.validated : latestNormalized.counts.validated,
            computed: Number.isFinite(Number(existingLatest?.counts?.computed)) ? existingLatest.counts.computed : latestNormalized.counts.computed,
            static_ready: Number.isFinite(Number(existingLatest?.counts?.static_ready)) ? existingLatest.counts.static_ready : latestNormalized.counts.static_ready
          };
          payload.data.opsBaseline.pipelineLatest = {
            ...latestNormalized,
            ...existingLatest,
            counts: mergedCounts
          };
        }
        const summary = buildSummaryFromLegacy(payload, LAST_PIPELINE_COUNTS);
        if (!summary) return;
        setSourceLabel('live');
        const liveAsOfEl = document.getElementById('live-asof');
        if (liveAsOfEl) liveAsOfEl.textContent = payload?.meta?.asOf || payload?.data?.asOf || 'â€”';
        const servedFromEl = document.getElementById('served-from');
        if (servedFromEl) servedFromEl.textContent = payload?.metadata?.served_from || 'â€”';
        renderSummary(summary);
        renderTruthChain(truthDoc);
        renderSchedulerStatus(summary?.runtime);
        const debugEnabled = new URLSearchParams(window.location.search).get('debug') === '1';
        updateRawJson(payload, debugEnabled);
        setRenderStatus('ok', 'rendered', payload?.meta?.asOf || payload?.metadata?.fetched_at || null);
      } catch {
        setSourceLabel('live locked');
      }
    }

    function attemptLiveRefresh({ force = false } = {}) {
      try {
        if (!force) {
          const already = sessionStorage.getItem('ops_auto_live_once');
          if (already === '1') return;
          sessionStorage.setItem('ops_auto_live_once', '1');
        }
      } catch { }

      const urlKey = getOpsKeyFromUrl();
      const sessionKey = getOpsKeyFromSession();
      const key = sessionKey || urlKey;
      if (urlKey && !sessionKey) {
        setOpsKey(urlKey);
      }
      if (!key) {
        setSourceLabel('static (no key)');
        return;
      }
      setTimeout(() => {
        refreshLiveWithKey(key);
      }, 400);
    }

    setupCopyJson();
    document.getElementById('btn-refresh').addEventListener('click', async () => {
      const now = new Date().toLocaleString();
      setManualTs(now);
      refreshSummary({ sourceLabel: 'static', triggerLive: true, forceLive: true });
    });

    const previous = getManualTs();
    if (previous) {
      const el = document.getElementById('manual-ts');
      if (el) el.textContent = previous;
    }

    const baselineAsOfEl = document.getElementById('baseline-asof');
    if (baselineAsOfEl) baselineAsOfEl.textContent = 'â€”';

    const autoRefreshOnce = () => {
      if (!window.__opsAutoRefreshed) {
        window.__opsAutoRefreshed = true;
        refreshSummary({ sourceLabel: 'static (auto)', triggerLive: true, forceLive: false });
      }
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', autoRefreshOnce);
    } else {
      autoRefreshOnce();
    }
  </script>
</body>

</html>
