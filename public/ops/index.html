<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ops â€” RubikVault</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
      background: #0b1220;
      color: #e5e7eb;
    }
    .wrap { max-width: 1180px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 6px; font-size: 28px; letter-spacing: -0.02em; }
    .sub { color: #94a3b8; margin-bottom: 18px; font-size: 14px; }
    .card { border: 1px solid rgba(148, 163, 184, 0.25); background: rgba(15, 23, 42, 0.7); border-radius: 12px; padding: 14px; overflow: hidden; }
    .grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; }
    .grid2 { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    .k { color: #94a3b8; font-size: 12px; text-transform: uppercase; letter-spacing: 0.06em; }
    .v { margin-top: 6px; font-size: 22px; font-weight: 800; }
    .small { color: #94a3b8; font-size: 12px; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin: 12px 0 18px; }
    .btn {
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(148,163,184,0.25);
      color: #e5e7eb;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(148,163,184,0.25); font-size: 12px; color: #e5e7eb; }
    .pill.ok { border-color: rgba(52, 211, 153, 0.35); color: #a7f3d0; }
    .pill.warn { border-color: rgba(251, 191, 36, 0.35); color: #fde68a; }
    .pill.bad { border-color: rgba(251, 113, 133, 0.35); color: #fecdd3; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid rgba(148, 163, 184, 0.15); font-size: 13px; }
    th { color: #94a3b8; font-weight: 700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    @media (max-width: 860px) {
      .grid { grid-template-columns: 1fr; }
      .grid2 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Ops</h1>
    <div class="sub">Owner-grade view (static-first, read-only). No auto refresh.</div>

    <div class="controls card">
      <button id="btn-refresh" class="btn">Refresh (LIVE)</button>
      <span class="small">Baseline asOf: <span id="baseline-asof" class="mono">â€”</span></span>
      <span class="small">Live asOf: <span id="live-asof" class="mono">â€”</span></span>
      <span class="small">Source: <span id="data-source" class="mono">â€”</span></span>
      <span style="flex:1"></span>
      <span class="small" id="last-refresh"></span>
    </div>

    <div id="loading" class="card">No data loaded. Click Refresh (LIVE).</div>

    <div id="main" style="display:none;">
      <div class="card" style="margin-bottom: 12px;">
        <div class="k">Overall status</div>
        <div class="v" id="overall">â€”</div>
        <div class="small" id="overall-reason">â€”</div>
        <div class="small" id="what-to-fix" style="margin-top:6px;"></div>
      </div>

      <div class="grid" style="margin-bottom: 12px;">
        <div class="card">
          <div class="k">Costs today (Workers)</div>
          <div class="v" id="workers-used">â€”</div>
          <div class="small" id="workers-budget">â€”</div>
        </div>
        <div class="card">
          <div class="k">Runtime mode</div>
          <div class="v" id="runtime-mode">â€”</div>
          <div class="small" id="runtime-note">â€”</div>
        </div>
        <div class="card">
          <div class="k">Safety locks</div>
          <div class="v" id="safety-kv-writes">â€”</div>
          <div class="small" id="safety-note">â€”</div>
        </div>
      </div>

      <div class="grid2" style="margin-bottom: 12px;">
        <div class="card">
          <div class="k" style="margin-bottom: 10px;">Provider budgets (monthly)</div>
          <table>
            <thead>
              <tr><th>Provider</th><th>Used</th><th>Limit</th><th>Remaining</th><th>Reset</th><th>Runtime calls today</th></tr>
            </thead>
            <tbody id="providers"></tbody>
          </table>
        </div>
        <div class="card">
          <div class="k" style="margin-bottom: 10px;">Daily snapshot pipeline (NASDAQ-100)</div>
          <table>
            <thead>
              <tr><th>Stage</th><th>Count</th><th>Expected</th><th>Status</th></tr>
            </thead>
            <tbody id="pipeline"></tbody>
          </table>
          <div id="pipeline-missing" class="small" style="margin-top: 10px;"></div>
        </div>
      </div>

      <div class="grid2" style="margin-bottom: 12px;">
        <div class="card">
          <div class="k" style="margin-bottom: 10px;">Data freshness</div>
          <div class="small" id="freshness-global">â€”</div>
          <div class="small" id="freshness-stale" style="margin-top: 8px;">â€”</div>
          <div class="small" id="freshness-list" style="margin-top: 8px;"></div>
        </div>
        <div class="card">
          <div class="k" style="margin-bottom: 10px;">Manual actions</div>
          <div class="small">Last manual refresh (client): <span class="mono" id="manual-ts">â€”</span></div>
          <div class="small" style="margin-top: 8px;">Min refresh interval enforced client-side: <span class="mono">60s</span></div>
        </div>
      </div>

      <div class="small" style="margin-top: 14px;">
        Source: <a href="/data/ops/summary.latest.json" style="color:#60a5fa;">/data/ops/summary.latest.json</a>
        <span class="small" id="asof" style="margin-left:10px;"></span>
      </div>
    </div>
  </div>

  <script>
    function esc(s) {
      return String(s == null ? '' : s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function fmtNum(n) {
      const v = Number(n);
      if (!Number.isFinite(v)) return 'â€”';
      return v.toLocaleString();
    }

    function pill(text, cls) {
      return '<span class="pill ' + cls + '">' + esc(text) + '</span>';
    }

    function pctClass(p) {
      const v = Number(p);
      if (!Number.isFinite(v)) return 'warn';
      if (v >= 90) return 'bad';
      if (v >= 70) return 'warn';
      return 'ok';
    }

    function setManualTs(ts) {
      try {
        localStorage.setItem('rv_ops_last_manual_refresh', ts);
      } catch {}
      const el = document.getElementById('manual-ts');
      if (el) el.textContent = ts;
    }

    function getManualTs() {
      try {
        return localStorage.getItem('rv_ops_last_manual_refresh');
      } catch {
        return null;
      }
    }

    function fmtTracked(value) {
      if (value === null || value === undefined) return 'not tracked';
      if (typeof value === 'number' && !Number.isFinite(value)) return 'not tracked';
      return String(value);
    }

    function pickUniverse(universes, id) {
      if (!Array.isArray(universes) || universes.length === 0) return null;
      const match = universes.find((u) => u && u.id === id);
      return match || universes[0];
    }

    function renderSummary(summary) {
      const loading = document.getElementById('loading');
      const main = document.getElementById('main');

      const baselineAsOfEl = document.getElementById('baseline-asof');
      if (baselineAsOfEl) baselineAsOfEl.textContent = summary?.ops_daily?.generated_at || 'â€”';
      const liveAsOfEl = document.getElementById('live-asof');
      if (liveAsOfEl) liveAsOfEl.textContent = summary?.generated_at || summary?.asof || 'â€”';

      const overallStatus = summary?.overall?.status || 'UNKNOWN';
      const overallReasons = Array.isArray(summary?.overall?.reasons) ? summary.overall.reasons : [];
      const overallLabel = overallStatus === 'OK' ? 'OK âœ…' : (overallStatus === 'WARN' ? 'WARN ðŸŸ ' : 'RISK ðŸ”´');
      document.getElementById('overall').textContent = overallLabel;
      document.getElementById('overall-reason').textContent = overallReasons.length ? overallReasons.join(' â€¢ ') : 'OK';
      document.getElementById('what-to-fix').textContent = overallReasons.length ? 'Check pipeline latest + manifest consistency.' : '';

      document.getElementById('workers-used').textContent = 'not tracked';
      document.getElementById('workers-budget').textContent = 'not tracked';

      document.getElementById('runtime-mode').textContent = 'STATIC';
      document.getElementById('runtime-note').textContent = 'Static summary artifact (no runtime auth).';

      document.getElementById('safety-kv-writes').textContent = 'not tracked';
      document.getElementById('safety-note').textContent = 'Static-only view.';

      const providers = summary?.providers && typeof summary.providers === 'object'
        ? Object.entries(summary.providers)
        : [];
      document.getElementById('providers').innerHTML = providers.length
        ? providers.sort(([a], [b]) => a.localeCompare(b)).map(([name, entry]) => {
            const budget = entry?.budget || null;
            const used = budget?.usedMonth ?? null;
            const lim = budget?.limitMonth ?? null;
            const rem = budget?.remainingMonth ?? null;
            const remPct = budget?.remainingPct ?? null;
            const callsToday = budget?.runtimeCallsToday ?? null;
            const status = remPct == null ? 'warn' : pctClass(100 - Number(remPct));
            const remText = remPct == null
              ? 'not tracked'
              : (pill(String(remPct) + '%', status) + ' <span class="small">' + esc(rem) + '</span>');
            return '<tr>' +
              '<td>' + esc(name) + '</td>' +
              '<td>' + esc(fmtTracked(used)) + '</td>' +
              '<td>' + esc(fmtTracked(lim)) + '</td>' +
              '<td>' + remText + '</td>' +
              '<td class="small">' + esc(budget?.resetDate || 'â€”') + '</td>' +
              '<td>' + esc(fmtTracked(callsToday)) + '</td>' +
            '</tr>';
          }).join('')
        : '<tr><td colspan="6" class="small">No provider budgets</td></tr>';

      const universe = pickUniverse(summary?.universes, 'nasdaq100');
      const expected = Number(universe?.expected || 0);
      const fetched = Number(universe?.fetched || 0);
      const validated = Number(universe?.validated || 0);
      const staticReady = Number(universe?.static_ready || 0);

      const stageRow = (label, value) => {
        const ok = expected > 0 && value >= expected;
        const cls = ok ? 'ok' : (value >= Math.floor(expected * 0.9) ? 'warn' : 'bad');
        return '<tr>' +
          '<td>' + esc(label) + '</td>' +
          '<td>' + esc(String(Number.isFinite(value) ? value : 'â€”')) + '</td>' +
          '<td>' + esc(String(Number.isFinite(expected) && expected > 0 ? expected : 'â€”')) + '</td>' +
          '<td>' + pill(ok ? 'OK' : 'MISSING', cls) + '</td>' +
        '</tr>';
      };

      document.getElementById('pipeline').innerHTML =
        stageRow('Fetched', fetched) +
        stageRow('Validated', validated) +
        stageRow('Static-ready', staticReady);

      document.getElementById('pipeline-missing').textContent = universe
        ? `Universe status: ${universe.status || 'UNKNOWN'}`
        : 'Universe status: UNKNOWN';

      const expectedTradingDay = summary?.overall?.expected_trading_day || null;
      const staleSymbols = summary?.overall?.stale_symbols_count ?? null;
      document.getElementById('freshness-global').textContent = expectedTradingDay
        ? `Expected trading day: ${expectedTradingDay}`
        : 'Freshness: not tracked';
      document.getElementById('freshness-stale').textContent = staleSymbols == null
        ? 'Stale symbols: not tracked'
        : `Stale symbols: ${staleSymbols}`;
      document.getElementById('freshness-list').textContent = '';

      document.getElementById('asof').textContent = '';

      loading.style.display = 'none';
      main.style.display = 'block';
    }

    async function refreshSummary() {
      const statusEl = document.getElementById('loading');
      const last = document.getElementById('last-refresh');
      const sourceEl = document.getElementById('data-source');
      if (last) last.textContent = `Last action: ${new Date().toLocaleString()}`;
      const url = `/data/ops/summary.latest.json?t=${Date.now()}`;

      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) {
          if (statusEl) statusEl.textContent = `Failed to load summary (HTTP ${res.status}).`;
          return;
        }
        const summary = await res.json();
        if (sourceEl) sourceEl.textContent = 'static';
        renderSummary(summary);
      } catch (err) {
        if (statusEl) statusEl.textContent = 'Failed to load summary.';
      }
    }

    document.getElementById('btn-refresh').addEventListener('click', async () => {
      const now = new Date().toLocaleString();
      setManualTs(now);
      refreshSummary();
    });

    const previous = getManualTs();
    if (previous) {
      const el = document.getElementById('manual-ts');
      if (el) el.textContent = previous;
    }

    const baselineAsOfEl = document.getElementById('baseline-asof');
    if (baselineAsOfEl) baselineAsOfEl.textContent = 'â€”';

    const autoRefreshOnce = () => {
      if (!window.__opsAutoRefreshed) {
        window.__opsAutoRefreshed = true;
        refreshSummary();
      }
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', autoRefreshOnce);
    } else {
      autoRefreshOnce();
    }
  </script>
</body>
</html>
