<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ops â€” RubikVault</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
      background: #0b1220;
      color: #e5e7eb;
    }
    .wrap { max-width: 1180px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 6px; font-size: 28px; letter-spacing: -0.02em; }
    .sub { color: #94a3b8; margin-bottom: 18px; font-size: 14px; }
    .card { border: 1px solid rgba(148, 163, 184, 0.25); background: rgba(15, 23, 42, 0.7); border-radius: 12px; padding: 14px; overflow: hidden; }
    .grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; }
    .grid2 { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    .k { color: #94a3b8; font-size: 12px; text-transform: uppercase; letter-spacing: 0.06em; }
    .v { margin-top: 6px; font-size: 22px; font-weight: 800; }
    .small { color: #94a3b8; font-size: 12px; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin: 12px 0 18px; }
    .btn {
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(148,163,184,0.25);
      color: #e5e7eb;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(148,163,184,0.25); font-size: 12px; color: #e5e7eb; }
    .pill.ok { border-color: rgba(52, 211, 153, 0.35); color: #a7f3d0; }
    .pill.warn { border-color: rgba(251, 191, 36, 0.35); color: #fde68a; }
    .pill.bad { border-color: rgba(251, 113, 133, 0.35); color: #fecdd3; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid rgba(148, 163, 184, 0.15); font-size: 13px; }
    th { color: #94a3b8; font-weight: 700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    @media (max-width: 860px) {
      .grid { grid-template-columns: 1fr; }
      .grid2 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Ops</h1>
    <div class="sub">Owner-grade view (static-first, read-only). No auto refresh.</div>

    <div class="controls card">
      <button id="btn-refresh" class="btn">Refresh (LIVE)</button>
      <span class="small">Baseline asOf: <span id="baseline-asof" class="mono">â€”</span></span>
      <span class="small">Live asOf: <span id="live-asof" class="mono">â€”</span></span>
      <span class="small">Source: <span id="data-source" class="mono">â€”</span></span>
      <span style="flex:1"></span>
      <span class="small" id="last-refresh"></span>
    </div>

    <div id="loading" class="card">No data loaded. Click Refresh (LIVE).</div>

    <div id="main" style="display:none;">
      <div class="card" style="margin-bottom: 12px;">
        <div class="k">Overall status</div>
        <div class="v" id="overall">â€”</div>
        <div class="small" id="overall-reason">â€”</div>
        <div class="small" id="what-to-fix" style="margin-top:6px;"></div>
      </div>

      <div class="grid" style="margin-bottom: 12px;">
        <div class="card">
          <div class="k">Costs today (Workers)</div>
          <div class="v" id="workers-used">â€”</div>
          <div class="small" id="workers-budget">â€”</div>
        </div>
        <div class="card">
          <div class="k">Runtime mode</div>
          <div class="v" id="runtime-mode">â€”</div>
          <div class="small" id="runtime-note">â€”</div>
        </div>
        <div class="card">
          <div class="k">Safety locks</div>
          <div class="v" id="safety-kv-writes">â€”</div>
          <div class="small" id="safety-note">â€”</div>
        </div>
      </div>

      <div class="grid2" style="margin-bottom: 12px;">
        <div class="card">
          <div class="k" style="margin-bottom: 10px;">Provider budgets (monthly)</div>
          <table>
            <thead>
              <tr><th>Provider</th><th>Used</th><th>Limit</th><th>Remaining</th><th>Reset</th><th>Runtime calls today</th></tr>
            </thead>
            <tbody id="providers"></tbody>
          </table>
        </div>
        <div class="card">
          <div class="k" style="margin-bottom: 10px;">Daily snapshot pipeline (NASDAQ-100)</div>
          <table>
            <thead>
              <tr><th>Stage</th><th>Count</th><th>Expected</th><th>Status</th></tr>
            </thead>
            <tbody id="pipeline"></tbody>
          </table>
          <div id="pipeline-missing" class="small" style="margin-top: 10px;"></div>
        </div>
      </div>

      <div class="grid2" style="margin-bottom: 12px;">
        <div class="card">
          <div class="k" style="margin-bottom: 10px;">Data freshness</div>
          <div class="small" id="freshness-global">â€”</div>
          <div class="small" id="freshness-stale" style="margin-top: 8px;">â€”</div>
          <div class="small" id="freshness-list" style="margin-top: 8px;"></div>
        </div>
        <div class="card">
          <div class="k" style="margin-bottom: 10px;">Manual actions</div>
          <div class="small">Last manual refresh (client): <span class="mono" id="manual-ts">â€”</span></div>
          <div class="small" style="margin-top: 8px;">Min refresh interval enforced client-side: <span class="mono">60s</span></div>
        </div>
      </div>

      <div class="small" style="margin-top: 14px;">
        Source: <a href="/api/mission-control/summary" style="color:#60a5fa;">/api/mission-control/summary</a>
        <span class="small" id="asof" style="margin-left:10px;"></span>
      </div>
    </div>
  </div>

  <script>
    function esc(s) {
      return String(s == null ? '' : s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function fmtNum(n) {
      const v = Number(n);
      if (!Number.isFinite(v)) return 'â€”';
      return v.toLocaleString();
    }

    function fmtNa(v) {
      if (v === null || v === undefined) return 'N/A (not configured)';
      if (typeof v === 'number' && !Number.isFinite(v)) return 'N/A (not configured)';
      return String(v);
    }

    function pill(text, cls) {
      return '<span class="pill ' + cls + '">' + esc(text) + '</span>';
    }

    function pctClass(p) {
      const v = Number(p);
      if (!Number.isFinite(v)) return 'warn';
      if (v >= 90) return 'bad';
      if (v >= 70) return 'warn';
      return 'ok';
    }

    function setManualTs(ts) {
      try {
        localStorage.setItem('rv_ops_last_manual_refresh', ts);
      } catch {}
      const el = document.getElementById('manual-ts');
      if (el) el.textContent = ts;
    }

    function getManualTs() {
      try {
        return localStorage.getItem('rv_ops_last_manual_refresh');
      } catch {
        return null;
      }
    }

    function getOpsKey() {
      try {
        return sessionStorage.getItem('rv_ops_key');
      } catch {
        return null;
      }
    }

    function setOpsKey(key) {
      try {
        sessionStorage.setItem('rv_ops_key', key);
      } catch {}
    }

    function renderFromBaseline(baseline, baselineAsOf, opsLive, liveAsOf) {
      const loading = document.getElementById('loading');
      const main = document.getElementById('main');

      const baselineAsOfEl = document.getElementById('baseline-asof');
      if (baselineAsOfEl) baselineAsOfEl.textContent = baselineAsOf || 'â€”';
      const liveAsOfEl = document.getElementById('live-asof');
      if (liveAsOfEl) liveAsOfEl.textContent = liveAsOf || 'â€”';

      const expected = Number(baseline?.pipeline?.expected || baseline?.expectedUniverse || 100);
      const fetched = Number(baseline?.pipeline?.fetched || 0);
      const validated = Number(baseline?.pipeline?.validatedStored || 0);
      const computed = Number(baseline?.pipeline?.computed || 0);
      const staticReady = Number(baseline?.pipeline?.staticReady || 0);

      const pipelineOk = Number.isFinite(expected) && Number.isFinite(staticReady) && staticReady >= expected;
      const staleCount = baseline?.freshness?.staleCount;
      const freshnessOk = staleCount !== null && staleCount !== undefined ? Number(staleCount) === 0 : false;

      const verdict = pipelineOk && freshnessOk ? 'HEALTHY' : 'RISK';
      document.getElementById('overall').innerHTML = verdict === 'HEALTHY' ? 'HEALTHY âœ…' : 'RISK ðŸ”´';
      document.getElementById('overall-reason').textContent = pipelineOk
        ? (freshnessOk ? 'OK' : `SNAPSHOT_STALE (stale=${fmtNa(staleCount)})`)
        : `PIPELINE_STATIC_READY=${staticReady}/${expected}`;

      const missingCount = Array.isArray(baseline?.pipeline?.missing) ? baseline.pipeline.missing.length : 0;
      const what = (!pipelineOk)
        ? 'Pipeline static-ready missing: computed/static steps not producing artifacts'
        : (!freshnessOk ? 'Freshness stale: daily snapshot job not producing expected trading day' : '');
      document.getElementById('what-to-fix').textContent = what;

      document.getElementById('workers-used').textContent = opsLive?.cloudflare ? fmtNa(opsLive.cloudflare.requestsToday) : 'N/A (not configured)';
      document.getElementById('workers-budget').textContent = opsLive?.cloudflare ? `Last 24h: ${fmtNa(opsLive.cloudflare.requestsLast24h)}` : 'N/A (not configured)';

      document.getElementById('runtime-mode').textContent = 'LIVE';
      document.getElementById('runtime-note').textContent = 'Single-click live refresh (manual, gated).';

      const safety = baseline?.safety || {};
      const pollingDefaultOff = safety.pollingDefaultOff;
      const runtimeWritesDisabled = safety.runtimeWritesDisabled;
      document.getElementById('safety-kv-writes').textContent = 'N/A (runtime writes disabled)';
      document.getElementById('safety-note').textContent = `Polling default OFF: ${pollingDefaultOff == null ? 'N/A (not configured)' : (pollingDefaultOff ? 'YES' : 'NO')} â€¢ Runtime writes disabled: ${runtimeWritesDisabled == null ? 'N/A (not configured)' : (runtimeWritesDisabled ? 'YES' : 'NO')}`;

      const providers = Array.isArray(baseline?.providers) ? baseline.providers : [];
      document.getElementById('providers').innerHTML = providers.length
        ? providers.map((p) => {
            const name = p.name || 'unknown';
            const used = p.usedMonth;
            const lim = p.limitMonth;
            const rem = p.remainingMonth;
            const remPct = p.remainingPct;
            const callsToday = p.runtimeCallsToday;
            const status = remPct == null ? 'warn' : pctClass(100 - Number(remPct));
            const remText = remPct == null ? 'N/A (not configured)' : (pill(String(remPct) + '%', status) + ' <span class="small">' + esc(rem) + '</span>');
            return '<tr>' +
              '<td>' + esc(name) + '</td>' +
              '<td>' + esc(used == null ? 'N/A (not configured)' : used) + '</td>' +
              '<td>' + esc(lim == null ? 'N/A (not configured)' : lim) + '</td>' +
              '<td>' + remText + '</td>' +
              '<td class="small">' + esc(p.resetDate || 'â€”') + '</td>' +
              '<td>' + esc(callsToday == null ? 'N/A (not configured)' : callsToday) + '</td>' +
            '</tr>';
          }).join('')
        : '<tr><td colspan="6" class="small">No provider budgets</td></tr>';

      const stageRow = (label, value) => {
        const ok = value >= expected;
        const cls = ok ? 'ok' : (value >= Math.floor(expected * 0.9) ? 'warn' : 'bad');
        return '<tr>' +
          '<td>' + esc(label) + '</td>' +
          '<td>' + esc(String(value)) + '</td>' +
          '<td>' + esc(String(expected)) + '</td>' +
          '<td>' + pill(ok ? 'OK' : 'MISSING', cls) + '</td>' +
        '</tr>';
      };

      document.getElementById('pipeline').innerHTML =
        stageRow('Fetched', fetched) +
        stageRow('Validated & Stored', validated) +
        stageRow('Computed', computed) +
        stageRow('Static-ready', staticReady);

      const missing = Array.isArray(baseline?.pipeline?.missing) ? baseline.pipeline.missing : [];
      const missingText = missing.length
        ? ('Missing: ' + missing.slice(0, 20).map((m) => `${m.ticker}:${m.reason}`).join(', ') + (missing.length > 20 ? ` â€¦(+${missing.length - 20})` : ''))
        : 'Missing: â€”';
      document.getElementById('pipeline-missing').textContent = missingText;

      const freshness = baseline?.freshness || {};
      document.getElementById('freshness-global').textContent = `Latest snapshot date: ${freshness.latestSnapshotDate || 'â€”'} â€¢ Expected: ${freshness.expectedTradingDay || 'â€”'}`;
      document.getElementById('freshness-stale').textContent = `Stale stocks: ${freshness.staleCount == null ? 'N/A (not configured)' : freshness.staleCount}/${expected}`;
      const staleList = Array.isArray(freshness.staleList) ? freshness.staleList : [];
      document.getElementById('freshness-list').textContent = staleList.length
        ? ('Stale: ' + staleList.slice(0, 20).join(', ') + (staleList.length > 20 ? ` â€¦(+${staleList.length - 20})` : ''))
        : '';

      document.getElementById('asof').textContent = '';

      loading.style.display = 'none';
      main.style.display = 'block';
    }

    async function fetchWithFallback(primaryUrl, fallbackUrl, headers = {}) {
      const t = Date.now();
      const cacheHeaders = {
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache',
        ...headers
      };

      try {
        const primaryRes = await fetch(`${primaryUrl}?t=${t}`, { cache: 'no-store', headers: cacheHeaders });
        if (primaryRes.ok) {
          const data = await primaryRes.json();
          return { ok: true, res: primaryRes, payload: data, source: 'static_summary' };
        }
        if (primaryRes.status !== 404) {
          return { ok: false, res: primaryRes, payload: null, source: null };
        }
      } catch (err) {
        console.warn('Primary fetch failed:', err.message);
      }

      try {
        const fallbackRes = await fetch(`${fallbackUrl}?t=${t}`, { cache: 'no-store', headers: cacheHeaders });
        const fallbackData = await fallbackRes.json();
        return { ok: fallbackRes.ok, res: fallbackRes, payload: fallbackData, source: 'mission_control_api' };
      } catch (err) {
        return { ok: false, res: null, payload: null, source: null, error: err.message };
      }
    }

    async function fetchLiveOnce(key) {
      const result = await fetchWithFallback(
        '/data/ops/summary.latest.json',
        '/api/mission-control/summary?live=1',
        { 'X-OPS-KEY': key }
      );
      return result;
    }

    async function refreshLiveWithPromptAndRetry() {
      const statusEl = document.getElementById('loading');
      const last = document.getElementById('last-refresh');
      const sourceEl = document.getElementById('data-source');
      if (last) last.textContent = `Last action: ${new Date().toLocaleString()}`;

      const key0 = getOpsKey();
      const key1 = key0 || window.prompt('Enter OPS key');
      if (!key1) {
        if (statusEl) statusEl.textContent = 'Missing OPS key.';
        return;
      }

      setOpsKey(key1);
      let result = await fetchLiveOnce(key1);

      if (result.res && result.res.status === 403) {
        try { sessionStorage.removeItem('rv_ops_key'); } catch {}
        const key2 = window.prompt('403: wrong OPS key. Enter OPS key');
        if (!key2) {
          if (statusEl) statusEl.textContent = '403: wrong OPS key.';
          return;
        }
        setOpsKey(key2);
        result = await fetchLiveOnce(key2);
      }

      if (!result.ok) {
        const msg = result.payload?.meta?.reason || result.payload?.error?.message || (result.res ? `HTTP ${result.res.status}` : result.error || 'Fetch failed');
        if (statusEl) statusEl.textContent = String(msg);
        return;
      }

      if (sourceEl) {
        sourceEl.textContent = result.source === 'static_summary' ? 'static' : 'live API';
      }

      const data = result.payload && result.payload.data && typeof result.payload.data === 'object' ? result.payload.data : {};
      const opsBaseline = data.opsBaseline || null;
      const baseline = opsBaseline && opsBaseline.baseline ? opsBaseline.baseline : null;
      const baselineAsOf = opsBaseline && typeof opsBaseline.asOf === 'string' ? opsBaseline.asOf : null;
      const opsLive = data.opsLive || null;
      const liveAsOf = opsLive && typeof opsLive.asOf === 'string' ? opsLive.asOf : null;
      renderFromBaseline(baseline, baselineAsOf, opsLive, liveAsOf);
    }

    document.getElementById('btn-refresh').addEventListener('click', async () => {
      await refreshLiveWithPromptAndRetry();
    });

    const previous = getManualTs();
    if (previous) {
      const el = document.getElementById('manual-ts');
      if (el) el.textContent = previous;
    }

    const baselineAsOfEl = document.getElementById('baseline-asof');
    if (baselineAsOfEl) baselineAsOfEl.textContent = 'â€”';
  </script>
</body>
</html>
