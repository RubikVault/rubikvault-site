<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RV Usage</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 24px; color: #111; }
      h1 { font-size: 20px; margin-bottom: 6px; }
      p { margin: 4px 0 16px; color: #444; }
      table { border-collapse: collapse; width: 100%; max-width: 900px; }
      th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; }
      th { background: #f2f2f2; text-align: left; }
      .muted { color: #666; }
    </style>
  </head>
  <body>
    <h1>Usage Report</h1>
    <p class="muted" id="status">Loading...</p>

    <table id="usage-table">
      <thead>
        <tr>
          <th>Provider</th>
          <th>Requests</th>
          <th>Credits</th>
          <th>Remaining</th>
          <th>Errors</th>
          <th>Last Seen</th>
          <th>Circuit</th>
          <th>Cooldown</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Skipped Blocks</h2>
    <p class="muted" id="skip-summary">Loading...</p>
    <table id="skip-table">
      <thead>
        <tr>
          <th>Reason</th>
          <th>Blocks</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Top Recent Errors</h2>
    <p class="muted" id="error-summary">Loading...</p>
    <table id="error-table">
      <thead>
        <tr>
          <th>Reason</th>
          <th>Count</th>
          <th>Last Seen</th>
          <th>Providers</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      const statusEl = document.getElementById("status");
      const tbody = document.querySelector("#usage-table tbody");
      const skipSummary = document.getElementById("skip-summary");
      const skipTbody = document.querySelector("#skip-table tbody");
      const errorSummary = document.getElementById("error-summary");
      const errorTbody = document.querySelector("#error-table tbody");

      function formatRemaining(entry) {
        const req = `${entry.remainingRequests ?? "-"}/${entry.limitRequests ?? "-"}`;
        const cred = `${entry.remainingCredits ?? "-"}/${entry.limitCredits ?? "-"}`;
        return `${req} req, ${cred} credits`;
      }

      function formatErrors(errors) {
        if (!errors || typeof errors !== "object") return "0";
        const pairs = Object.entries(errors);
        if (!pairs.length) return "0";
        return pairs.map(([key, value]) => `${key}:${value}`).join(", ");
      }

      async function loadUsage() {
        try {
          const [usageRes, seedRes, stateRes] = await Promise.all([
            fetch("/data/usage-report.json", { cache: "no-store" }),
            fetch("/data/seed-manifest.json", { cache: "no-store" }),
            fetch("/data/provider-state.json", { cache: "no-store" })
          ]);
          const usage = usageRes.ok ? await usageRes.json() : null;
          const seed = seedRes.ok ? await seedRes.json() : null;
          const providerState = stateRes.ok ? await stateRes.json() : null;

          if (!usage || !usage.providers) {
            statusEl.textContent = "Usage report missing or invalid";
            return;
          }

          const day = usage.day || "unknown";
          const runId = seed?.runId || "unknown";
          statusEl.textContent = `Day ${day} | Last run ${runId}`;

          tbody.innerHTML = "";
          const providersState = providerState?.providers || {};
          Object.entries(usage.providers).forEach(([provider, entry]) => {
            const state = providersState[provider] || {};
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${provider}</td>
              <td>${entry.requests ?? 0}</td>
              <td>${entry.credits ?? 0}</td>
              <td>${formatRemaining(entry)}</td>
              <td>${formatErrors(entry.errorsByReason)}</td>
              <td>${state.lastSeen || "-"}</td>
              <td>${state.circuitState || "closed"}</td>
              <td>${state.cooldownUntil || "-"}</td>
            `;
            tbody.appendChild(row);
          });

          const blocks = Array.isArray(seed?.blocks) ? seed.blocks : [];
          const missingSecret = blocks.filter((block) => block.reason === "MISSING_SECRET");
          const budgetExhausted = blocks.filter((block) => block.reason === "BUDGET_EXHAUSTED");
          const circuitOpen = blocks.filter((block) => block.reason === "CIRCUIT_OPEN");
          const rateLimited = blocks.filter((block) => block.reason === "RATE_LIMITED");
          const rows = [
            { label: "MISSING_SECRET", blocks: missingSecret },
            { label: "BUDGET_EXHAUSTED", blocks: budgetExhausted },
            { label: "CIRCUIT_OPEN", blocks: circuitOpen },
            { label: "RATE_LIMITED", blocks: rateLimited }
          ];
          skipTbody.innerHTML = "";
          rows.forEach((row) => {
            const tr = document.createElement("tr");
            const list = row.blocks.map((block) => block.blockId).join(", ") || "-";
            tr.innerHTML = `
              <td>${row.label}</td>
              <td>${list}</td>
            `;
            skipTbody.appendChild(tr);
          });
          skipSummary.textContent = `Missing secrets: ${missingSecret.length}, Budget exhausted: ${budgetExhausted.length}, Circuit open: ${circuitOpen.length}, Rate limited: ${rateLimited.length}`;

          const errorRows = [];
          const providerErrors = providersState || {};
          Object.entries(providerErrors).forEach(([provider, state]) => {
            const failures = state.failures || {};
            Object.entries(failures).forEach(([reason, count]) => {
              if (!count) return;
              errorRows.push({ reason, count, lastSeen: state.lastSeen, provider });
            });
          });
          errorRows.sort((a, b) => (b.count || 0) - (a.count || 0));
          errorTbody.innerHTML = "";
          const top = errorRows.slice(0, 10);
          top.forEach((row) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${row.reason}</td>
              <td>${row.count}</td>
              <td>${row.lastSeen || "-"}</td>
              <td>${row.provider}</td>
            `;
            errorTbody.appendChild(tr);
          });
          errorSummary.textContent = top.length ? `Top ${top.length} errors` : "No errors recorded";
        } catch (error) {
          statusEl.textContent = "Failed to load usage report";
          skipSummary.textContent = "Failed to load seed manifest";
          errorSummary.textContent = "Failed to load provider state";
        }
      }

      loadUsage();
    </script>
  </body>
</html>
