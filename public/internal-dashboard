<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RubikVault Internal Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0b1120;
      color: #f8fafc;
      line-height: 1.6;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 { margin-bottom: 30px; color: #38bdf8; }
    .banner {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .banner-left {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .banner-right {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .token-input {
      background: #111827;
      color: #f8fafc;
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 8px 10px;
      min-width: 360px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }
    .section {
      background: #111827;
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .section h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #38bdf8;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      padding-bottom: 10px;
    }
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .status-card {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 15px;
    }
    .status-card.ok { border-color: #10b981; }
    .status-card.warn { border-color: #f59e0b; }
    .status-card.fail { border-color: #ef4444; }
    .status-card h3 {
      font-size: 12px;
      text-transform: uppercase;
      color: #cbd5f5;
      margin-bottom: 8px;
    }
    .status-card .value {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .status-card .label {
      font-size: 11px;
      color: #94a3b8;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
    }
    th {
      background: rgba(15, 23, 42, 0.6);
      font-weight: 600;
      color: #cbd5f5;
      position: sticky;
      top: 0;
    }
    tr:hover { background: rgba(15, 23, 42, 0.4); }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge.ok { background: #10b981; color: white; }
    .badge.warn { background: #f59e0b; color: white; }
    .badge.fail { background: #ef4444; color: white; }
    .badge.partial { background: #3b82f6; color: white; }
    .badge.stale { background: #8b5cf6; color: white; }
    .refresh-btn {
      background: #38bdf8;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      margin-bottom: 15px;
    }
    .usage-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 14px;
      align-items: center;
      margin-bottom: 12px;
      color: #cbd5f5;
      font-size: 12px;
    }
    .usage-panel label {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #94a3b8;
    }
    .usage-panel input {
      background: #0f172a;
      color: #f8fafc;
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 6px;
      padding: 6px 8px;
      width: 140px;
      font-size: 12px;
    }
    .usage-metric strong { color: #f8fafc; }
    .refresh-btn:hover { background: #0ea5e9; }
    .secondary-btn {
      background: rgba(15, 23, 42, 0.6);
      color: #f8fafc;
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    .secondary-btn:hover { border-color: rgba(56, 189, 248, 0.6); }
    a { color: #38bdf8; text-decoration: none; }
    a:hover { text-decoration: underline; }
    code { color: #cbd5f5; }
    pre {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.15);
      border-radius: 10px;
      padding: 12px;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: #e2e8f0;
      max-height: 360px;
      overflow: auto;
    }
    .split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px) {
      .split { grid-template-columns: 1fr; }
      .token-input { min-width: 260px; }
    }
    .timestamp {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 10px;
    }
    .loading { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç RubikVault Internal Dashboard <span id="rv-internal-auth" class="badge warn">auth: unknown</span></h1>

    <div class="banner" id="auth-banner">
      <div class="banner-left">
        <span id="auth-banner-badge" class="badge warn">token missing</span>
        <span style="color:#cbd5f5; font-size: 13px;">Internal endpoints need <code>RV_INTERNAL_TOKEN</code>. Without it, many calls intentionally return <code>404</code>.</span>
      </div>
      <div class="banner-right">
        <input id="token-input" class="token-input" placeholder="Paste token here (stored in localStorage)" />
        <button class="secondary-btn" id="apply-token">Apply</button>
        <button class="secondary-btn" id="copy-link">Copy link</button>
      </div>
    </div>
    
    <div class="section">
      <h2>Endpoint Reachability</h2>
      <div style="overflow-x: auto;">
        <table id="endpoint-probes">
          <thead>
            <tr>
              <th>Endpoint</th>
              <th>Status</th>
              <th>Hint</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="3">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>System Health Overview</h2>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px;">
        <button class="refresh-btn" id="refresh-all">üîÑ Refresh All</button>
        <span class="usage-metric">Workers left today: <strong id="workers-remaining">‚Äî</strong></span>
        <span class="usage-metric">One refresh uses: <strong id="workers-refresh-cost">‚Äî</strong> (<span id="workers-refresh-pct">‚Äî</span>)</span>
        <span class="usage-metric">Last refresh calls: <strong id="workers-last-calls">‚Äî</strong></span>
      </div>
      <div class="usage-panel">
        <label>Daily budget
          <input id="workers-daily-budget" type="number" min="0" step="1" placeholder="e.g. 100000" />
        </label>
        <label>Used today
          <input id="workers-used-today" type="number" min="0" step="1" placeholder="e.g. 1200" />
        </label>
        <span style="color:#94a3b8;">Manual estimate. Stored locally.</span>
      </div>
      <div class="status-grid" id="health-overview">
        <div class="status-card">
          <h3>Overall Status</h3>
          <div class="value">‚Äî</div>
          <div class="label">Loading...</div>
        </div>
      </div>
      <div class="timestamp" id="health-timestamp"></div>
      <div class="timestamp" id="health-report-note">Block status: not refreshed yet.</div>
    </div>

    <div class="section">
      <h2>Snapshot Freshness (Static)</h2>
      <div style="color:#94a3b8;font-size:12px;margin-bottom:10px;">
        Static files only. No API calls. Uses simple freshness budgets (EOD ‚â§ 36h, Crypto ‚â§ 12h, News ‚â§ 6h).
      </div>
      <div style="overflow-x:auto;">
        <table id="snapshot-freshness">
          <thead>
            <tr>
              <th>Snapshot</th>
              <th>Path</th>
              <th>Updated</th>
              <th>Age</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="5">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>Targets (Preview + Prod)</h2>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
        <span class="badge" style="background:rgba(56,189,248,0.15);color:#cbd5f5;border:1px solid rgba(56,189,248,0.25);">same-origin preferred</span>
        <span style="color:#94a3b8;font-size:12px;">Cross-origin fetch may be blocked unless CORS is enabled.</span>
        <button class="secondary-btn" id="load-targets">Load Targets</button>
        <span style="color:#94a3b8;font-size:12px;">Request-heavy. Load only when needed.</span>
      </div>
      <div class="split">
        <div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <strong style="color:#cbd5f5;">This origin</strong>
            <code id="origin-this">‚Äî</code>
            <button class="secondary-btn" id="open-this">Open</button>
          </div>
          <div class="timestamp" id="targets-this-status">‚Äî</div>
          <pre id="targets-this" style="max-height:240px;">Loading...</pre>
        </div>
        <div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <strong style="color:#cbd5f5;">Prod origin</strong>
            <input id="origin-prod" class="token-input" style="min-width:260px;" placeholder="https://rubikvault.com" />
            <button class="secondary-btn" id="open-prod">Open</button>
          </div>
          <div class="timestamp" id="targets-prod-status">‚Äî</div>
          <pre id="targets-prod" style="max-height:240px;">Set prod origin and refresh.</pre>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Debug Bundle (Consolidated)</h2>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
        <button class="secondary-btn" id="load-debug-bundle">Load Debug Bundle</button>
        <span style="color:#94a3b8;font-size:12px;">KV-heavy. Load only when needed.</span>
      </div>
      <div class="status-grid" id="debug-summary">
        <div class="status-card">
          <h3>Bundle Status</h3>
          <div class="value">‚Äî</div>
          <div class="label">Loading...</div>
        </div>
      </div>
      <div class="timestamp" id="debug-timestamp"></div>
      <div style="overflow-x: auto; margin-top: 12px;">
        <table id="debug-attempts">
          <thead>
            <tr>
              <th>Target</th>
              <th>OK</th>
              <th>Status</th>
              <th>Reason</th>
              <th>Snippet</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="5">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div style="max-height: 320px; overflow-y: auto; margin-top: 12px;">
        <table id="recent-events">
          <thead>
            <tr>
              <th>Time</th>
              <th>Feature</th>
              <th>HTTP</th>
              <th>Quality</th>
              <th>Error</th>
              <th>Trace</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="6">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>Client Debug Tools</h2>
      <div style="display:grid;gap:10px;">
        <div>
          <span class="badge" style="background:rgba(16,185,129,0.15);color:#cbd5f5;border:1px solid rgba(16,185,129,0.25);">Enable</span>
        <span style="color:#cbd5f5;font-size:13px;">Open any public page with <code>?debug=1</code>.</span>
        </div>
        <div>
          <span style="color:#cbd5f5;font-size:13px;">Debug assets (static):</span>
          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:6px;">
            <a href="/debug/rv-debug-console.js" target="_blank" rel="noreferrer">/debug/rv-debug-console.js</a>
            <a href="/debug/panel.js" target="_blank" rel="noreferrer">/debug/panel.js</a>
            <a href="/debug/diagnostics.js" target="_blank" rel="noreferrer">/debug/diagnostics.js</a>
            <a href="/debug/rv-debug.js" target="_blank" rel="noreferrer">/debug/rv-debug.js</a>
            <a href="/diagnose.js" target="_blank" rel="noreferrer">/diagnose.js</a>
          </div>
        </div>
        <div>
          <span style="color:#94a3b8;font-size:12px;">If you see <code>Config missing - API disabled</code>, check <code>window.RV_CONFIG.apiBase</code> and the config loader.</span>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Docs (Runbook + Debug + Block Analysis)</h2>
      <div style="display:grid;gap:10px;">
        <details open>
          <summary style="cursor:pointer;color:#cbd5f5;">DEBUG_README.md</summary>
          <pre id="doc-debug-readme">Loading...</pre>
        </details>
        <details>
          <summary style="cursor:pointer;color:#cbd5f5;">RUNBOOK.md</summary>
          <pre id="doc-runbook">Loading...</pre>
        </details>
        <details>
          <summary style="cursor:pointer;color:#cbd5f5;">BLOCK_ANALYSIS.md</summary>
          <pre id="doc-block-analysis">Loading...</pre>
        </details>
      </div>
    </div>

    <div class="section">
      <h2>Block Verification (Server)</h2>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
        <span class="badge" style="background:rgba(56,189,248,0.15);color:#cbd5f5;border:1px solid rgba(56,189,248,0.25);">/data/system-health.json</span>
        <span style="color:#94a3b8;font-size:12px;">Static snapshot overview derived from mirrors and validation gates.</span>
      </div>
      <div class="status-grid" id="health-report-summary">
        <div class="status-card"><h3>Health Score</h3><div class="value">‚Äî</div><div class="label">Loading...</div></div>
        <div class="status-card"><h3>OK</h3><div class="value">‚Äî</div><div class="label">Blocks</div></div>
        <div class="status-card"><h3>PARTIAL</h3><div class="value">‚Äî</div><div class="label">Blocks</div></div>
        <div class="status-card"><h3>BAD</h3><div class="value">‚Äî</div><div class="label">Blocks</div></div>
      </div>
      <div class="timestamp" id="health-report-timestamp"></div>
      <div style="overflow-x:auto; margin-top: 12px;">
        <table id="health-report-table">
          <thead>
            <tr>
              <th>Block</th>
              <th>Feature</th>
              <th>State</th>
              <th>Endpoint</th>
              <th>Status</th>
              <th>Reason</th>
              <th>Invalid Fields</th>
              <th>Circuit</th>
              <th>Error</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="9">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div style="margin-top: 12px;">
        <select id="health-report-block" style="width: 100%; padding: 8px; margin-bottom: 10px; background: #111827; color: #f8fafc; border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px;">
          <option value="">Select a block for field details...</option>
        </select>
        <div style="overflow-x:auto;">
          <table id="health-report-fields">
            <thead>
              <tr>
                <th>Field</th>
                <th>Path</th>
                <th>Required</th>
                <th>Valid</th>
                <th>Reason</th>
                <th>Fix</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6">Select a block above...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Debug Matrix (KV / Mirrors)</h2>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
        <span class="badge" style="background:rgba(16,185,129,0.15);color:#cbd5f5;border:1px solid rgba(16,185,129,0.25);">/data/provider-state.json</span>
        <button class="secondary-btn" id="load-debug-matrix">Load Debug Matrix</button>
        <span style="color:#94a3b8;font-size:12px;">Reads provider/circuit state + lock status from static snapshots.</span>
      </div>
      <div class="timestamp" id="debug-matrix-timestamp"></div>
      <div style="overflow-x:auto;">
        <table id="debug-matrix-table">
          <thead>
            <tr>
              <th>Feature</th>
              <th>Endpoint</th>
              <th>Status</th>
              <th>Empty Reason</th>
              <th>Last Update</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="5">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>Block √ó Field Matrix</h2>
      <div style="overflow-x: auto;">
        <table id="block-matrix">
          <thead>
            <tr>
              <th>Block</th>
              <th>Feature ID</th>
              <th>Status</th>
              <th>Data Present</th>
              <th>Quality</th>
              <th>As-of</th>
              <th>Source</th>
              <th>Cache</th>
              <th>Last Error</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="9">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>API Keys & Limits</h2>
      <table id="api-keys">
        <thead>
          <tr>
            <th>Provider</th>
            <th>Key Alias</th>
            <th>Status</th>
            <th>Counts (Today)</th>
            <th>Counts (Week)</th>
            <th>Counts (Month)</th>
            <th>Hard Limit</th>
            <th>Remaining</th>
            <th>Remaining (Week)</th>
            <th>Remaining (Month)</th>
            <th>Burn/Hour</th>
            <th>Last Error</th>
            <th>Last Used</th>
            <th>Hint</th>
            <th>Recommended Action</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="14">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="section">
      <h2>Error & Events Timeline</h2>
      <div style="max-height: 400px; overflow-y: auto;">
        <table id="error-timeline">
          <thead>
            <tr>
              <th>Time</th>
              <th>Type</th>
              <th>Feature</th>
              <th>Error Code</th>
              <th>Message</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="6">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>Field Drilldown</h2>
      <select id="field-selector" style="width: 100%; padding: 8px; margin-bottom: 15px; background: #111827; color: #f8fafc; border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px;">
        <option>Select a field to inspect...</option>
      </select>
      <div id="field-details" style="background: rgba(15, 23, 42, 0.6); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
        Select a field above to see details...
      </div>
    </div>
  </div>

  <script type="module">
    const API_BASE = '/data';
    const TOKEN_STORAGE_KEY = 'rv_internal_token';
    const PROD_ORIGIN_KEY = 'rv_internal_prod_origin';
    const urlParams = new URLSearchParams(window.location.search);
    const urlToken = urlParams.get('token') || '';
    const storedToken = (() => {
      try { return window.localStorage.getItem(TOKEN_STORAGE_KEY) || ''; } catch { return ''; }
    })();
    let INTERNAL_TOKEN = urlToken || storedToken || '';
    const RV_DASH_RUN_ID = `dash-${Date.now().toString(36)}`;
    const RV_DASH_RUN_ID = `dash-${Date.now().toString(36)}`;

    const withToken = (url) => {
      if (!INTERNAL_TOKEN) return url;
      const u = new URL(url, window.location.origin);
      u.searchParams.set('token', INTERNAL_TOKEN);
      return u.pathname + u.search;
    };

    function setToken(nextToken) {
      INTERNAL_TOKEN = String(nextToken || '').trim();
      try {
        if (INTERNAL_TOKEN) window.localStorage.setItem(TOKEN_STORAGE_KEY, INTERNAL_TOKEN);
        else window.localStorage.removeItem(TOKEN_STORAGE_KEY);
      } catch {}
    }

    function updateAuthUI() {
      const authEl = document.getElementById('rv-internal-auth');
      if (authEl) {
        if (INTERNAL_TOKEN) {
          authEl.textContent = 'auth: token';
          authEl.className = 'badge ok';
        } else {
          authEl.textContent = 'auth: none';
          authEl.className = 'badge warn';
        }
      }

      const bannerBadge = document.getElementById('auth-banner-badge');
      if (bannerBadge) {
        if (INTERNAL_TOKEN) {
          bannerBadge.textContent = 'token set';
          bannerBadge.className = 'badge ok';
        } else {
          bannerBadge.textContent = 'token missing';
          bannerBadge.className = 'badge warn';
        }
      }
    }

    function getProdOrigin() {
      const input = document.getElementById('origin-prod');
      const fromInput = input ? String(input.value || '').trim() : '';
      if (fromInput) return fromInput.replace(/\/$/, '');
      try {
        const stored = window.localStorage.getItem(PROD_ORIGIN_KEY) || '';
        return String(stored || '').trim().replace(/\/$/, '');
      } catch {
        return '';
      }
    }

    function setProdOrigin(origin) {
      const clean = String(origin || '').trim().replace(/\/$/, '');
      try {
        if (clean) window.localStorage.setItem(PROD_ORIGIN_KEY, clean);
        else window.localStorage.removeItem(PROD_ORIGIN_KEY);
      } catch {}
    }

    function withTokenTo(origin, path) {
      const u = new URL(path, origin);
      if (INTERNAL_TOKEN) u.searchParams.set('token', INTERNAL_TOKEN);
      return u.toString();
    }

    async function fetchJSONFromOrigin(origin, path) {
      try {
        recordRequest();
        const res = await fetch(withTokenTo(origin, path), { headers: { Accept: 'application/json' } });
        const text = await res.text();
        if (!res.ok) return { ok: false, status: res.status, text };
        try { return JSON.parse(text); } catch { return { ok: false, status: res.status, text }; }
      } catch (err) {
        return { ok: false, status: 0, text: String(err?.message || err || '') };
      }
    }

    async function updateTargets() {
      const originThisEl = document.getElementById('origin-this');
      const preThis = document.getElementById('targets-this');
      const preProd = document.getElementById('targets-prod');
      const stThis = document.getElementById('targets-this-status');
      const stProd = document.getElementById('targets-prod-status');

      const originThis = window.location.origin;
      if (originThisEl) originThisEl.textContent = originThis;

      const thisHealth = await fetchJSONFromOrigin(originThis, '/data/system-health.json');
      const thisDiag = await fetchJSONFromOrigin(originThis, '/data/error-summary.json');
      const thisSummary = {
        origin: originThis,
        health: thisHealth?.ok ? (thisHealth || {}) : { error: thisHealth },
        diag: thisDiag?.ok ? (thisDiag || {}) : { error: thisDiag }
      };
      if (preThis) preThis.textContent = JSON.stringify(thisSummary, null, 2);
      if (stThis) stThis.textContent = `Updated: ${new Date().toLocaleString()}`;

      const prodOrigin = getProdOrigin();
      if (!prodOrigin) {
        if (preProd) preProd.textContent = 'Set prod origin and refresh.';
        if (stProd) stProd.textContent = '‚Äî';
        return;
      }
      setProdOrigin(prodOrigin);

      const prodHealth = await fetchJSONFromOrigin(prodOrigin, '/data/system-health.json');
      const prodDiag = await fetchJSONFromOrigin(prodOrigin, '/data/error-summary.json');
      const prodSummary = {
        origin: prodOrigin,
        health: prodHealth?.ok ? (prodHealth || {}) : { error: prodHealth },
        diag: prodDiag?.ok ? (prodDiag || {}) : { error: prodDiag }
      };
      if (preProd) preProd.textContent = JSON.stringify(prodSummary, null, 2);
      if (stProd) {
        const maybeCors = prodHealth?.status === 0 || prodDiag?.status === 0;
        stProd.textContent = maybeCors
          ? `Updated: ${new Date().toLocaleString()} (note: status 0 may indicate CORS blocked)`
          : `Updated: ${new Date().toLocaleString()}`;
      }
    }

    async function loadDoc(path, targetId) {
      const el = document.getElementById(targetId);
      if (!el) return;
      try {
        recordRequest();
        const res = await fetch(path, { cache: 'no-store' });
        if (!res.ok) {
          el.textContent = `Failed to load ${path} (HTTP ${res.status})`;
          return;
        }
        const text = await res.text();
        el.textContent = text;
      } catch (err) {
        el.textContent = `Failed to load ${path}: ${String(err?.message || err || '')}`;
      }
    }

    async function fetchJSON(url) {
      try {
        recordRequest();
        const res = await fetch(withToken(url), { headers: { Accept: 'application/json' } });
        const text = await res.text();
        if (!res.ok) {
          return { ok: false, status: res.status, text };
        }
        try {
          return JSON.parse(text);
        } catch {
          return { ok: false, status: res.status, text };
        }
      } catch (err) {
        console.error('Fetch error:', err);
        return { ok: false, status: 0, text: String(err?.message || err || '') };
      }
    }

    async function auditActiveBlocks() {
      const sp500 = await fetchJSON('/data/snapshots/sp500-sectors.json');
      const spSector = sp500?.data?.sectors?.[0] || null;
      const sp500Info = {
        ok: sp500?.ok !== false,
        sectorsCount: sp500?.data?.sectors?.length || 0,
        hasRel: !!spSector?.rel,
        hasRelTech: !!spSector?.relTech,
        hasOldFields: spSector ? spSector.changePercent !== undefined && spSector.relativeToSpy !== undefined : false
      };

      const tech = await fetchJSON('/data/snapshots/tech-signals.json');
      const techFirst = tech?.data?.items?.[0] || tech?.data?.signals?.[0] || null;
      const techInfo = {
        ok: tech?.ok !== false,
        itemsCount: tech?.data?.items?.length || tech?.data?.signals?.length || 0,
        firstKeys: techFirst ? Object.keys(techFirst) : null,
        asOf: tech?.data?.updatedAt || tech?.meta?.asOf || tech?.ts || null
      };

      const alpha = await fetchJSON('/data/snapshots/alpha-radar.json');
      const alphaTop = alpha?.data?.picks?.top || [];
      const alphaScores = alphaTop.map((p) => `${p.setupScore}-${p.triggerScore}-${p.totalScore}`);
      const alphaInfo = {
        ok: alpha?.ok !== false,
        topCount: alphaTop.length,
        uniqueScores: new Set(alphaScores).size,
        sampleScores: alphaTop.slice(0, 3).map((p) => ({ symbol: p.symbol, setupScore: p.setupScore, triggerScore: p.triggerScore, totalScore: p.totalScore }))
      };

      const marketphase = await fetchJSON('/data/marketphase/index.json');
      const marketphaseInfo = {
        ok: marketphase?.ok !== false,
        symbolsCount: marketphase?.symbols?.length || marketphase?.data?.symbols?.length || 0
      };

      const rvciLatest = await fetchJSON('/data/rvci_latest.json');
      const rvciLatestInfo = {
        ok: rvciLatest?.ok !== false,
        dataKeys: rvciLatest?.data ? Object.keys(rvciLatest.data) : null,
        itemsCount: rvciLatest?.data?.items?.length || 0
      };

    }

    async function auditActiveBlocks() {
      const sp500 = await fetchJSON('/data/snapshots/sp500-sectors.json');
      const spSector = sp500?.data?.sectors?.[0] || null;
      const sp500Info = {
        ok: sp500?.ok !== false,
        sectorsCount: sp500?.data?.sectors?.length || 0,
        hasRel: !!spSector?.rel,
        hasRelTech: !!spSector?.relTech,
        hasOldFields: spSector ? spSector.changePercent !== undefined && spSector.relativeToSpy !== undefined : false
      };

      const tech = await fetchJSON('/data/snapshots/tech-signals.json');
      const techFirst = tech?.data?.items?.[0] || tech?.data?.signals?.[0] || null;
      const techInfo = {
        ok: tech?.ok !== false,
        itemsCount: tech?.data?.items?.length || tech?.data?.signals?.length || 0,
        firstKeys: techFirst ? Object.keys(techFirst) : null,
        asOf: tech?.data?.updatedAt || tech?.meta?.asOf || tech?.ts || null
      };

      const alpha = await fetchJSON('/data/snapshots/alpha-radar.json');
      const alphaTop = alpha?.data?.picks?.top || [];
      const alphaScores = alphaTop.map((p) => `${p.setupScore}-${p.triggerScore}-${p.totalScore}`);
      const alphaInfo = {
        ok: alpha?.ok !== false,
        topCount: alphaTop.length,
        uniqueScores: new Set(alphaScores).size,
        sampleScores: alphaTop.slice(0, 3).map((p) => ({ symbol: p.symbol, setupScore: p.setupScore, triggerScore: p.triggerScore, totalScore: p.totalScore }))
      };

      const marketphase = await fetchJSON('/data/marketphase/index.json');
      const marketphaseInfo = {
        ok: marketphase?.ok !== false,
        symbolsCount: marketphase?.symbols?.length || marketphase?.data?.symbols?.length || 0
      };

      const rvciLatest = await fetchJSON('/data/rvci_latest.json');
      const rvciLatestInfo = {
        ok: rvciLatest?.ok !== false,
        dataKeys: rvciLatest?.data ? Object.keys(rvciLatest.data) : null,
        itemsCount: rvciLatest?.data?.items?.length || 0
      };

    }

    const WORKER_BUDGET_KEY = 'rv_internal_workers_daily_budget';
    const WORKER_USED_KEY = 'rv_internal_workers_used_today';
    const WORKER_LAST_CALLS_KEY = 'rv_internal_workers_last_calls';
    const refreshMetrics = { counting: false, requestCount: 0 };

    function toNumber(value) {
      const num = Number(String(value || '').replace(/[^0-9.]/g, ''));
      return Number.isFinite(num) ? num : 0;
    }

    function getStoredNumber(key) {
      try {
        const raw = window.localStorage.getItem(key);
        return toNumber(raw);
      } catch {
        return 0;
      }
    }

    function setStoredNumber(key, value) {
      try {
        window.localStorage.setItem(key, String(value));
      } catch {}
    }

    function recordRequest() {
      if (!refreshMetrics.counting) return;
      refreshMetrics.requestCount += 1;
    }

    function updateUsageUI() {
      const dailyBudget = getStoredNumber(WORKER_BUDGET_KEY);
      const usedToday = getStoredNumber(WORKER_USED_KEY);
      const remaining = Math.max(dailyBudget - usedToday, 0);
      const lastCalls = getStoredNumber(WORKER_LAST_CALLS_KEY);
      const refreshCalls = lastCalls || refreshMetrics.requestCount || 0;
      const pct = dailyBudget > 0 ? ((refreshCalls / dailyBudget) * 100) : 0;

      const remainingEl = document.getElementById('workers-remaining');
      const costEl = document.getElementById('workers-refresh-cost');
      const pctEl = document.getElementById('workers-refresh-pct');
      const lastCallsEl = document.getElementById('workers-last-calls');
      const dailyInput = document.getElementById('workers-daily-budget');
      const usedInput = document.getElementById('workers-used-today');

      if (remainingEl) remainingEl.textContent = dailyBudget ? `${remaining.toLocaleString()} req` : '‚Äî';
      if (costEl) costEl.textContent = refreshCalls ? `${refreshCalls.toLocaleString()} req` : '‚Äî';
      if (pctEl) pctEl.textContent = dailyBudget ? `${pct.toFixed(2)}%` : '‚Äî';
      if (lastCallsEl) lastCallsEl.textContent = refreshCalls ? refreshCalls.toLocaleString() : '‚Äî';

      if (dailyInput && !dailyInput.value) dailyInput.value = dailyBudget ? String(dailyBudget) : '';
      if (usedInput && !usedInput.value) usedInput.value = usedToday ? String(usedToday) : '';
    }

    const tokenInput = document.getElementById('token-input');
    if (tokenInput) tokenInput.value = INTERNAL_TOKEN || '';
    const applyBtn = document.getElementById('apply-token');
    if (applyBtn && tokenInput) {
      applyBtn.addEventListener('click', async () => {
        setToken(tokenInput.value);
        updateAuthUI();
      });
    }
    const copyBtn = document.getElementById('copy-link');
    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        const u = new URL(window.location.href);
        if (INTERNAL_TOKEN) u.searchParams.set('token', INTERNAL_TOKEN);
        else u.searchParams.delete('token');
        try { await navigator.clipboard.writeText(u.toString()); } catch {}
      });
    }

    const originProdInput = document.getElementById('origin-prod');
    if (originProdInput) {
      const stored = (() => {
        try { return window.localStorage.getItem(PROD_ORIGIN_KEY) || ''; } catch { return ''; }
      })();
      originProdInput.value = String(stored || '').trim();
      originProdInput.addEventListener('change', () => {
        setProdOrigin(originProdInput.value);
      });
    }

    const openThis = document.getElementById('open-this');
    if (openThis) {
      openThis.addEventListener('click', () => {
        const u = new URL('/internal-dashboard', window.location.origin);
        if (INTERNAL_TOKEN) u.searchParams.set('token', INTERNAL_TOKEN);
        window.open(u.toString(), '_blank', 'noreferrer');
      });
    }
    const openProd = document.getElementById('open-prod');
    if (openProd) {
      openProd.addEventListener('click', () => {
        const origin = getProdOrigin();
        if (!origin) return;
        const u = new URL('/internal-dashboard', origin);
        if (INTERNAL_TOKEN) u.searchParams.set('token', INTERNAL_TOKEN);
        window.open(u.toString(), '_blank', 'noreferrer');
      });
    }

    updateAuthUI();

    const loadTargetsBtn = document.getElementById('load-targets');
    if (loadTargetsBtn) {
      loadTargetsBtn.addEventListener('click', async () => {
        await updateTargets();
      });
    }

    const loadBundleBtn = document.getElementById('load-debug-bundle');
    if (loadBundleBtn) {
      loadBundleBtn.addEventListener('click', async () => {
        await updateDebugBundle();
      });
    }
    const loadMatrixBtn = document.getElementById('load-debug-matrix');
    if (loadMatrixBtn) {
      loadMatrixBtn.addEventListener('click', async () => {
        await updateDebugMatrix();
      });
    }

    async function refreshAll() {
      document.body.classList.add('loading');
      refreshMetrics.counting = true;
      refreshMetrics.requestCount = 0;
      await Promise.all([
        updateEndpointProbes(),
        updateHealthOverview(),
        loadDoc('/DEBUG_README.md', 'doc-debug-readme'),
        loadDoc('/RUNBOOK.md', 'doc-runbook'),
        loadDoc('/BLOCK_ANALYSIS.md', 'doc-block-analysis'),
        updateSnapshotFreshness(),
        updateHealthReport(),
        updateBlockMatrix(),
        auditActiveBlocks(),
        updateApiKeys(),
        updateErrorTimeline()
      ]);
      refreshMetrics.counting = false;
      setStoredNumber(WORKER_LAST_CALLS_KEY, refreshMetrics.requestCount);
      updateUsageUI();
      document.body.classList.remove('loading');
    }

    const refreshBtn = document.getElementById('refresh-all');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', refreshAll);
    }

    const dailyInput = document.getElementById('workers-daily-budget');
    if (dailyInput) {
      dailyInput.addEventListener('change', () => {
        setStoredNumber(WORKER_BUDGET_KEY, toNumber(dailyInput.value));
        updateUsageUI();
      });
    }
    const usedInput = document.getElementById('workers-used-today');
    if (usedInput) {
      usedInput.addEventListener('change', () => {
        setStoredNumber(WORKER_USED_KEY, toNumber(usedInput.value));
        updateUsageUI();
      });
    }

    function safeText(value) {
      return String(value ?? '').replace(/[&<>"']/g, (c) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      }[c]));
    }

    function badgeFor(value) {
      const text = String(value || '').toUpperCase();
      const cls = text === 'OK' || text === 'LIVE'
        ? 'ok'
        : text === 'PARTIAL' || text === 'STALE'
          ? 'warn'
          : text === 'EXPECTED'
            ? 'partial'
            : 'fail';
      return `<span class="badge ${cls}">${safeText(text || '‚Äî')}</span>`;
    }

    function ageToLabel(ageMs) {
      if (!Number.isFinite(ageMs) || ageMs < 0) return '‚Äî';
      const minutes = Math.floor(ageMs / 60000);
      if (minutes < 90) return `${minutes}m`;
      const hours = Math.floor(minutes / 60);
      if (hours < 48) return `${hours}h`;
      const days = Math.floor(hours / 24);
      return `${days}d`;
    }

    function freshnessStatus(ageMs, maxHours) {
      if (!Number.isFinite(ageMs) || ageMs < 0) return 'UNKNOWN';
      const hours = ageMs / 3600000;
      if (hours <= maxHours) return 'OK';
      if (hours <= maxHours * 1.5) return 'STALE';
      return 'MISSING';
    }

    async function fetchStaticJson(path) {
      try {
        recordRequest();
        const res = await fetch(path, { cache: 'no-store' });
        if (!res.ok) return { ok: false, status: res.status };
        const json = await res.json();
        return { ok: true, json };
      } catch (err) {
        return { ok: false, status: 0, error: String(err?.message || err || '') };
      }
    }

    async function updateSnapshotFreshness() {
      const tbody = document.querySelector('#snapshot-freshness tbody');
      if (!tbody) return;
      const now = Date.now();
      const snapshots = [
        { label: 'Market Cockpit', path: '/data/snapshots/market-cockpit.json', maxHours: 36 },
        { label: 'S&P 500 Sectors', path: '/data/snapshots/sp500-sectors.json', maxHours: 36 },
        { label: 'Tech Signals', path: '/data/snapshots/tech-signals.json', maxHours: 36 },
        { label: 'Alpha Radar', path: '/data/snapshots/alpha-radar.json', maxHours: 36 },
        { label: 'News Headlines', path: '/data/snapshots/news-headlines.json', maxHours: 6 },
        { label: 'RVCI Latest', path: '/data/rvci_latest.json', maxHours: 36 }
      ];

      const rows = await Promise.all(
        snapshots.map(async (snap) => {
          const res = await fetchStaticJson(snap.path);
          const payload = res.ok ? res.json : {};
          const updatedAt =
            payload.updatedAt ||
            payload.generatedAt ||
            payload.asOf ||
            payload.meta?.generatedAt ||
            payload.meta?.dataAsOf ||
            null;
          const updatedMs = updatedAt ? Date.parse(updatedAt) : NaN;
          const ageMs = Number.isFinite(updatedMs) ? now - updatedMs : NaN;
          const status = freshnessStatus(ageMs, snap.maxHours);
          const statusClass = status === 'OK' ? 'ok' : status === 'STALE' ? 'warn' : 'fail';
          return `
            <tr>
              <td>${safeText(snap.label)}</td>
              <td><code>${safeText(snap.path)}</code></td>
              <td>${updatedAt ? new Date(updatedAt).toLocaleString() : '‚Äî'}</td>
              <td>${ageToLabel(ageMs)}</td>
              <td><span class="badge ${statusClass}">${status}</span></td>
            </tr>
          `;
        })
      );

      tbody.innerHTML = rows.join('') || '<tr><td colspan="5">No snapshots found</td></tr>';
    }

    async function updateHealthReport() {
      const tbody = document.querySelector('#health-report-table tbody');
      const summaryEl = document.getElementById('health-report-summary');
      const ts = document.getElementById('health-report-timestamp');
      const noteEl = document.getElementById('health-report-note');
      const selector = document.getElementById('health-report-block');
      const fieldsBody = document.querySelector('#health-report-fields tbody');
      if (!tbody || !summaryEl || !selector || !fieldsBody) return;

      const report = await fetchJSON('/data/system-health.json');
      if (!report || report.ok === false) {
        tbody.innerHTML = '<tr><td colspan="9">No data available</td></tr>';
        if (ts) ts.textContent = `Last updated: ${new Date().toLocaleString()}`;
        if (noteEl) noteEl.textContent = 'Block status: unavailable (static snapshot missing).';
        return;
      }

      const blocks = Array.isArray(report.snapshots) ? report.snapshots : [];
      const summary = report.summary || {};
      const okBlocks = summary.ok ?? 0;
      const badBlocks = summary.fail ?? 0;
      const totalBlocks = summary.total ?? blocks.length;
      const score = report.buildStatus || '‚Äî';

      if (noteEl) {
        noteEl.textContent = `Block status: OK ${okBlocks} ¬∑ BAD ${badBlocks} ¬∑ TOTAL ${totalBlocks}`;
      }
      summaryEl.innerHTML = `
        <div class="status-card"><h3>Build Status</h3><div class="value">${safeText(score)}</div><div class="label">static pipeline</div></div>
        <div class="status-card ok"><h3>OK</h3><div class="value">${safeText(okBlocks)}</div><div class="label">Blocks</div></div>
        <div class="status-card fail"><h3>BAD</h3><div class="value">${safeText(badBlocks)}</div><div class="label">Blocks</div></div>
        <div class="status-card"><h3>Total</h3><div class="value">${safeText(totalBlocks)}</div><div class="label">Blocks</div></div>
      `;

      tbody.innerHTML = blocks.map((b) => {
        const blockId = b.blockId || b.block || '‚Äî';
        return `
          <tr>
            <td><code>${safeText(blockId)}</code></td>
            <td><code>${safeText(blockId)}</code></td>
            <td>${badgeFor(b.status || '‚Äî')}</td>
            <td><code>${safeText(`/data/snapshots/${blockId}.json`)}</code></td>
            <td>${badgeFor(b.status || '‚Äî')}</td>
            <td><code style="font-size: 11px;">${safeText(b.reason || '‚Äî')}</code></td>
            <td>0</td>
            <td>‚Äî</td>
            <td>‚Äî</td>
          </tr>
        `;
      }).join('');

      selector.innerHTML = '<option value="">Field details not available in static mode.</option>';
      selector.onchange = () => {
        fieldsBody.innerHTML = '<tr><td colspan="6">Field contract is not stored in static snapshots.</td></tr>';
      };
      if (ts) ts.textContent = `Last updated: ${new Date().toLocaleString()}`;
    }

    async function updateDebugMatrix() {
      const tbody = document.querySelector('#debug-matrix-table tbody');
      const ts = document.getElementById('debug-matrix-timestamp');
      if (!tbody) return;

      const res = await fetchJSON('/data/provider-state.json');
      const providers = res?.providers || {};
      const rows = Object.entries(providers).map(([providerId, entry]) => {
        const status = entry.circuitState || 'unknown';
        const statusClass = status === 'closed' ? 'ok' : status === 'half_open' ? 'warn' : 'fail';
        const locks = Array.isArray(entry.locks) ? entry.locks.length : 0;
        const lastSeen = entry.lastSeen || entry.updatedAt || '‚Äî';
        return `
          <tr>
            <td><code>${safeText(providerId)}</code></td>
            <td><code>${safeText(`${locks} locks`)}</code></td>
            <td><span class="badge ${statusClass}">${safeText(status)}</span></td>
            <td><code style="font-size:11px;">${safeText(entry.lastReason || '‚Äî')}</code></td>
            <td>${safeText(lastSeen)}</td>
          </tr>
        `;
      });
      tbody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="5">No data available</td></tr>';
      if (ts) ts.textContent = `Last updated: ${new Date().toLocaleString()}`;
    }

    async function probeEndpoint(path) {
      try {
        const res = await fetch(withToken(path), {
          method: 'GET',
          headers: { Accept: 'application/json' },
          cache: 'no-store'
        });
        return { ok: res.ok, status: res.status };
      } catch (err) {
        return { ok: false, status: 0 };
      }
    }

    async function updateEndpointProbes() {
      const tbody = document.querySelector('#endpoint-probes tbody');
      if (!tbody) return;

      const targets = [
        { path: '/data/system-health.json', hint: 'Static build health snapshot' },
        { path: '/data/provider-state.json', hint: 'Circuit + lock state' },
        { path: '/data/usage-report.json', hint: 'Budget usage and remaining' }
      ];

      const results = await Promise.all(targets.map(async (t) => ({
        ...t,
        result: await probeEndpoint(t.path)
      })));

      tbody.innerHTML = results.map((row) => {
        const status = row.result.status;
        const statusClass = row.result.ok ? 'ok' : status === 404 ? 'warn' : 'fail';
        const label = row.result.ok ? `OK (${status})` : status ? `FAIL (${status})` : 'FAIL (network)';
        return `
          <tr>
            <td><code>${row.path}</code></td>
            <td><span class="badge ${statusClass}">${label}</span></td>
            <td>${row.hint}</td>
          </tr>
        `;
      }).join('');
    }

    async function updateHealthOverview() {
      const health = await fetchJSON('/data/system-health.json');
      const usage = await fetchJSON('/data/usage-report.json');

      const container = document.getElementById('health-overview');
      if (!health || health.ok === false) {
        container.innerHTML = '<div class="status-card fail"><h3>Error</h3><div class="value">Failed</div><div class="label">Cannot fetch health data</div></div>';
        return;
      }

      const summary = health.summary || {};
      const providers = usage?.providers || {};
      const remainingPcts = Object.values(providers)
        .map((entry) => entry?.daily?.pctRemaining)
        .filter((value) => typeof value === 'number');
      const worstPct = remainingPcts.length ? Math.min(...remainingPcts) : null;
      const budgetLabel = worstPct === null ? '‚Äî' : `${(worstPct * 100).toFixed(1)}%`;

      const overallStatus = health.buildStatus || 'UNKNOWN';
      const statusClass = overallStatus === 'OK' ? 'ok' : overallStatus === 'WARN' ? 'warn' : 'fail';

      const lastBuildAt = health.generatedAt ? new Date(health.generatedAt).toLocaleString() : '‚Äî';

      container.innerHTML = `
        <div class="status-card ${statusClass}">
          <h3>Overall Status</h3>
          <div class="value">${overallStatus}</div>
          <div class="label">Static snapshot pipeline</div>
        </div>
        <div class="status-card">
          <h3>Blocks Active</h3>
          <div class="value">${summary.ok || 0}</div>
          <div class="label">of ${summary.total || 0} total</div>
        </div>
        <div class="status-card">
          <h3>Budget Remaining</h3>
          <div class="value">${budgetLabel}</div>
          <div class="label">Worst daily provider</div>
        </div>
        <div class="status-card">
          <h3>Last Build</h3>
          <div class="value">${lastBuildAt}</div>
          <div class="label">system-health</div>
        </div>
      `;

      document.getElementById('health-timestamp').textContent = `Last updated: ${new Date().toLocaleString()}`;
    }

    async function updateDebugBundle() {
      const health = await fetchJSON('/data/system-health.json');
      const errors = await fetchJSON('/data/error-summary.json');
      const container = document.getElementById('debug-summary');
      const ts = document.getElementById('debug-timestamp');
      const attemptsBody = document.querySelector('#debug-attempts tbody');
      const eventsBody = document.querySelector('#recent-events tbody');

      if (!container || !attemptsBody || !eventsBody) return;

      if (!health || health.ok === false) {
        container.innerHTML = '<div class="status-card fail"><h3>Bundle Status</h3><div class="value">ERROR</div><div class="label">system-health unavailable</div></div>';
        attemptsBody.innerHTML = '<tr><td colspan="5">No data available</td></tr>';
        eventsBody.innerHTML = '<tr><td colspan="6">No data available</td></tr>';
        if (ts) ts.textContent = `Last updated: ${new Date().toLocaleString()}`;
        return;
      }

      const summary = health.summary || {};

      container.innerHTML = `
        <div class="status-card">
          <h3>Build Run</h3>
          <div class="value">${safeText(health.runId || '‚Äî')}</div>
          <div class="label">system-health</div>
        </div>
        <div class="status-card">
          <h3>Status</h3>
          <div class="value">${safeText(health.buildStatus || '‚Äî')}</div>
          <div class="label">build status</div>
        </div>
        <div class="status-card">
          <h3>Snapshots OK</h3>
          <div class="value">${safeText(summary.ok ?? 0)}</div>
          <div class="label">of ${safeText(summary.total ?? 0)}</div>
        </div>
        <div class="status-card">
          <h3>Errors</h3>
          <div class="value">${safeText(summary.fail ?? 0)}</div>
          <div class="label">snapshot failures</div>
        </div>
      `;

      const errorItems = Array.isArray(errors?.items) ? errors.items : [];
      attemptsBody.innerHTML = errorItems.length
        ? errorItems.slice(0, 50).map((e) => `
            <tr>
              <td>${e.lastSeenAt ? new Date(e.lastSeenAt).toLocaleString() : '‚Äî'}</td>
              <td><code>${safeText(e.dataset || '‚Äî')}</code></td>
              <td>${badgeFor(e.severity || 'UNKNOWN')}</td>
              <td><code style="font-size: 11px;">${safeText(e.code || '‚Äî')}</code></td>
              <td><code style="font-size: 11px;">${safeText(e.message || '‚Äî')}</code></td>
            </tr>
          `).join('')
        : '<tr><td colspan="5">No errors recorded</td></tr>';

      eventsBody.innerHTML = errorItems.length
        ? errorItems.slice(0, 120).map((e) => `
            <tr>
              <td>${e.lastSeenAt ? new Date(e.lastSeenAt).toLocaleString() : '‚Äî'}</td>
              <td><code>${safeText(e.provider || '‚Äî')}</code></td>
              <td>‚Äî</td>
              <td>${badgeFor(e.severity || 'UNKNOWN')}</td>
              <td><code style="font-size: 11px;">${safeText(e.code || '‚Äî')}</code></td>
              <td><code style="font-size: 11px;">${safeText(e.runId || '‚Äî')}</code></td>
            </tr>
          `).join('')
        : '<tr><td colspan="6">No recent errors</td></tr>';

      if (ts) ts.textContent = `Last updated: ${new Date().toLocaleString()}`;
    }

    async function updateBlockMatrix() {
      const diag = await fetchJSON('/data/system-health.json');
      const tbody = document.querySelector('#block-matrix tbody');
      
      const blocks = Array.isArray(diag?.snapshots) ? diag.snapshots : [];
      if (!diag || diag.ok === false || !blocks.length) {
        tbody.innerHTML = '<tr><td colspan="9">No data available</td></tr>';
        return;
      }

      tbody.innerHTML = blocks.map(block => {
        const statusClass = block.status === 'OK' ? 'ok' : block.status === 'WARN' ? 'warn' : 'fail';
        const blockId = block.blockId || block.block || '‚Äî';
        const asOf = diag?.lastGoodAsOf?.[blockId] || '‚Äî';
        return `
          <tr>
            <td>${blockId}</td>
            <td><code>${blockId}</code></td>
            <td><span class="badge ${statusClass}">${block.status || 'UNKNOWN'}</span></td>
            <td>${block.status === 'OK' ? '‚úÖ' : '‚ùå'}</td>
            <td><span class="badge ${statusClass}">${block.status || 'UNKNOWN'}</span></td>
            <td>${asOf !== '‚Äî' ? new Date(asOf).toLocaleString() : '‚Äî'}</td>
            <td>${block.source || 'mirror'}</td>
            <td>static</td>
            <td><code style="font-size: 11px;">${block.reason || '‚Äî'}</code></td>
          </tr>
        `;
      }).join('');
    }

    async function updateApiKeys() {
      const diag = await fetchJSON('/data/usage-report.json');
      const tbody = document.querySelector('#api-keys tbody');

      const keys = diag?.providers || {};
      const cloudflare = diag?.cloudflare || {};
      
      if (!diag || diag.ok === false || !keys || !Object.keys(keys).length) {
        tbody.innerHTML = '<tr><td colspan="14">No API key data available</td></tr>';
        return;
      }

      const rows = Object.entries(keys).map(([providerId, key]) => {
        const statusClass = key.status === 'red' ? 'fail' : key.status === 'yellow' ? 'warn' : 'ok';
        const dailyPct = typeof key.daily?.pctRemaining === 'number' ? ` (${(key.daily.pctRemaining * 100).toFixed(1)}%)` : '';
        const monthlyPct = typeof key.monthly?.pctRemaining === 'number' ? ` (${(key.monthly.pctRemaining * 100).toFixed(1)}%)` : '';
        return `
          <tr>
            <td>${providerId}</td>
            <td><code>‚Äî</code></td>
            <td><span class="badge ${statusClass}">${key.status || 'UNKNOWN'}</span></td>
            <td>${key.daily?.used ?? 0}</td>
            <td>‚Äî</td>
            <td>${key.monthly?.used ?? '‚Äî'}</td>
            <td>${key.daily?.limit ?? '‚Äî'}</td>
            <td>${key.daily?.remaining ?? '‚Äî'}${dailyPct}</td>
            <td>‚Äî</td>
            <td>${key.monthly?.remaining ?? '‚Äî'}${monthlyPct}</td>
            <td>‚Äî</td>
            <td><code style="font-size: 11px;">‚Äî</code></td>
            <td>‚Äî</td>
            <td style="max-width: 260px;">Static budget snapshot</td>
            <td style="max-width: 260px;">Reduce ingestion if near red.</td>
          </tr>
        `;
      });

      if (cloudflare?.daily || cloudflare?.monthly) {
        const cfDailyPct = typeof cloudflare.daily?.pctRemaining === 'number' ? ` (${(cloudflare.daily.pctRemaining * 100).toFixed(1)}%)` : '';
        const cfMonthlyPct = typeof cloudflare.monthly?.pctRemaining === 'number' ? ` (${(cloudflare.monthly.pctRemaining * 100).toFixed(1)}%)` : '';
        rows.unshift(`
          <tr>
            <td>cloudflare</td>
            <td><code>‚Äî</code></td>
            <td><span class="badge ok">STATIC</span></td>
            <td>${cloudflare.daily?.used ?? 0}</td>
            <td>‚Äî</td>
            <td>${cloudflare.monthly?.used ?? '‚Äî'}</td>
            <td>${cloudflare.daily?.limit ?? '‚Äî'}</td>
            <td>${cloudflare.daily?.remaining ?? '‚Äî'}${cfDailyPct}</td>
            <td>‚Äî</td>
            <td>${cloudflare.monthly?.remaining ?? '‚Äî'}${cfMonthlyPct}</td>
            <td>‚Äî</td>
            <td><code style="font-size: 11px;">‚Äî</code></td>
            <td>‚Äî</td>
            <td style="max-width: 260px;">Cloudflare free tier budget</td>
            <td style="max-width: 260px;">Reduce refresh if near limit.</td>
          </tr>
        `);
      }

      tbody.innerHTML = rows.join('');
    }

    async function updateErrorTimeline() {
      const diag = await fetchJSON('/data/error-summary.json');
      const tbody = document.querySelector('#error-timeline tbody');

      const events = Array.isArray(diag?.items) ? diag.items : [];
      
      if (!diag || diag.ok === false || !events.length) {
        tbody.innerHTML = '<tr><td colspan="6">No events available</td></tr>';
        return;
      }

      tbody.innerHTML = events.slice(0, 50).map(event => {
        const typeClass = event.severity === 'error' ? 'fail' : event.severity === 'warn' ? 'warn' : 'ok';
        return `
          <tr>
            <td>${event.lastSeenAt ? new Date(event.lastSeenAt).toLocaleString() : '‚Äî'}</td>
            <td><span class="badge ${typeClass}">${event.severity || 'info'}</span></td>
            <td><code>${event.dataset || '‚Äî'}</code></td>
            <td><code>${event.code || '‚Äî'}</code></td>
            <td>${event.message || '‚Äî'}</td>
            <td><code style="font-size: 11px;">${safeText(event.provider || '‚Äî')}</code></td>
          </tr>
        `;
      }).join('');
    }

    updateUsageUI();
  </script>
</body>
</html>
