<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RubikVault Internal Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0b1120;
      color: #f8fafc;
      line-height: 1.6;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 { margin-bottom: 30px; color: #38bdf8; }
    .banner {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .banner-left {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .banner-right {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .token-input {
      background: #111827;
      color: #f8fafc;
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 8px 10px;
      min-width: 360px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }
    .section {
      background: #111827;
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .section h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #38bdf8;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      padding-bottom: 10px;
    }
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .status-card {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 15px;
    }
    .status-card.ok { border-color: #10b981; }
    .status-card.warn { border-color: #f59e0b; }
    .status-card.fail { border-color: #ef4444; }
    .status-card h3 {
      font-size: 12px;
      text-transform: uppercase;
      color: #cbd5f5;
      margin-bottom: 8px;
    }
    .status-card .value {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .status-card .label {
      font-size: 11px;
      color: #94a3b8;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
    }
    th {
      background: rgba(15, 23, 42, 0.6);
      font-weight: 600;
      color: #cbd5f5;
      position: sticky;
      top: 0;
    }
    tr:hover { background: rgba(15, 23, 42, 0.4); }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge.ok { background: #10b981; color: white; }
    .badge.warn { background: #f59e0b; color: white; }
    .badge.fail { background: #ef4444; color: white; }
    .badge.partial { background: #3b82f6; color: white; }
    .badge.stale { background: #8b5cf6; color: white; }
    .refresh-btn {
      background: #38bdf8;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      margin-bottom: 15px;
    }
    .usage-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 14px;
      align-items: center;
      margin-bottom: 12px;
      color: #cbd5f5;
      font-size: 12px;
    }
    .usage-panel label {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #94a3b8;
    }
    .usage-panel input {
      background: #0f172a;
      color: #f8fafc;
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 6px;
      padding: 6px 8px;
      width: 140px;
      font-size: 12px;
    }
    .usage-metric strong { color: #f8fafc; }
    .refresh-btn:hover { background: #0ea5e9; }
    .secondary-btn {
      background: rgba(15, 23, 42, 0.6);
      color: #f8fafc;
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    .secondary-btn:hover { border-color: rgba(56, 189, 248, 0.6); }
    a { color: #38bdf8; text-decoration: none; }
    a:hover { text-decoration: underline; }
    code { color: #cbd5f5; }
    pre {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.15);
      border-radius: 10px;
      padding: 12px;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: #e2e8f0;
      max-height: 360px;
      overflow: auto;
    }
    .split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px) {
      .split { grid-template-columns: 1fr; }
      .token-input { min-width: 260px; }
    }
    .timestamp {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 10px;
    }
    .loading { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç RubikVault Internal Dashboard <span id="rv-internal-auth" class="badge warn">auth: unknown</span></h1>

    <div class="banner" id="auth-banner">
      <div class="banner-left">
        <span id="auth-banner-badge" class="badge warn">token missing</span>
        <span style="color:#cbd5f5; font-size: 13px;">Internal endpoints need <code>RV_INTERNAL_TOKEN</code>. Without it, many calls intentionally return <code>404</code>.</span>
      </div>
      <div class="banner-right">
        <input id="token-input" class="token-input" placeholder="Paste token here (stored in localStorage)" />
        <button class="secondary-btn" id="apply-token">Apply</button>
        <button class="secondary-btn" id="copy-link">Copy link</button>
      </div>
    </div>
    
    <div class="section">
      <h2>Endpoint Reachability</h2>
      <div style="overflow-x: auto;">
        <table id="endpoint-probes">
          <thead>
            <tr>
              <th>Endpoint</th>
              <th>Status</th>
              <th>Hint</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="3">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>System Health Overview</h2>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px;">
        <button class="refresh-btn" id="refresh-all">üîÑ Refresh All</button>
        <span class="usage-metric">Workers left today: <strong id="workers-remaining">‚Äî</strong></span>
        <span class="usage-metric">One refresh uses: <strong id="workers-refresh-cost">‚Äî</strong> (<span id="workers-refresh-pct">‚Äî</span>)</span>
        <span class="usage-metric">Last refresh calls: <strong id="workers-last-calls">‚Äî</strong></span>
      </div>
      <div class="usage-panel">
        <label>Daily budget
          <input id="workers-daily-budget" type="number" min="0" step="1" placeholder="e.g. 100000" />
        </label>
        <label>Used today
          <input id="workers-used-today" type="number" min="0" step="1" placeholder="e.g. 1200" />
        </label>
        <span style="color:#94a3b8;">Manual estimate. Stored locally.</span>
      </div>
      <div class="status-grid" id="health-overview">
        <div class="status-card">
          <h3>Overall Status</h3>
          <div class="value">‚Äî</div>
          <div class="label">Loading...</div>
        </div>
      </div>
      <div class="timestamp" id="health-timestamp"></div>
    </div>

    <div class="section">
      <h2>Targets (Preview + Prod)</h2>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
        <span class="badge" style="background:rgba(56,189,248,0.15);color:#cbd5f5;border:1px solid rgba(56,189,248,0.25);">same-origin preferred</span>
        <span style="color:#94a3b8;font-size:12px;">Cross-origin fetch may be blocked unless CORS is enabled.</span>
        <button class="secondary-btn" id="load-targets">Load Targets</button>
        <span style="color:#94a3b8;font-size:12px;">Request-heavy. Load only when needed.</span>
      </div>
      <div class="split">
        <div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <strong style="color:#cbd5f5;">This origin</strong>
            <code id="origin-this">‚Äî</code>
            <button class="secondary-btn" id="open-this">Open</button>
          </div>
          <div class="timestamp" id="targets-this-status">‚Äî</div>
          <pre id="targets-this" style="max-height:240px;">Loading...</pre>
        </div>
        <div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <strong style="color:#cbd5f5;">Prod origin</strong>
            <input id="origin-prod" class="token-input" style="min-width:260px;" placeholder="https://rubikvault.com" />
            <button class="secondary-btn" id="open-prod">Open</button>
          </div>
          <div class="timestamp" id="targets-prod-status">‚Äî</div>
          <pre id="targets-prod" style="max-height:240px;">Set prod origin and refresh.</pre>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Debug Bundle (Consolidated)</h2>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
        <button class="secondary-btn" id="load-debug-bundle">Load Debug Bundle</button>
        <span style="color:#94a3b8;font-size:12px;">KV-heavy. Load only when needed.</span>
      </div>
      <div class="status-grid" id="debug-summary">
        <div class="status-card">
          <h3>Bundle Status</h3>
          <div class="value">‚Äî</div>
          <div class="label">Loading...</div>
        </div>
      </div>
      <div class="timestamp" id="debug-timestamp"></div>
      <div style="overflow-x: auto; margin-top: 12px;">
        <table id="debug-attempts">
          <thead>
            <tr>
              <th>Target</th>
              <th>OK</th>
              <th>Status</th>
              <th>Reason</th>
              <th>Snippet</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="5">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div style="max-height: 320px; overflow-y: auto; margin-top: 12px;">
        <table id="recent-events">
          <thead>
            <tr>
              <th>Time</th>
              <th>Feature</th>
              <th>HTTP</th>
              <th>Quality</th>
              <th>Error</th>
              <th>Trace</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="6">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>Client Debug Tools</h2>
      <div style="display:grid;gap:10px;">
        <div>
          <span class="badge" style="background:rgba(16,185,129,0.15);color:#cbd5f5;border:1px solid rgba(16,185,129,0.25);">Enable</span>
          <span style="color:#cbd5f5;font-size:13px;">Open any public page with <code>?debug=1</code> or set <code>localStorage.debug="true"</code>.</span>
        </div>
        <div>
          <span style="color:#cbd5f5;font-size:13px;">Debug assets (static):</span>
          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:6px;">
            <a href="/debug/rv-debug-console.js" target="_blank" rel="noreferrer">/debug/rv-debug-console.js</a>
            <a href="/debug/panel.js" target="_blank" rel="noreferrer">/debug/panel.js</a>
            <a href="/debug/diagnostics.js" target="_blank" rel="noreferrer">/debug/diagnostics.js</a>
            <a href="/debug/rv-debug.js" target="_blank" rel="noreferrer">/debug/rv-debug.js</a>
            <a href="/diagnose.js" target="_blank" rel="noreferrer">/diagnose.js</a>
          </div>
        </div>
        <div>
          <span style="color:#94a3b8;font-size:12px;">If you see <code>Config missing - API disabled</code>, check <code>window.RV_CONFIG.apiBase</code> and the config loader.</span>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Docs (Runbook + Debug + Block Analysis)</h2>
      <div style="display:grid;gap:10px;">
        <details open>
          <summary style="cursor:pointer;color:#cbd5f5;">DEBUG_README.md</summary>
          <pre id="doc-debug-readme">Loading...</pre>
        </details>
        <details>
          <summary style="cursor:pointer;color:#cbd5f5;">RUNBOOK.md</summary>
          <pre id="doc-runbook">Loading...</pre>
        </details>
        <details>
          <summary style="cursor:pointer;color:#cbd5f5;">BLOCK_ANALYSIS.md</summary>
          <pre id="doc-block-analysis">Loading...</pre>
        </details>
      </div>
    </div>

    <div class="section">
      <h2>Block Verification (Server)</h2>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
        <span class="badge" style="background:rgba(56,189,248,0.15);color:#cbd5f5;border:1px solid rgba(56,189,248,0.25);">/api/health-report</span>
        <span style="color:#94a3b8;font-size:12px;">Checks each block endpoint and validates required fields. Use this to find "fetched ok" but "render empty" cases.</span>
      </div>
      <div class="status-grid" id="health-report-summary">
        <div class="status-card"><h3>Health Score</h3><div class="value">‚Äî</div><div class="label">Loading...</div></div>
        <div class="status-card"><h3>OK</h3><div class="value">‚Äî</div><div class="label">Blocks</div></div>
        <div class="status-card"><h3>PARTIAL</h3><div class="value">‚Äî</div><div class="label">Blocks</div></div>
        <div class="status-card"><h3>BAD</h3><div class="value">‚Äî</div><div class="label">Blocks</div></div>
      </div>
      <div class="timestamp" id="health-report-timestamp"></div>
      <div style="overflow-x:auto; margin-top: 12px;">
        <table id="health-report-table">
          <thead>
            <tr>
              <th>Block</th>
              <th>Feature</th>
              <th>State</th>
              <th>Endpoint</th>
              <th>Status</th>
              <th>Reason</th>
              <th>Invalid Fields</th>
              <th>Circuit</th>
              <th>Error</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="9">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div style="margin-top: 12px;">
        <select id="health-report-block" style="width: 100%; padding: 8px; margin-bottom: 10px; background: #111827; color: #f8fafc; border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px;">
          <option value="">Select a block for field details...</option>
        </select>
        <div style="overflow-x:auto;">
          <table id="health-report-fields">
            <thead>
              <tr>
                <th>Field</th>
                <th>Path</th>
                <th>Required</th>
                <th>Valid</th>
                <th>Reason</th>
                <th>Fix</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6">Select a block above...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Debug Matrix (KV / Mirrors)</h2>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
        <span class="badge" style="background:rgba(16,185,129,0.15);color:#cbd5f5;border:1px solid rgba(16,185,129,0.25);">/api/debug-matrix</span>
        <button class="secondary-btn" id="load-debug-matrix">Load Debug Matrix</button>
        <span style="color:#94a3b8;font-size:12px;">Reads mirror:*:latest keys (capped) to show which blocks have lastGood/mirror coverage.</span>
      </div>
      <div class="timestamp" id="debug-matrix-timestamp"></div>
      <div style="overflow-x:auto;">
        <table id="debug-matrix-table">
          <thead>
            <tr>
              <th>Feature</th>
              <th>Endpoint</th>
              <th>Status</th>
              <th>Empty Reason</th>
              <th>Last Update</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="5">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>Block √ó Field Matrix</h2>
      <div style="overflow-x: auto;">
        <table id="block-matrix">
          <thead>
            <tr>
              <th>Block</th>
              <th>Feature ID</th>
              <th>Status</th>
              <th>Data Present</th>
              <th>Quality</th>
              <th>As-of</th>
              <th>Source</th>
              <th>Cache</th>
              <th>Last Error</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="9">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>API Keys & Limits</h2>
      <table id="api-keys">
        <thead>
          <tr>
            <th>Provider</th>
            <th>Key Alias</th>
            <th>Status</th>
            <th>Counts (Today)</th>
            <th>Counts (Week)</th>
            <th>Counts (Month)</th>
            <th>Hard Limit</th>
            <th>Remaining</th>
            <th>Remaining (Week)</th>
            <th>Remaining (Month)</th>
            <th>Burn/Hour</th>
            <th>Last Error</th>
            <th>Last Used</th>
            <th>Hint</th>
            <th>Recommended Action</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="14">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="section">
      <h2>Error & Events Timeline</h2>
      <div style="max-height: 400px; overflow-y: auto;">
        <table id="error-timeline">
          <thead>
            <tr>
              <th>Time</th>
              <th>Type</th>
              <th>Feature</th>
              <th>Error Code</th>
              <th>Message</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="6">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>Field Drilldown</h2>
      <select id="field-selector" style="width: 100%; padding: 8px; margin-bottom: 15px; background: #111827; color: #f8fafc; border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px;">
        <option>Select a field to inspect...</option>
      </select>
      <div id="field-details" style="background: rgba(15, 23, 42, 0.6); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
        Select a field above to see details...
      </div>
    </div>
  </div>

  <script type="module">
    const API_BASE = '/api';
    const TOKEN_STORAGE_KEY = 'rv_internal_token';
    const PROD_ORIGIN_KEY = 'rv_internal_prod_origin';
    const urlParams = new URLSearchParams(window.location.search);
    const urlToken = urlParams.get('token') || '';
    const storedToken = (() => {
      try { return window.localStorage.getItem(TOKEN_STORAGE_KEY) || ''; } catch { return ''; }
    })();
    let INTERNAL_TOKEN = urlToken || storedToken || '';

    const withToken = (url) => {
      if (!INTERNAL_TOKEN) return url;
      const u = new URL(url, window.location.origin);
      u.searchParams.set('token', INTERNAL_TOKEN);
      return u.pathname + u.search;
    };

    function setToken(nextToken) {
      INTERNAL_TOKEN = String(nextToken || '').trim();
      try {
        if (INTERNAL_TOKEN) window.localStorage.setItem(TOKEN_STORAGE_KEY, INTERNAL_TOKEN);
        else window.localStorage.removeItem(TOKEN_STORAGE_KEY);
      } catch {}
    }

    function updateAuthUI() {
      const authEl = document.getElementById('rv-internal-auth');
      if (authEl) {
        if (INTERNAL_TOKEN) {
          authEl.textContent = 'auth: token';
          authEl.className = 'badge ok';
        } else {
          authEl.textContent = 'auth: none';
          authEl.className = 'badge warn';
        }
      }

      const bannerBadge = document.getElementById('auth-banner-badge');
      if (bannerBadge) {
        if (INTERNAL_TOKEN) {
          bannerBadge.textContent = 'token set';
          bannerBadge.className = 'badge ok';
        } else {
          bannerBadge.textContent = 'token missing';
          bannerBadge.className = 'badge warn';
        }
      }
    }

    function getProdOrigin() {
      const input = document.getElementById('origin-prod');
      const fromInput = input ? String(input.value || '').trim() : '';
      if (fromInput) return fromInput.replace(/\/$/, '');
      try {
        const stored = window.localStorage.getItem(PROD_ORIGIN_KEY) || '';
        return String(stored || '').trim().replace(/\/$/, '');
      } catch {
        return '';
      }
    }

    function setProdOrigin(origin) {
      const clean = String(origin || '').trim().replace(/\/$/, '');
      try {
        if (clean) window.localStorage.setItem(PROD_ORIGIN_KEY, clean);
        else window.localStorage.removeItem(PROD_ORIGIN_KEY);
      } catch {}
    }

    function withTokenTo(origin, path) {
      const u = new URL(path, origin);
      if (INTERNAL_TOKEN) u.searchParams.set('token', INTERNAL_TOKEN);
      return u.toString();
    }

    async function fetchJSONFromOrigin(origin, path) {
      try {
        recordRequest();
        const res = await fetch(withTokenTo(origin, path), { headers: { Accept: 'application/json' } });
        const text = await res.text();
        if (!res.ok) return { ok: false, status: res.status, text };
        try { return JSON.parse(text); } catch { return { ok: false, status: res.status, text }; }
      } catch (err) {
        return { ok: false, status: 0, text: String(err?.message || err || '') };
      }
    }

    async function updateTargets() {
      const originThisEl = document.getElementById('origin-this');
      const preThis = document.getElementById('targets-this');
      const preProd = document.getElementById('targets-prod');
      const stThis = document.getElementById('targets-this-status');
      const stProd = document.getElementById('targets-prod-status');

      const originThis = window.location.origin;
      if (originThisEl) originThisEl.textContent = originThis;

      const thisHealth = await fetchJSONFromOrigin(originThis, '/api/health');
      const thisDiag = await fetchJSONFromOrigin(originThis, '/api/diag');
      const thisBundle = await fetchJSONFromOrigin(originThis, '/api/debug-bundle');
      const thisSummary = {
        origin: originThis,
        health: thisHealth?.ok ? (thisHealth.data || {}) : { error: thisHealth },
        diag: thisDiag?.ok ? (thisDiag.data || {}) : { error: thisDiag },
        debugBundle: thisBundle?.ok ? (thisBundle.data?.summary || {}) : { error: thisBundle }
      };
      if (preThis) preThis.textContent = JSON.stringify(thisSummary, null, 2);
      if (stThis) stThis.textContent = `Updated: ${new Date().toLocaleString()}`;

      const prodOrigin = getProdOrigin();
      if (!prodOrigin) {
        if (preProd) preProd.textContent = 'Set prod origin and refresh.';
        if (stProd) stProd.textContent = '‚Äî';
        return;
      }
      setProdOrigin(prodOrigin);

      const prodHealth = await fetchJSONFromOrigin(prodOrigin, '/api/health');
      const prodDiag = await fetchJSONFromOrigin(prodOrigin, '/api/diag');
      const prodBundle = await fetchJSONFromOrigin(prodOrigin, '/api/debug-bundle');
      const prodSummary = {
        origin: prodOrigin,
        health: prodHealth?.ok ? (prodHealth.data || {}) : { error: prodHealth },
        diag: prodDiag?.ok ? (prodDiag.data || {}) : { error: prodDiag },
        debugBundle: prodBundle?.ok ? (prodBundle.data?.summary || {}) : { error: prodBundle }
      };
      if (preProd) preProd.textContent = JSON.stringify(prodSummary, null, 2);
      if (stProd) {
        const maybeCors = prodHealth?.status === 0 || prodDiag?.status === 0 || prodBundle?.status === 0;
        stProd.textContent = maybeCors
          ? `Updated: ${new Date().toLocaleString()} (note: status 0 may indicate CORS blocked)`
          : `Updated: ${new Date().toLocaleString()}`;
      }
    }

    async function loadDoc(path, targetId) {
      const el = document.getElementById(targetId);
      if (!el) return;
      try {
        recordRequest();
        const res = await fetch(path, { cache: 'no-store' });
        if (!res.ok) {
          el.textContent = `Failed to load ${path} (HTTP ${res.status})`;
          return;
        }
        const text = await res.text();
        el.textContent = text;
      } catch (err) {
        el.textContent = `Failed to load ${path}: ${String(err?.message || err || '')}`;
      }
    }

    async function fetchJSON(url) {
      try {
        recordRequest();
        const res = await fetch(withToken(url), { headers: { Accept: 'application/json' } });
        const text = await res.text();
        if (!res.ok) {
          return { ok: false, status: res.status, text };
        }
        try {
          return JSON.parse(text);
        } catch {
          return { ok: false, status: res.status, text };
        }
      } catch (err) {
        console.error('Fetch error:', err);
        return { ok: false, status: 0, text: String(err?.message || err || '') };
      }
    }

    const WORKER_BUDGET_KEY = 'rv_internal_workers_daily_budget';
    const WORKER_USED_KEY = 'rv_internal_workers_used_today';
    const WORKER_LAST_CALLS_KEY = 'rv_internal_workers_last_calls';
    const refreshMetrics = { counting: false, requestCount: 0 };

    function toNumber(value) {
      const num = Number(String(value || '').replace(/[^0-9.]/g, ''));
      return Number.isFinite(num) ? num : 0;
    }

    function getStoredNumber(key) {
      try {
        const raw = window.localStorage.getItem(key);
        return toNumber(raw);
      } catch {
        return 0;
      }
    }

    function setStoredNumber(key, value) {
      try {
        window.localStorage.setItem(key, String(value));
      } catch {}
    }

    function recordRequest() {
      if (!refreshMetrics.counting) return;
      refreshMetrics.requestCount += 1;
    }

    function updateUsageUI() {
      const dailyBudget = getStoredNumber(WORKER_BUDGET_KEY);
      const usedToday = getStoredNumber(WORKER_USED_KEY);
      const remaining = Math.max(dailyBudget - usedToday, 0);
      const lastCalls = getStoredNumber(WORKER_LAST_CALLS_KEY);
      const refreshCalls = lastCalls || refreshMetrics.requestCount || 0;
      const pct = dailyBudget > 0 ? ((refreshCalls / dailyBudget) * 100) : 0;

      const remainingEl = document.getElementById('workers-remaining');
      const costEl = document.getElementById('workers-refresh-cost');
      const pctEl = document.getElementById('workers-refresh-pct');
      const lastCallsEl = document.getElementById('workers-last-calls');
      const dailyInput = document.getElementById('workers-daily-budget');
      const usedInput = document.getElementById('workers-used-today');

      if (remainingEl) remainingEl.textContent = dailyBudget ? `${remaining.toLocaleString()} req` : '‚Äî';
      if (costEl) costEl.textContent = refreshCalls ? `${refreshCalls.toLocaleString()} req` : '‚Äî';
      if (pctEl) pctEl.textContent = dailyBudget ? `${pct.toFixed(2)}%` : '‚Äî';
      if (lastCallsEl) lastCallsEl.textContent = refreshCalls ? refreshCalls.toLocaleString() : '‚Äî';

      if (dailyInput && !dailyInput.value) dailyInput.value = dailyBudget ? String(dailyBudget) : '';
      if (usedInput && !usedInput.value) usedInput.value = usedToday ? String(usedToday) : '';
    }

    const tokenInput = document.getElementById('token-input');
    if (tokenInput) tokenInput.value = INTERNAL_TOKEN || '';
    const applyBtn = document.getElementById('apply-token');
    if (applyBtn && tokenInput) {
      applyBtn.addEventListener('click', async () => {
        setToken(tokenInput.value);
        updateAuthUI();
      });
    }
    const copyBtn = document.getElementById('copy-link');
    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        const u = new URL(window.location.href);
        if (INTERNAL_TOKEN) u.searchParams.set('token', INTERNAL_TOKEN);
        else u.searchParams.delete('token');
        try { await navigator.clipboard.writeText(u.toString()); } catch {}
      });
    }

    const originProdInput = document.getElementById('origin-prod');
    if (originProdInput) {
      const stored = (() => {
        try { return window.localStorage.getItem(PROD_ORIGIN_KEY) || ''; } catch { return ''; }
      })();
      originProdInput.value = String(stored || '').trim();
      originProdInput.addEventListener('change', () => {
        setProdOrigin(originProdInput.value);
      });
    }

    const openThis = document.getElementById('open-this');
    if (openThis) {
      openThis.addEventListener('click', () => {
        const u = new URL('/internal-dashboard', window.location.origin);
        if (INTERNAL_TOKEN) u.searchParams.set('token', INTERNAL_TOKEN);
        window.open(u.toString(), '_blank', 'noreferrer');
      });
    }
    const openProd = document.getElementById('open-prod');
    if (openProd) {
      openProd.addEventListener('click', () => {
        const origin = getProdOrigin();
        if (!origin) return;
        const u = new URL('/internal-dashboard', origin);
        if (INTERNAL_TOKEN) u.searchParams.set('token', INTERNAL_TOKEN);
        window.open(u.toString(), '_blank', 'noreferrer');
      });
    }

    updateAuthUI();

    const loadTargetsBtn = document.getElementById('load-targets');
    if (loadTargetsBtn) {
      loadTargetsBtn.addEventListener('click', async () => {
        await updateTargets();
      });
    }

    const loadBundleBtn = document.getElementById('load-debug-bundle');
    if (loadBundleBtn) {
      loadBundleBtn.addEventListener('click', async () => {
        await updateDebugBundle();
      });
    }
    const loadMatrixBtn = document.getElementById('load-debug-matrix');
    if (loadMatrixBtn) {
      loadMatrixBtn.addEventListener('click', async () => {
        await updateDebugMatrix();
      });
    }

    async function refreshAll() {
      document.body.classList.add('loading');
      refreshMetrics.counting = true;
      refreshMetrics.requestCount = 0;
      await Promise.all([
        updateEndpointProbes(),
        updateHealthOverview(),
        loadDoc('/DEBUG_README.md', 'doc-debug-readme'),
        loadDoc('/RUNBOOK.md', 'doc-runbook'),
        loadDoc('/BLOCK_ANALYSIS.md', 'doc-block-analysis'),
        updateHealthReport(),
        updateBlockMatrix(),
        updateApiKeys(),
        updateErrorTimeline()
      ]);
      refreshMetrics.counting = false;
      setStoredNumber(WORKER_LAST_CALLS_KEY, refreshMetrics.requestCount);
      updateUsageUI();
      document.body.classList.remove('loading');
    }

    const refreshBtn = document.getElementById('refresh-all');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', refreshAll);
    }

    const dailyInput = document.getElementById('workers-daily-budget');
    if (dailyInput) {
      dailyInput.addEventListener('change', () => {
        setStoredNumber(WORKER_BUDGET_KEY, toNumber(dailyInput.value));
        updateUsageUI();
      });
    }
    const usedInput = document.getElementById('workers-used-today');
    if (usedInput) {
      usedInput.addEventListener('change', () => {
        setStoredNumber(WORKER_USED_KEY, toNumber(usedInput.value));
        updateUsageUI();
      });
    }

    function safeText(value) {
      return String(value ?? '').replace(/[&<>"']/g, (c) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      }[c]));
    }

    function badgeFor(value) {
      const text = String(value || '').toUpperCase();
      const cls = text === 'OK' || text === 'LIVE'
        ? 'ok'
        : text === 'PARTIAL' || text === 'STALE'
          ? 'warn'
          : text === 'EXPECTED'
            ? 'partial'
            : 'fail';
      return `<span class="badge ${cls}">${safeText(text || '‚Äî')}</span>`;
    }

    async function updateHealthReport() {
      const tbody = document.querySelector('#health-report-table tbody');
      const summaryEl = document.getElementById('health-report-summary');
      const ts = document.getElementById('health-report-timestamp');
      const selector = document.getElementById('health-report-block');
      const fieldsBody = document.querySelector('#health-report-fields tbody');
      if (!tbody || !summaryEl || !selector || !fieldsBody) return;

      const report = await fetchJSON(`${API_BASE}/health-report?debug=1`);
      if (!report || report.ok !== true) {
        tbody.innerHTML = '<tr><td colspan="9">No data available</td></tr>';
        if (ts) ts.textContent = `Last updated: ${new Date().toLocaleString()}`;
        return;
      }
      const blocks = Array.isArray(report.blocks) ? report.blocks : [];
      const summary = report.summary || {};

      const score = Number.isFinite(summary.healthScore) ? summary.healthScore : '‚Äî';
      const okBlocks = summary.okBlocks ?? 0;
      const partialBlocks = summary.partialBlocks ?? 0;
      const badBlocks = summary.badBlocks ?? 0;
      summaryEl.innerHTML = `
        <div class="status-card"><h3>Health Score</h3><div class="value">${safeText(score)}</div><div class="label">server contract + fetch</div></div>
        <div class="status-card ok"><h3>OK</h3><div class="value">${safeText(okBlocks)}</div><div class="label">Blocks</div></div>
        <div class="status-card warn"><h3>PARTIAL</h3><div class="value">${safeText(partialBlocks)}</div><div class="label">Blocks</div></div>
        <div class="status-card fail"><h3>BAD</h3><div class="value">${safeText(badBlocks)}</div><div class="label">Blocks</div></div>
      `;

      tbody.innerHTML = blocks.map((b) => {
        const state = String(b.blockState || '‚Äî');
        const endpointStatus = String(b.endpointStatus || '‚Äî');
        const err = b.error?.code ? `${b.error.code}` : '';
        return `
          <tr>
            <td><code>${safeText(b.id || '')}</code></td>
            <td><code>${safeText(b.featureId || '')}</code></td>
            <td>${badgeFor(state)}</td>
            <td><code>${safeText(b.apiPath || '‚Äî')}</code></td>
            <td>${badgeFor(endpointStatus)}</td>
            <td><code style="font-size: 11px;">${safeText(b.reason || '‚Äî')}</code></td>
            <td>${safeText(b.invalidFields ?? 0)}</td>
            <td>${b.circuitOpen === true ? '<span class="badge fail">open</span>' : b.circuitOpen === false ? '<span class="badge ok">closed</span>' : '‚Äî'}</td>
            <td><code style="font-size: 11px;">${safeText(err || '‚Äî')}</code></td>
          </tr>
        `;
      }).join('');

      const sorted = blocks.slice().sort((a, b) => String(a.id || '').localeCompare(String(b.id || '')));
      selector.innerHTML = '<option value="">Select a block for field details...</option>' +
        sorted.map((b) => `<option value="${safeText(b.featureId || '')}">${safeText(b.id || '')} ‚Äî ${safeText(b.title || b.featureId || '')}</option>`).join('');

      const byFeature = new Map(sorted.map((b) => [String(b.featureId || ''), b]));
      const renderFields = (featureId) => {
        const block = byFeature.get(String(featureId || ''));
        if (!block) {
          fieldsBody.innerHTML = '<tr><td colspan="6">Select a block above...</td></tr>';
          return;
        }
        const fields = Array.isArray(block.fields) ? block.fields : [];
        fieldsBody.innerHTML = fields.length ? fields.map((f) => {
          const ok = f.valid === true;
          return `
            <tr>
              <td><code>${safeText(f.key || '')}</code></td>
              <td><code>${safeText(f.path || '')}</code></td>
              <td>${f.required ? '<span class="badge warn">true</span>' : 'false'}</td>
              <td>${ok ? '<span class="badge ok">true</span>' : '<span class="badge fail">false</span>'}</td>
              <td><code style="font-size: 11px;">${safeText(f.reason || '‚Äî')}</code></td>
              <td style="max-width: 520px;">${safeText(f.fixHint || '‚Äî')}</td>
            </tr>
          `;
        }).join('') : '<tr><td colspan="6">No fields contract defined for this block.</td></tr>';
      };

      selector.onchange = () => renderFields(selector.value);
      if (ts) ts.textContent = `Last updated: ${new Date().toLocaleString()}`;
    }

    async function updateDebugMatrix() {
      const tbody = document.querySelector('#debug-matrix-table tbody');
      const ts = document.getElementById('debug-matrix-timestamp');
      if (!tbody) return;

      const res = await fetchJSON(`${API_BASE}/debug-matrix`);
      const entries = res?.data?.entries || [];
      if (!res || res.ok !== true || !Array.isArray(entries)) {
        tbody.innerHTML = '<tr><td colspan="5">No data available</td></tr>';
        if (ts) ts.textContent = `Last updated: ${new Date().toLocaleString()}`;
        return;
      }
      tbody.innerHTML = entries.map((e) => `
        <tr>
          <td><code>${safeText(e.feature || '‚Äî')}</code></td>
          <td><code>${safeText(e.endpoint || '‚Äî')}</code></td>
          <td>${badgeFor(e.endpointStatus || 'UNKNOWN')}</td>
          <td><code style="font-size:11px;">${safeText(e.emptyReason || '‚Äî')}</code></td>
          <td>${safeText(e.lastUpdate || '‚Äî')}</td>
        </tr>
      `).join('');
      if (ts) ts.textContent = `Last updated: ${new Date().toLocaleString()}`;
    }

    async function probeEndpoint(path) {
      try {
        const res = await fetch(withToken(path), {
          method: 'GET',
          headers: { Accept: 'application/json' },
          cache: 'no-store'
        });
        return { ok: res.ok, status: res.status };
      } catch (err) {
        return { ok: false, status: 0 };
      }
    }

    async function updateEndpointProbes() {
      const tbody = document.querySelector('#endpoint-probes tbody');
      if (!tbody) return;

      const targets = [
        { path: `${API_BASE}/health`, hint: '200 expected (prod: internal token bypasses debug guard)' },
        { path: `${API_BASE}/diag`, hint: 'Requires RV_INTERNAL_TOKEN (otherwise 404)' },
        { path: `${API_BASE}/system-health`, hint: 'Requires RV_INTERNAL_TOKEN (otherwise 404)' },
        { path: `${API_BASE}/debug-bundle`, hint: 'Requires RV_INTERNAL_TOKEN (otherwise 404)' }
      ];

      const results = await Promise.all(targets.map(async (t) => ({
        ...t,
        result: await probeEndpoint(t.path)
      })));

      tbody.innerHTML = results.map((row) => {
        const status = row.result.status;
        const statusClass = row.result.ok ? 'ok' : status === 404 ? 'warn' : 'fail';
        const label = row.result.ok ? `OK (${status})` : status ? `FAIL (${status})` : 'FAIL (network)';
        return `
          <tr>
            <td><code>${row.path}</code></td>
            <td><span class="badge ${statusClass}">${label}</span></td>
            <td>${row.hint}</td>
          </tr>
        `;
      }).join('');
    }

    async function updateHealthOverview() {
      const health = await fetchJSON(`${API_BASE}/health`);
      const diag = await fetchJSON(`${API_BASE}/diag`);
      
      const container = document.getElementById('health-overview');
      if (!health || (health.ok === false && (!diag || diag.ok === false))) {
        container.innerHTML = '<div class="status-card fail"><h3>Error</h3><div class="value">Failed</div><div class="label">Cannot fetch health data</div></div>';
        return;
      }

      const healthData = health?.data || {};
      const diagData = diag?.data || {};

      const overallStatus = healthData?.status || diagData?.overall_status || 'UNKNOWN';
      const statusClass = overallStatus === 'OK' ? 'ok' : overallStatus === 'DEGRADED' ? 'warn' : 'fail';
      
      container.innerHTML = `
        <div class="status-card ${statusClass}">
          <h3>Overall Status</h3>
          <div class="value">${overallStatus}</div>
          <div class="label">System Health</div>
        </div>
        <div class="status-card">
          <h3>Blocks Active</h3>
          <div class="value">${healthData?.blocks_ok || 0}</div>
          <div class="label">of ${healthData?.blocks_total || 0} total</div>
        </div>
        <div class="status-card">
          <h3>API Calls (24h)</h3>
          <div class="value">${healthData?.api_calls_24h || 0}</div>
          <div class="label">Estimated</div>
        </div>
        <div class="status-card">
          <h3>Cache Hit Rate</h3>
          <div class="value">${healthData?.cache_hit_rate || 0}%</div>
          <div class="label">Last 24h</div>
        </div>
      `;
      
      document.getElementById('health-timestamp').textContent = `Last updated: ${new Date().toLocaleString()}`;
    }

    async function updateDebugBundle() {
      const bundle = await fetchJSON(`${API_BASE}/debug-bundle`);
      const container = document.getElementById('debug-summary');
      const ts = document.getElementById('debug-timestamp');
      const attemptsBody = document.querySelector('#debug-attempts tbody');
      const eventsBody = document.querySelector('#recent-events tbody');

      if (!container || !attemptsBody || !eventsBody) return;

      if (!bundle || bundle.ok !== true) {
        container.innerHTML = '<div class="status-card fail"><h3>Bundle Status</h3><div class="value">ERROR</div><div class="label">/api/debug-bundle not accessible</div></div>';
        attemptsBody.innerHTML = '<tr><td colspan="5">No data available</td></tr>';
        eventsBody.innerHTML = '<tr><td colspan="6">No data available</td></tr>';
        if (ts) ts.textContent = `Last updated: ${new Date().toLocaleString()}`;
        return;
      }

      const data = bundle.data || {};
      const summary = data.summary || {};
      const infra = data.infra || {};
      const kv = infra.kv || {};
      const counts = summary.countsBySeverity || {};
      const status = summary.status || 'OK';
      const statusClass = status === 'OK' ? 'ok' : status === 'DEGRADED' ? 'warn' : 'fail';

      container.innerHTML = `
        <div class="status-card ${statusClass}">
          <h3>Bundle Status</h3>
          <div class="value">${status}</div>
          <div class="label">bundleId: ${summary.bundleId || '‚Äî'}</div>
        </div>
        <div class="status-card ${kv.opsWorking === false ? 'fail' : kv.opsWorking === true ? 'ok' : ''}">
          <h3>KV</h3>
          <div class="value">${kv.hasKV ? 'present' : 'missing'}</div>
          <div class="label">opsWorking: ${kv.opsWorking === null ? 'unknown' : kv.opsWorking}</div>
        </div>
        <div class="status-card">
          <h3>Severity</h3>
          <div class="value">${(counts.CRITICAL || 0) + (counts.WARN || 0)}</div>
          <div class="label">critical: ${counts.CRITICAL || 0} / warn: ${counts.WARN || 0}</div>
        </div>
        <div class="status-card">
          <h3>Top Error Codes</h3>
          <div class="value">${Array.isArray(summary.topErrorCodes) ? summary.topErrorCodes.length : 0}</div>
          <div class="label">recent KV events</div>
        </div>
      `;

      const attempts = Array.isArray(data.attempts) ? data.attempts : [];
      attemptsBody.innerHTML = attempts.length
        ? attempts.map((a) => {
            const ok = Boolean(a.ok);
            const okBadge = ok ? '<span class="badge ok">true</span>' : '<span class="badge fail">false</span>';
            return `
              <tr>
                <td><code>${a.name || '‚Äî'}</code></td>
                <td>${okBadge}</td>
                <td>${a.status ?? '‚Äî'}</td>
                <td><code style="font-size: 11px;">${a.reason || '‚Äî'}</code></td>
                <td><code style="font-size: 11px;">${(a.errorSnippet || '').slice(0, 180) || '‚Äî'}</code></td>
              </tr>
            `;
          }).join('')
        : '<tr><td colspan="5">No attempts recorded</td></tr>';

      const recent = Array.isArray(data.recentEvents) ? data.recentEvents : [];
      eventsBody.innerHTML = recent.length
        ? recent.slice(0, 120).map((e) => {
            const dq = String(e.dataQuality || '').toUpperCase();
            const dqClass = dq === 'OK' ? 'ok' : dq === 'STALE' ? 'stale' : dq === 'PARTIAL' ? 'partial' : dq ? 'warn' : '';
            return `
              <tr>
                <td>${e.ts ? new Date(e.ts).toLocaleString() : '‚Äî'}</td>
                <td><code>${e.feature || '‚Äî'}</code></td>
                <td>${e.httpStatus ?? '‚Äî'}</td>
                <td>${dq ? `<span class="badge ${dqClass}">${dq}</span>` : '‚Äî'}</td>
                <td><code style="font-size: 11px;">${e.errorCode || '‚Äî'}</code></td>
                <td><code style="font-size: 11px;">${e.traceId || '‚Äî'}</code></td>
              </tr>
            `;
          }).join('')
        : '<tr><td colspan="6">No recent events in KV</td></tr>';

      if (ts) ts.textContent = `Last updated: ${new Date().toLocaleString()}`;
    }

    async function updateBlockMatrix() {
      const diag = await fetchJSON(`${API_BASE}/diag`);
      const tbody = document.querySelector('#block-matrix tbody');
      
      const blocks = diag?.data?.blocks || diag?.blocks;
      if (!diag || diag.ok !== true || !blocks) {
        tbody.innerHTML = '<tr><td colspan="9">No data available</td></tr>';
        return;
      }

      tbody.innerHTML = blocks.map(block => {
        const statusClass = block.status === 'OK' ? 'ok' : block.status === 'PARTIAL' ? 'warn' : 'fail';
        return `
          <tr>
            <td>${block.title || block.feature_id}</td>
            <td><code>${block.feature_id}</code></td>
            <td><span class="badge ${statusClass}">${block.status || 'UNKNOWN'}</span></td>
            <td>${block.data_present ? '‚úÖ' : '‚ùå'}</td>
            <td><span class="badge ${block.quality === 'OK' ? 'ok' : block.quality === 'DEGRADED' ? 'warn' : 'fail'}">${block.quality || 'UNKNOWN'}</span></td>
            <td>${block.as_of ? new Date(block.as_of).toLocaleString() : '‚Äî'}</td>
            <td>${block.source || '‚Äî'}</td>
            <td>${block.cache_layer || 'none'}</td>
            <td><code style="font-size: 11px;">${block.last_error || '‚Äî'}</code></td>
          </tr>
        `;
      }).join('');
    }

    async function updateApiKeys() {
      const diag = await fetchJSON(`${API_BASE}/diag`);
      const tbody = document.querySelector('#api-keys tbody');

      const keys = diag?.data?.api_keys || diag?.api_keys;
      
      if (!diag || diag.ok !== true || !keys) {
        tbody.innerHTML = '<tr><td colspan="14">No API key data available</td></tr>';
        return;
      }

      tbody.innerHTML = keys.map(key => {
        const statusClass = key.status === 'present' ? 'ok' : key.status === 'missing' ? 'fail' : 'warn';
        return `
          <tr>
            <td>${key.provider || '‚Äî'}</td>
            <td><code>${key.alias || '‚Äî'}</code></td>
            <td><span class="badge ${statusClass}">${key.status || 'UNKNOWN'}</span></td>
            <td>${key.counts_today || 0}</td>
            <td>${key.counts_week ?? '‚Äî'}</td>
            <td>${key.counts_month ?? '‚Äî'}</td>
            <td>${key.hard_limit || '‚Äî'}</td>
            <td>${key.remaining || '‚Äî'}</td>
            <td>${key.remaining_week ?? '‚Äî'}</td>
            <td>${key.remaining_month ?? '‚Äî'}</td>
            <td>${key.burn_rate_per_hour ?? '‚Äî'}</td>
            <td><code style="font-size: 11px;">${key.last_error || '‚Äî'}</code></td>
            <td>${key.last_used ? new Date(key.last_used).toLocaleString() : '‚Äî'}</td>
            <td style="max-width: 260px;">${key.hint || '‚Äî'}</td>
            <td style="max-width: 260px;">${key.recommended_action || '‚Äî'}</td>
          </tr>
        `;
      }).join('');
    }

    async function updateErrorTimeline() {
      const diag = await fetchJSON(`${API_BASE}/diag`);
      const tbody = document.querySelector('#error-timeline tbody');

      const events = diag?.data?.events || diag?.events;
      
      if (!diag || diag.ok !== true || !events) {
        tbody.innerHTML = '<tr><td colspan="6">No events available</td></tr>';
        return;
      }

      tbody.innerHTML = events.slice(0, 50).map(event => {
        const typeClass = event.type === 'error' ? 'fail' : event.type === 'warn' ? 'warn' : 'ok';
        return `
          <tr>
            <td>${new Date(event.timestamp).toLocaleString()}</td>
            <td><span class="badge ${typeClass}">${event.type || 'info'}</span></td>
            <td><code>${event.feature || '‚Äî'}</code></td>
            <td><code>${event.error_code || '‚Äî'}</code></td>
            <td>${event.message || '‚Äî'}</td>
            <td><code style="font-size: 11px;">${event.details || '‚Äî'}</code></td>
          </tr>
        `;
      }).join('');
    }

    updateUsageUI();
  </script>
</body>
</html>
