<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>RubikVault – Stock Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="description" content="Find the best stocks to invest in. Analyze stocks by name or ticker symbol with RubikVault Stock Analyzer." />
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#3b82f6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="RubikVault" />
  
  <!-- Deep Links for Mobile Apps -->
  <meta property="al:ios:url" content="rubikvault://analyze" />
  <meta property="al:ios:app_store_id" content="YOUR_APP_STORE_ID" />
  <meta property="al:ios:app_name" content="RubikVault" />
  <meta property="al:android:url" content="rubikvault://analyze" />
  <meta property="al:android:package" content="com.rubikvault.app" />
  <meta property="al:android:app_name" content="RubikVault" />
  <meta property="al:web:url" content="https://rubikvault.com" />
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/rv-favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/rv-apple-icon.png" />
  <link rel="manifest" href="/manifest.json" />
  
  <!-- Styles -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="/search.css" />
</head>
<body>
  <div id="rv-search-root"></div>
  <!-- HEADER -->
  <header class="rv-header">
    <div class="rv-header-inner">
      <a class="rv-brand" href="/" aria-label="RubikVault">
        <img class="rv-brand-icon" src="/assets/rv-icon.png" alt="" />
        <span class="rv-brand-text">RubikVault</span>
      </a>

      <nav class="rv-nav">
        <a class="rv-social-link" href="https://www.youtube.com/@RubikVault" target="_blank" rel="noopener noreferrer" aria-label="YouTube">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M21.58 7.19a2.5 2.5 0 0 0-1.76-1.77C18.25 5 12 5 12 5s-6.25 0-7.82.42A2.5 2.5 0 0 0 2.42 7.2 26.6 26.6 0 0 0 2 12s0 2.55.42 4.81a2.5 2.5 0 0 0 1.76 1.77C5.75 19 12 19 12 19s6.25 0 7.82-.42a2.5 2.5 0 0 0 1.76-1.77C22 14.55 22 12 22 12s0-2.55-.42-4.81ZM10 15.5v-7l6 3.5-6 3.5Z" />
          </svg>
        </a>
        <a class="rv-social-link" href="https://x.com/RubikVault" target="_blank" rel="noopener noreferrer" aria-label="X">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M18.9 2H22l-6.79 7.76L23 22h-6.2l-4.86-6.02L6.66 22H3.5l7.26-8.3L3 2h6.35l4.4 5.52L18.9 2Zm-1.09 18h1.72L8.4 3.93H6.56L17.81 20Z" />
          </svg>
        </a>
        <a class="rv-social-link" href="https://www.tiktok.com/@rubikvault" target="_blank" rel="noopener noreferrer" aria-label="TikTok">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M16.7 5.2c.8 1.2 2.1 2 3.6 2.1v3.1c-1.7-.1-3.3-.7-4.6-1.7v7.4c0 3.4-2.8 6.2-6.2 6.2S3.3 19.5 3.3 16.1s2.8-6.2 6.2-6.2c.4 0 .8 0 1.2.1v3.3c-.4-.1-.8-.2-1.2-.2-1.7 0-3.1 1.4-3.1 3.1s1.4 3.1 3.1 3.1 3.1-1.4 3.1-3.1V2h3.1c0 1.2.3 2.3 1 3.2Z" />
          </svg>
        </a>
        <a class="rv-social-link" href="https://www.instagram.com/rubikvault" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5Zm10 2H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3Zm-5 3.5a4.5 4.5 0 1 1 0 9 4.5 4.5 0 0 1 0-9Zm0 2a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5ZM17.8 6.2a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z" />
          </svg>
        </a>
      </nav>

      <div class="rv-header-tools" aria-live="polite">
        <div class="rv-data-updated" style="font-size: 12px; color: var(--rv-text-muted);">
          Data updated: <span id="rv-data-updated-date">Loading...</span> (daily snapshots)
        </div>
        <div class="rv-market-clock">
          <span class="rv-clock-time" id="rv-ny-time">NY: --:--:--</span>
          <span class="rv-clock-status">
            <span class="rv-led" data-rv-led="closed"></span>
            <span class="rv-market-label" data-rv-market-label>Closed</span>
            <span class="rv-market-countdown" id="rv-market-countdown">opens in --:--:--</span>
          </span>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="rv-main" style="max-width: 1200px; margin: 0 auto; padding: 3rem 2rem;">
    
    <!-- HERO SECTION: Stock Analyzer -->
    <section style="text-align: center; margin-bottom: 4rem;">
      <h1 style="font-size: 4rem; font-weight: 800; margin-bottom: 1rem; color: #f1f5f9; letter-spacing: -0.02em;">
        Stock Analyzer
      </h1>
      
      <p style="font-size: 1.5rem; color: #e5e7eb; margin-bottom: 0.5rem;">
        Find the best stocks to invest in
      </p>
      
      <p style="font-size: 1.125rem; color: #94a3b8; margin-bottom: 3rem;">
        Analyze stocks by name or ticker symbol
      </p>

      <!-- SEARCH BOX -->
      <div style="max-width: 700px; margin: 0 auto 3rem; position: relative;">
        <svg style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; color: #64748b;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input 
          type="text" 
          id="stock-search-input" 
          placeholder="Type Stock you want to check here...."
          autocomplete="off"
          style="
            width: 100%;
            padding: 1.25rem 1.5rem 1.25rem 3.5rem;
            font-size: 1.125rem;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(100, 116, 139, 0.3);
            border-radius: 12px;
            color: #e5e7eb;
            transition: all 0.2s;
          "
          onfocus="this.style.borderColor='rgba(59, 130, 246, 0.6)'; this.style.background='rgba(30, 41, 59, 1)';"
          onblur="this.style.borderColor='rgba(100, 116, 139, 0.3)'; this.style.background='rgba(30, 41, 59, 0.8)';"
        />
      </div>

      <!-- QUICK STATS -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; max-width: 700px; margin: 0 auto 2rem;">
        <div style="text-align: center;">
          <div style="font-size: 3rem; font-weight: 700; color: #3b82f6; margin-bottom: 0.5rem;">8</div>
          <div style="font-size: 1rem; color: #94a3b8;">Top Stocks</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 3rem; font-weight: 700; color: #10b981; margin-bottom: 0.5rem;">5</div>
          <div style="font-size: 1rem; color: #94a3b8;">Buy Signals</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 3rem; font-weight: 700; color: #f59e0b; margin-bottom: 0.5rem;">8.5</div>
          <div style="font-size: 1rem; color: #94a3b8;">Ø Score</div>
        </div>
      </div>

      <p style="font-size: 0.875rem; color: #64748b; font-style: italic;">
        Enter a stock name or ticker to start the analysis
      </p>
    </section>

    <!-- RESULTS SECTION (Hidden by default) -->
    <section id="search-results" style="display: none; margin-top: 3rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2 id="results-title" style="font-size: 2rem; color: #e5e7eb;">Analysis Results</h2>
        <button 
          onclick="clearSearch()" 
          style="
            padding: 0.75rem 1.5rem;
            background: rgba(100, 116, 139, 0.2);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 8px;
            color: #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
          "
          onmouseover="this.style.background='rgba(100, 116, 139, 0.3)'"
          onmouseout="this.style.background='rgba(100, 116, 139, 0.2)'"
        >
          ← Back to Search
        </button>
      </div>
      
      <div id="results-content" class="rv-card" style="padding: 2rem;">
        <!-- Results will be loaded here -->
      </div>
    </section>
    
  </main>

  <!-- FOOTER -->
  <footer class="rv-footer">
    <div class="rv-footer-inner">
      <div class="rv-footer-brand">RubikVault</div>
      <div class="rv-footer-links">
        <a href="imprint.html">Imprint</a>
        <a href="privacy.html">Privacy</a>
        <a href="disclaimer.html">Disclaimer</a>
      </div>
    </div>
    <p>RubikVault provides educational content only and does not offer financial advice or brokerage services.</p>
    <p>&copy; 2026 RubikVault. All rights reserved.</p>
  </footer>

  <!-- Market Clock Script -->
  <script src="market-clock.js"></script>
  
  <!-- Update Date -->
  <script>
    (function() {
      const el = document.getElementById("rv-data-updated-date");
      if (el) {
        const today = new Date();
        el.textContent = today.toISOString().split("T")[0];
      }
    })();
  </script>

  <!-- STOCK SEARCH LOGIC -->
  <script>
    const searchInput = document.getElementById('stock-search-input');
    const resultsSection = document.getElementById('search-results');
    const resultsContent = document.getElementById('results-content');
    const resultsTitle = document.getElementById('results-title');
    
    // Popular tickers for quick suggestions (can be expanded)
    const popularTickers = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'NVDA', 'META', 'NFLX', 'SPY', 'QQQ'];

    let lastResolved = { ticker: null, name: null };

    const pageDebug = (() => {
      try {
        const params = new URLSearchParams(window.location.search || '');
        return params.get('debug') === '1';
      } catch {
        return false;
      }
    })();

    

      // Analyze-route CSS isolation (prevents global CSS leaks)
      try {
        if (window.location.pathname && window.location.pathname.startsWith("/analyze/")) {
          document.body.classList.add("rv-analyze");
        }
      } catch {}

      const typeahead = {
      root: null,
      items: [],
      open: false,
      activeIndex: -1,
      debounceMs: 150,
      debounceTimer: null,
      blurTimer: null,
      requestSeq: 0,
      emptyMessage: null
    };

    async function fetchJson(url) {
      try {
        const response = await fetch(url);
        const payload = await response.json().catch(() => null);
        return { response, payload, networkError: null };
      } catch (error) {
        return { response: null, payload: null, networkError: error };
      }
    }

    function ensureTypeaheadRoot() {
      if (typeahead.root) return typeahead.root;
      const parent = searchInput?.parentElement;
      if (!parent) return null;
      const root = document.createElement('div');
      root.id = 'rv-typeahead';
      root.style.position = 'absolute';
      root.style.left = '0';
      root.style.right = '0';
      root.style.top = 'calc(100% + 10px)';
      root.style.zIndex = '50';
      root.style.background = 'rgba(15, 23, 42, 0.98)';
      root.style.border = '1px solid rgba(100, 116, 139, 0.28)';
      root.style.borderRadius = '12px';
      root.style.boxShadow = '0 18px 40px rgba(0,0,0,0.35)';
      root.style.overflow = 'hidden';
      root.style.display = 'none';
      parent.appendChild(root);
      typeahead.root = root;
      return root;
    }

    function closeTypeahead() {
      typeahead.open = false;
      typeahead.items = [];
      typeahead.activeIndex = -1;
      typeahead.emptyMessage = null;
      if (typeahead.root) typeahead.root.style.display = 'none';
    }

    function openTypeahead(items) {
      const root = ensureTypeaheadRoot();
      if (!root) return;
      typeahead.items = Array.isArray(items) ? items : [];
      typeahead.open = typeahead.items.length > 0;
      typeahead.activeIndex = -1;
      typeahead.emptyMessage = null;
      renderTypeahead();
    }

    function clearSuggestions() {
      closeTypeahead();
    }

    async function doFetch(q) {
      const query = String(q || '').trim();
      if (!query) {
        clearSuggestions();
        return;
      }
      const seq = ++typeahead.requestSeq;
      const url = `/api/universe?q=${encodeURIComponent(query)}&t=${Date.now()}`;
      const { payload, networkError } = await fetchJson(url);
      if (seq !== typeahead.requestSeq) return;

      if (pageDebug) {
        console.log('[rv][typeahead] universe request', {
          url,
          ok: Boolean(payload && !networkError && !payload.error),
          networkError: Boolean(networkError)
        });
      }

      if (networkError || !payload) {
        clearSuggestions();
        return;
      }

      if (!Array.isArray(payload?.data?.symbols)) {
        if (pageDebug) {
          console.warn('[rv][typeahead] invalid universe payload shape', {
            hasData: typeof payload?.data === 'object',
            symbolsType: typeof payload?.data?.symbols
          });
        }
        clearSuggestions();
        return;
      }

      const items = payload?.data?.symbols ?? [];
      if (pageDebug) {
        console.log('[rv][typeahead] universe results', {
          q: query,
          count: Array.isArray(items) ? items.length : null
        });
      }

      if (!items.length) {
        if (pageDebug && query.length >= 1) {
          typeahead.items = [];
          typeahead.open = true;
          typeahead.activeIndex = -1;
          typeahead.emptyMessage = 'No matches';
          renderTypeahead();
          return;
        }
        clearSuggestions();
        return;
      }

      openTypeahead(
        items
          .map((it) => {
            const symbol = it?.symbol ? String(it.symbol).toUpperCase() : null;
            if (!symbol) return null;
            return { symbol, name: it?.name ? String(it.name) : '' };
          })
          .filter(Boolean)
      );
    }

    function scheduleFetch(q) {
      if (typeahead.debounceTimer) clearTimeout(typeahead.debounceTimer);
      typeahead.debounceTimer = setTimeout(() => doFetch(q), typeahead.debounceMs);
    }

    function renderTypeahead() {
      const root = ensureTypeaheadRoot();
      if (!root) return;
      if (!typeahead.open || (!typeahead.items.length && !typeahead.emptyMessage)) {
        root.style.display = 'none';
        return;
      }
      root.style.display = 'block';

      if (!typeahead.items.length && typeahead.emptyMessage) {
        root.innerHTML = `<div style="padding: 0.8rem 1rem; color: #94a3b8;">${escapeHtml(typeahead.emptyMessage)}</div>`;
        return;
      }

      const html = typeahead.items
        .map((item, idx) => {
          const active = idx === typeahead.activeIndex;
          const bg = active ? 'rgba(59, 130, 246, 0.18)' : 'transparent';
          const border = active ? 'rgba(59, 130, 246, 0.35)' : 'transparent';
          const label = item.name ? `${escapeHtml(item.name)} (${escapeHtml(item.symbol)})` : escapeHtml(item.symbol);
          return `
            <div data-idx="${idx}" class="${active ? 'is-active' : ''}" style="padding: 0.8rem 1rem; cursor: pointer; background: ${bg}; border-left: 3px solid ${border};">
              <div style="font-weight: 700; color: #e5e7eb; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${label}</div>
            </div>
          `;
        })
        .join('');
      root.innerHTML = html;

      root.querySelectorAll('[data-idx]').forEach((el) => {
        el.addEventListener('mousedown', (ev) => {
          ev.preventDefault();
        });
        el.addEventListener('click', async () => {
          const idx = Number(el.getAttribute('data-idx'));
          const item = typeahead.items[idx];
          if (!item?.symbol) return;
          closeTypeahead();
          searchInput.value = item.symbol;
          window.location.href = `/analyze/${encodeURIComponent(item.symbol)}`;
        });
      });
    }

    function formatNumber(value, options = {}) {
      const num = Number(value);
      if (!Number.isFinite(num)) return '—';
      const digits = Number.isFinite(options.digits) ? options.digits : 2;
      return num.toLocaleString(undefined, { minimumFractionDigits: digits, maximumFractionDigits: digits });
    }

    function formatPercent(value, digits = 2) {
      const num = Number(value);
      if (!Number.isFinite(num)) return '—';
      const pct = num * 100;
      const sign = pct > 0 ? '+' : '';
      return `${sign}${pct.toFixed(digits)}%`;
    }

    function escapeHtml(text) {
      return String(text || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function renderErrorBanner(error, meta) {
      const code = escapeHtml(error?.code || 'ERROR');
      const message = escapeHtml(error?.message || 'Unable to load stock data');
      const status = escapeHtml(meta?.status || 'ERROR');
      return `
        <div style="padding: 1rem; border-radius: 10px; background: rgba(239, 68, 68, 0.12); border: 1px solid rgba(239, 68, 68, 0.35); margin-bottom: 1.5rem;">
          <div style="font-weight: 700; color: #fecaca;">${code}</div>
          <div style="color: #fca5a5; margin-top: 0.25rem;">${message}</div>
          <div style="color: #94a3b8; font-size: 0.875rem; margin-top: 0.5rem;">status=${status}</div>
        </div>
      `;
    }

    function renderSourceChain(chain) {
      if (!chain) return '';
      const primary = escapeHtml(chain?.primary || '—');
      const selected = escapeHtml(chain?.selected || '—');
      const forced = chain?.forced ? 'true' : 'false';
      const fallbackUsed = chain?.fallbackUsed ? 'true' : 'false';
      const failureReason = escapeHtml(chain?.failureReason || '');
      const primaryCode = escapeHtml(chain?.primaryFailure?.code || '');
      const secondaryCode = escapeHtml(chain?.secondaryFailure?.code || '');

      const primaryFailureProvider = escapeHtml(chain?.primaryFailure?.provider || chain?.primary || '');
      const primaryFailureMessage = escapeHtml(chain?.primaryFailure?.message || '');

      const extra = [
        failureReason ? `failureReason=${failureReason}` : null,
        primaryCode ? `primaryFailure=${primaryCode}` : null,
        secondaryCode ? `secondaryFailure=${secondaryCode}` : null
      ].filter(Boolean).join(' • ');

      const primaryFailureHint =
        chain?.fallbackUsed && (primaryCode || primaryFailureMessage)
          ? `primary=${primary} failed: ${primaryFailureProvider || primary}${primaryCode ? ` (${primaryCode})` : ''}${primaryFailureMessage ? ` — ${primaryFailureMessage}` : ''}`
          : '';

      return `
        <div style="margin-top: 1rem; padding: 0.9rem 1rem; border-radius: 10px; background: rgba(15, 23, 42, 0.35); border: 1px solid rgba(100, 116, 139, 0.22);">
          <div style="font-size: 0.8rem; color: #94a3b8;">Data source</div>
          <div style="margin-top: 0.25rem; color: #e5e7eb; font-weight: 600;">selected=${selected} • primary=${primary} • forced=${forced} • fallbackUsed=${fallbackUsed}</div>
          ${primaryFailureHint ? `<div style="margin-top: 0.35rem; color: #94a3b8; font-size: 0.85rem;">${primaryFailureHint}</div>` : ''}
          ${extra ? `<div style="margin-top: 0.35rem; color: #94a3b8; font-size: 0.85rem;">${extra}</div>` : ''}
        </div>
      `;
    }

    function renderStock(payload, fallback = {}) {
      const data = payload?.data || {};
      const meta = payload?.metadata || {};
      const error = payload?.error || null;

      const effectiveTicker = data?.ticker || fallback?.ticker || '—';
      const effectiveName = data?.name || fallback?.name || '—';
      const showBanner = Boolean(error) || (meta?.status && meta?.status !== 'OK');
      const bannerError = error || {
        code: meta?.status && meta?.status !== 'OK' ? 'UPSTREAM_ERROR' : 'ERROR',
        message: meta?.status && meta?.status !== 'OK' ? 'Stock data unavailable' : 'Unable to load stock data'
      };

      const bar = data?.latest_bar || null;
      const close = bar?.close;
      const volume = bar?.volume;
      const date = bar?.date || '—';
      const changeAbs = data?.change?.abs;
      const changePct = data?.change?.pct;

      const indicators = Array.isArray(data?.indicators) ? data.indicators : [];
      const computedNullCount = indicators.reduce((acc, item) => {
        const value = item?.value;
        if (value == null) return acc + 1;
        const num = Number(value);
        if (!Number.isFinite(num)) return acc + 1;
        return acc;
      }, 0);
      const indicatorCount = Number.isFinite(Number(meta?.indicators?.count)) ? Number(meta.indicators.count) : indicators.length;
      const nullIndicatorCount = Number.isFinite(Number(meta?.indicators?.nullCount))
        ? Number(meta.indicators.nullCount)
        : computedNullCount;
      const expectedIndicatorCount = 27;
      const indicatorsValidated = indicatorCount === expectedIndicatorCount && nullIndicatorCount === 0;
      const indicatorsHtml = indicators
        .map((item) => {
          const id = escapeHtml(item?.id);
          const value = item?.value;
          const display = Number.isFinite(Number(value)) ? formatNumber(value, { digits: 4 }) : '—';
          return `
            <div style="padding: 0.75rem 0.9rem; background: rgba(15, 23, 42, 0.35); border: 1px solid rgba(100, 116, 139, 0.22); border-radius: 10px;">
              <div style="font-size: 0.8rem; color: #94a3b8;">${id}</div>
              <div style="margin-top: 0.25rem; font-weight: 700; color: #e5e7eb;">${display}</div>
            </div>
          `;
        })
        .join('');

      const statusChipColor = meta?.status === 'OK' ? '#10b981' : meta?.status === 'PARTIAL' ? '#f59e0b' : '#ef4444';

      resultsTitle.textContent = `Analysis for ${effectiveTicker}`;
      resultsContent.innerHTML = `
        ${showBanner ? renderErrorBanner(bannerError, meta) : ''}
        <div style="display: flex; align-items: baseline; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
          <div>
            <div style="font-size: 2.1rem; font-weight: 800; color: #f1f5f9;">${escapeHtml(effectiveName)}</div>
            <div style="margin-top: 0.25rem; font-size: 1.1rem; color: #94a3b8;">${escapeHtml(effectiveTicker)} • ${escapeHtml(date)}</div>
          </div>
          <div style="padding: 0.35rem 0.75rem; border-radius: 999px; border: 1px solid rgba(100,116,139,0.35); color: #e5e7eb; background: rgba(15,23,42,0.35);">
            <span style="display:inline-block; width: 8px; height: 8px; border-radius: 999px; background:${statusChipColor}; margin-right: 8px;"></span>
            ${escapeHtml(meta?.status || 'UNKNOWN')}
          </div>
        </div>

        ${renderSourceChain(meta?.source_chain)}

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
          <div style="padding: 1.2rem; background: rgba(59, 130, 246, 0.1); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.2);">
            <div style="font-size: 0.875rem; color: #94a3b8; margin-bottom: 0.4rem;">Close</div>
            <div style="font-size: 2rem; font-weight: 800; color: #e5e7eb;">${close == null ? '—' : '$' + formatNumber(close, { digits: 2 })}</div>
          </div>

          <div style="padding: 1.2rem; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.2);">
            <div style="font-size: 0.875rem; color: #94a3b8; margin-bottom: 0.4rem;">Day change</div>
            <div style="font-size: 2rem; font-weight: 800; color: #e5e7eb;">${formatNumber(changeAbs, { digits: 2 })}</div>
            <div style="margin-top: 0.25rem; font-size: 1rem; color: #94a3b8;">${formatPercent(changePct, 2)}</div>
          </div>

          <div style="padding: 1.2rem; background: rgba(245, 158, 11, 0.1); border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.2);">
            <div style="font-size: 0.875rem; color: #94a3b8; margin-bottom: 0.4rem;">Volume</div>
            <div style="font-size: 2rem; font-weight: 800; color: #e5e7eb;">${volume == null ? '—' : Number(volume).toLocaleString()}</div>
          </div>
        </div>

        <div style="margin-top: 2rem; display: flex; align-items: baseline; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
          <h3 style="margin: 0; font-size: 1.25rem; color: #e5e7eb;">Indicators</h3>
          <div style="display:flex; gap: 0.6rem; align-items: baseline; flex-wrap: wrap; justify-content: flex-end;">
            ${indicatorsValidated ? '<span style="display:inline-flex; align-items:center; gap:0.35rem; padding: 0.2rem 0.55rem; border-radius: 999px; border: 1px solid rgba(16, 185, 129, 0.35); background: rgba(16, 185, 129, 0.12); color: #a7f3d0; font-size: 0.85rem; font-weight: 700;">Validated</span>' : ''}
            <div style="font-size: 0.9rem; color: #94a3b8;">count=${indicatorCount} • null=${nullIndicatorCount}</div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap: 0.75rem; margin-top: 1rem;">
          ${indicatorsHtml || '<div style="color:#94a3b8;">No indicators available.</div>'}
        </div>
      `;
    }

    function showLoading(label) {
      // Show results section
      resultsSection.style.display = 'block';
      resultsTitle.textContent = label;
      resultsContent.innerHTML = `
        <div style="text-align: center; padding: 3rem; color: #64748b;">
          <div>Loading...</div>
        </div>
      `;

      // Scroll to results
      resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

    }

    async function loadAnalyze(ticker, options = {}) {
      const upperTicker = String(ticker || '').trim().toUpperCase();
      if (!upperTicker) return;
      const push = options.push !== false;
      if (push) {
        window.history.pushState({}, '', `/analyze/${encodeURIComponent(upperTicker)}`);
      }

      showLoading(`Analyzing ${upperTicker}...`);
      resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      const fallback = options.fallback || { ticker: upperTicker, name: lastResolved?.name || null };
      const { payload, networkError } = await fetchJson(`/api/stock?ticker=${encodeURIComponent(upperTicker)}`);
      if (networkError) {
        renderStock(
          { error: { code: 'NETWORK_ERROR', message: 'Unable to reach /api/stock' }, metadata: { status: 'ERROR' } },
          fallback
        );
        return;
      }
      renderStock(payload || { error: { code: 'NETWORK_ERROR', message: 'Unable to reach /api/stock' }, metadata: { status: 'ERROR' } }, fallback);
    }

    async function resolveAndAnalyze(query) {
      const trimmed = String(query || '').trim();
      if (!trimmed) return;
      showLoading(`Resolving ${trimmed}...`);
      resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      const { payload, networkError } = await fetchJson(`/api/resolve?q=${encodeURIComponent(trimmed)}`);
      if (networkError) {
        resultsTitle.textContent = 'Resolve failed';
        resultsContent.innerHTML = renderErrorBanner({ code: 'NETWORK_ERROR', message: 'Unable to reach /api/resolve' }, { status: 'ERROR' });
        return;
      }
      if (!payload || payload.error || !payload.data?.ticker) {
        resultsTitle.textContent = 'Resolve failed';
        resultsContent.innerHTML = renderErrorBanner(payload?.error || { code: 'SYMBOL_NOT_FOUND', message: 'Unable to resolve symbol' }, payload?.metadata);
        return;
      }

      lastResolved = { ticker: payload.data.ticker || null, name: payload.data.name || null };
      searchInput.value = payload.data.ticker;
      await loadAnalyze(payload.data.ticker, { fallback: lastResolved });
    }

    // Search on Enter key
    searchInput.addEventListener('keydown', async (e) => {
      if (e.key === 'ArrowDown' && typeahead.open) {
        e.preventDefault();
        typeahead.activeIndex = Math.min(typeahead.items.length - 1, typeahead.activeIndex + 1);
        renderTypeahead();
        return;
      }
      if (e.key === 'ArrowUp' && typeahead.open) {
        e.preventDefault();
        typeahead.activeIndex = Math.max(0, typeahead.activeIndex - 1);
        renderTypeahead();
        return;
      }
      if (e.key === 'Escape' && typeahead.open) {
        e.preventDefault();
        closeTypeahead();
        return;
      }
      if (e.key === 'Enter') {
        if (typeahead.open && typeahead.items.length) {
          e.preventDefault();
          const pick = typeahead.activeIndex >= 0 ? typeahead.items[typeahead.activeIndex] : typeahead.items[0];
          closeTypeahead();
          searchInput.value = pick.symbol;
          window.location.href = `/analyze/${encodeURIComponent(pick.symbol)}`;
          return;
        }
        closeTypeahead();
        await resolveAndAnalyze(searchInput.value);
      }
    });

    searchInput.addEventListener('input', () => {
      const value = String(searchInput.value || '').trim();
      if (value.length < 1) {
        clearSuggestions();
        return;
      }
      scheduleFetch(value);
    });

    searchInput.addEventListener('blur', () => {
      if (typeahead.blurTimer) clearTimeout(typeahead.blurTimer);
      typeahead.blurTimer = setTimeout(() => closeTypeahead(), 120);
    });

    searchInput.addEventListener('focus', () => {
      if (typeahead.blurTimer) clearTimeout(typeahead.blurTimer);
      if (searchInput.value.trim() && typeahead.items.length) {
        typeahead.open = true;
        renderTypeahead();
      }
    });

    document.addEventListener('click', (ev) => {
      if (!typeahead.open) return;
      const root = typeahead.root;
      if (!root) return;
      const target = ev.target;
      if (target === searchInput || root.contains(target)) return;
      closeTypeahead();
    });

    // Clear search and return to hero
    function clearSearch() {
      searchInput.value = '';
      resultsSection.style.display = 'none';
      searchInput.focus();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Auto-focus search on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Check for deep link: /analyze/TICKER
      const path = window.location.pathname;
      const match = path.match(/^\/analyze\/([A-Z]+)$/i);
      
      if (match) {
        const ticker = match[1].toUpperCase();
        searchInput.value = ticker;
        loadAnalyze(ticker, { push: false });
      } else {
        searchInput.focus();
      }
    });
    
    // Handle browser back button
    window.addEventListener('popstate', () => {
      const path = window.location.pathname;
      const match = path.match(/^\/analyze\/([A-Z]+)$/i);
      if (match) {
        const ticker = match[1].toUpperCase();
        searchInput.value = ticker;
        loadAnalyze(ticker, { push: false });
        return;
      }
      if (path === '/' || path === '/index.html') {
        clearSearch();
      }
    });

    /*
    Manual verification checklist:
    - Type "Apple" -> shows "Apple Inc. (AAPL)"
    - ArrowDown + Enter navigates to /analyze/AAPL
    - Type "aap" -> shows AAP + AAPL
    - Esc closes suggestions
    - Clicking suggestion navigates
    - With ?debug=1, console logs request URL + ok + count
    */
  </script>

</body>
</html>
