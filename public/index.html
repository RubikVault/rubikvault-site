<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RubikVault – Decode the Markets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="RubikVault – calm, data-driven multi-asset market insights across stocks, crypto, macro and commodities. Educational only."
  />
  <script>
    (function() {
      var stored = window.localStorage && window.localStorage.getItem("rv-theme");
      var theme = stored === "light" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", theme);
    })();
  </script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- HEADER MIT INLINE-LOGO -->
  <header class="rv-header">
    <div class="rv-header-inner">
      <a class="rv-brand" href="/" aria-label="RubikVault">
        <img class="rv-brand-icon" src="/assets/rv-icon.png" alt="" />
        <span class="rv-brand-text">RubikVault</span>
      </a>

      <nav class="rv-nav">
        <a class="rv-social-link" href="https://www.youtube.com/@RubikVault" target="_blank" rel="noopener noreferrer" aria-label="YouTube">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M21.58 7.19a2.5 2.5 0 0 0-1.76-1.77C18.25 5 12 5 12 5s-6.25 0-7.82.42A2.5 2.5 0 0 0 2.42 7.2 26.6 26.6 0 0 0 2 12s0 2.55.42 4.81a2.5 2.5 0 0 0 1.76 1.77C5.75 19 12 19 12 19s6.25 0 7.82-.42a2.5 2.5 0 0 0 1.76-1.77C22 14.55 22 12 22 12s0-2.55-.42-4.81ZM10 15.5v-7l6 3.5-6 3.5Z" />
          </svg>
        </a>
        <a class="rv-social-link" href="https://x.com/RubikVault" target="_blank" rel="noopener noreferrer" aria-label="X">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M18.9 2H22l-6.79 7.76L23 22h-6.2l-4.86-6.02L6.66 22H3.5l7.26-8.3L3 2h6.35l4.4 5.52L18.9 2Zm-1.09 18h1.72L8.4 3.93H6.56L17.81 20Z" />
          </svg>
        </a>
        <a class="rv-social-link" href="https://www.tiktok.com/@rubikvault" target="_blank" rel="noopener noreferrer" aria-label="TikTok">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M16.7 5.2c.8 1.2 2.1 2 3.6 2.1v3.1c-1.7-.1-3.3-.7-4.6-1.7v7.4c0 3.4-2.8 6.2-6.2 6.2S3.3 19.5 3.3 16.1s2.8-6.2 6.2-6.2c.4 0 .8 0 1.2.1v3.3c-.4-.1-.8-.2-1.2-.2-1.7 0-3.1 1.4-3.1 3.1s1.4 3.1 3.1 3.1 3.1-1.4 3.1-3.1V2h3.1c0 1.2.3 2.3 1 3.2Z" />
          </svg>
        </a>
        <a class="rv-social-link" href="https://www.instagram.com/rubikvault" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5Zm10 2H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3Zm-5 3.5a4.5 4.5 0 1 1 0 9 4.5 4.5 0 0 1 0-9Zm0 2a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5ZM17.8 6.2a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z" />
          </svg>
        </a>
      </nav>

      <div class="rv-header-tools" aria-live="polite">
        <div class="rv-market-clock">
          <span class="rv-clock-time" id="rv-ny-time">NY: --:--:--</span>
          <span class="rv-clock-status">
            <span class="rv-led" data-rv-led="closed"></span>
            <span class="rv-market-label" data-rv-market-label>Closed</span>
            <span class="rv-market-countdown" id="rv-market-countdown">opens in --:--:--</span>
          </span>
        </div>
        <button class="rv-theme-toggle" type="button" id="rv-theme-toggle" aria-label="Toggle theme">
          Dark
        </button>
      </div>
    </div>
    <div class="rv-data-updated" id="rv-data-updated" style="text-align: center; padding: 8px; font-size: 12px; color: var(--rv-text-muted); border-bottom: 1px solid var(--rv-border);">
      Data updated: <span id="rv-data-updated-date">Loading...</span> (daily snapshots)
    </div>
    <script>
      // Update date immediately when DOM is ready
      (function() {
        const updateDate = () => {
          const el = document.getElementById("rv-data-updated-date");
          if (el) {
            const today = new Date();
            const dateStr = today.toISOString().split("T")[0];
            el.textContent = dateStr;
          }
        };
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", updateDate);
        } else {
          updateDate();
        }
      })();
    </script>
  </header>

  <nav class="rv-subnav" aria-label="Dashboard sections">
    <a href="#cockpit">Overview</a>
    <a href="#news">News</a>
    <a href="#stocks">Stocks</a>
    <a href="#alpha-radar">Alpha Radar</a>
    <a href="#moats">Moats</a>
    <a href="#watchlist">My Watchlist</a>
  </nav>

  <!-- MAIN -->
  <main class="rv-main" id="rv-dashboard">
    <section class="rv-hero" id="rv-overview">
      <a id="cockpit" style="position: absolute; top: -110px;"></a>
      <div class="rv-hero-content">
        <h1>Decode the Markets.</h1>
        <p>
          RubikVault is a one-person research project focusing on stocks, crypto, macro
          and commodities – calm, data-driven and educational only. Daily snapshots provide transparent indicators. No financial advice.
        </p>
        <div class="rv-hero-actions">
          <a class="rv-btn-primary" href="https://www.youtube.com/@RubikVault" target="_blank" rel="noopener noreferrer">
            Watch on YouTube
          </a>
          <a class="rv-btn-secondary" href="https://x.com/RubikVault" target="_blank" rel="noopener noreferrer">
            Follow on X
          </a>
        </div>
      </div>

      <div class="rv-hero-side">
        <div class="rv-tag">Early Stage</div>
        <div class="rv-card">
          <h2>Market snapshot</h2>
          <p>
            A compact overview across equities, crypto, macro and commodities on a single page. Daily snapshots provide transparent indicators. No financial advice.
          </p>
          <p class="rv-card-note">
            All data is from daily snapshots (EOD for stocks/macro, 2×/day for crypto). No live aggregation per visitor.
          </p>
        </div>
      </div>
    </section>

    <section
      class="rv-section rv-native-block rv-cockpit-hero"
      data-rv-feature="rv-market-cockpit"
      data-rv-block-name="Market Snapshot"
      data-rv-priority="high"
      data-rv-loading="true"
      data-rv-collapsible="false"
    >
      <div class="rv-native-header">
        <h2>Market Snapshot <span class="rv-tooltip-wrapper"><span class="rv-tooltip-icon" aria-label="Information">ⓘ</span><span class="rv-tooltip-content"><strong>Market Snapshot</strong><br>Purpose: Quick market overview across equities, crypto, macro<br>Update: 15m<br>Limitations: EOD snapshots, no intraday</span></span></h2>
        <button class="rv-native-refresh" type="button" data-rv-action="refresh">Refresh</button>
      </div>
      <div class="rv-native-body rv-card">
        <div class="rv-native-skeleton">
          <div class="rv-native-line"></div>
          <div class="rv-native-line short"></div>
          <div class="rv-native-line"></div>
        </div>
        <div class="rv-native-root" data-rv-root></div>
      </div>
    </section>

    <section
      class="rv-section rv-native-block rv-metrics-dashboard"
      data-rv-feature="rv-metrics-dashboard"
      data-rv-block-name="Metrics Dashboard (V5)"
      data-rv-priority="high"
      data-rv-loading="true"
      data-rv-collapsible="false"
      data-rv-span="wide"
    >
      <div class="rv-native-header">
        <h2>Metrics Dashboard (V5) <span class="rv-tooltip-wrapper"><span class="rv-tooltip-icon" aria-label="Information">ⓘ</span><span class="rv-tooltip-content"><strong>Metrics Dashboard</strong><br>Purpose: Multi-layout preview (A-H) using a single SSOT fetch.<br>Update: 60–300s cache<br>Limitations: Snapshot-based, partial metrics allowed.</span></span></h2>
        <button class="rv-native-refresh" type="button" data-rv-action="refresh">Refresh</button>
      </div>
      <div class="rv-native-body rv-card">
        <div class="rv-native-skeleton">
          <div class="rv-native-line"></div>
          <div class="rv-native-line short"></div>
          <div class="rv-native-line"></div>
        </div>
        <div class="rv-native-root" data-rv-root></div>
      </div>
    </section>

    <!-- News Headlines (Public v1) -->
    <section
      class="rv-section rv-native-block"
      data-rv-feature="rv-news-headlines"
      data-rv-block-name="News Headlines"
      data-rv-priority="low"
      data-rv-loading="true"
      data-rv-collapsible="true"
      data-rv-span="wide"
    >
      <a id="news" style="position: absolute; top: -110px;"></a>
      <div class="rv-native-header">
        <h2>News Headlines <span class="rv-tooltip-wrapper"><span class="rv-tooltip-icon" aria-label="Information">ⓘ</span><span class="rv-tooltip-content"><strong>News Headlines</strong><br>Purpose: Curated RSS headlines across major market sources.<br>Data source: Snapshot (RSS mirrors)<br>Update: Every 5 minutes<br>Limitations: No intraday API calls, no financial advice.</span></span></h2>
        <button class="rv-native-refresh" type="button" data-rv-action="refresh">Refresh</button>
      </div>
      <div class="rv-native-body rv-card">
        <div class="rv-native-skeleton">
          <div class="rv-native-line"></div>
          <div class="rv-native-line short"></div>
          <div class="rv-native-line"></div>
        </div>
        <div class="rv-native-root" data-rv-root></div>
      </div>
    </section>

    <!-- S&P 500 Sectors (Public v1) -->
    <section
      class="rv-section rv-native-block"
      data-rv-feature="rv-sp500-sectors"
      data-rv-block-name="S&amp;P 500 Sectors"
      data-rv-priority="low"
      data-rv-loading="true"
      data-rv-collapsible="true"
      data-rv-span="wide"
    >
      <a id="stocks" style="position: absolute; top: -110px;"></a>
      <a id="sectors" style="position: absolute; top: -110px;"></a>
      <div class="rv-native-header">
        <h2>S&amp;P 500 Sectors <span class="rv-tooltip-wrapper"><span class="rv-tooltip-icon" aria-label="Information">ⓘ</span><span class="rv-tooltip-content"><strong>S&amp;P 500 Sectors</strong><br>Purpose: Daily performance of S&amp;P 500 sectors to identify relative strength/weakness.<br>Data source: Snapshot (Yahoo Finance sector data)<br>Update: Daily (EOD)<br>Limitations: No intraday data, no financial advice.</span></span></h2>
        <button class="rv-native-refresh" type="button" data-rv-action="refresh">Refresh</button>
      </div>
      <div class="rv-native-body rv-card">
        <div class="rv-native-skeleton">
          <div class="rv-native-line"></div>
          <div class="rv-native-line short"></div>
          <div class="rv-native-line"></div>
        </div>
        <div class="rv-native-root" data-rv-root></div>
      </div>
    </section>

    <!-- Tech Signals (Public v1) -->
    <section
      class="rv-section rv-native-block"
      data-rv-feature="rv-tech-signals" data-block-id="tech-signals"
      data-rv-block-name="Tech Signals"
      data-rv-priority="low"
      data-rv-loading="true"
      data-rv-collapsible="true"
      data-rv-span="wide"
    >
      <div class="rv-native-header">
        <h2>Top 20 Marketcap US <span class="rv-tooltip-wrapper"><span class="rv-tooltip-icon" aria-label="Information">ⓘ</span><span class="rv-tooltip-content"><strong>Top 20 Marketcap US</strong><br>Purpose: Technical indicators (RSI, MACD, Stoch RSI) for the largest US stocks by market cap.<br>Data source: Snapshot (stooq OHLC data)<br>Update: Daily (EOD)<br>Limitations: No intraday data, no financial advice.</span></span></h2>
        <button class="rv-native-refresh" type="button" data-rv-action="refresh">Refresh</button>
      </div>
      <div class="rv-native-body rv-card">
        <div class="rv-native-skeleton">
          <div class="rv-native-line"></div>
          <div class="rv-native-line short"></div>
          <div class="rv-native-line"></div>
        </div>
        <div class="rv-native-root" data-rv-root></div>
      </div>
    </section>

    <!-- RVCI Engine (Public v1) -->
    <section
      class="rv-section rv-native-block"
      data-rv-feature="rv-rvci-engine" data-block-id="rvci-engine"
      data-rv-block-name="RVCI Engine"
      data-rv-priority="low"
      data-rv-loading="true"
      data-rv-collapsible="true"
      data-rv-span="wide"
    >
      <div class="rv-native-header">
        <h2>RVCI Engine <span class="rv-tooltip-wrapper"><span class="rv-tooltip-icon" aria-label="Information">ⓘ</span><span class="rv-tooltip-content"><strong>RVCI Engine</strong><br>Purpose: Regime + breadth snapshot from the RVCI pipeline.<br>Data source: Static snapshot (EOD)<br>Update: Daily (EOD)<br>Limitations: Coverage may be degraded on free tier.</span></span></h2>
        <button class="rv-native-refresh" type="button" data-rv-action="refresh">Refresh</button>
      </div>
      <div class="rv-native-body rv-card">
        <div class="rv-native-skeleton">
          <div class="rv-native-line"></div>
          <div class="rv-native-line short"></div>
          <div class="rv-native-line"></div>
        </div>
        <div class="rv-native-root" data-rv-root></div>
      </div>
    </section>

    <section
      class="rv-section rv-native-block"
      data-rv-feature="rv-alpha-radar" data-block-id="alpha-radar"
      data-rv-block-name="Alpha Radar"
      data-rv-priority="low"
      data-rv-loading="true"
      data-rv-collapsible="true"
      data-rv-span="wide"
      id="rv-alpha"
      data-rv-anchor="alpha-radar"
    >
      <a id="alpha-radar" style="position: absolute; top: -110px;"></a>
      <div class="rv-native-header">
        <h2>Alpha Radar <span class="rv-tooltip-wrapper"><span class="rv-tooltip-icon" aria-label="Information">ⓘ</span><span class="rv-tooltip-content"><strong>Alpha Radar</strong><br>Purpose: Identifies potential trading setups based on technical conditions (RSI extremes, EMA21 reclaim, volume confirmation).<br>Data source: Snapshot (stooq OHLC data)<br>Update: Daily (EOD)<br>Limitations: No intraday data, no financial advice. Scoring combines setup and trigger conditions.</span></span></h2>
        <button class="rv-native-refresh" type="button" data-rv-action="refresh">Refresh</button>
      </div>
      <div class="rv-native-body rv-card">
        <div class="rv-native-skeleton">
          <div class="rv-native-line"></div>
          <div class="rv-native-line short"></div>
          <div class="rv-native-line"></div>
        </div>
        <div class="rv-native-root" data-rv-root></div>
      </div>
    </section>
    
    <!-- Monopoles / Economic Moats -->
    <section
      class="rv-section rv-native-block"
      data-rv-block-name="Monopoles / Economic Moats"
    >
      <a id="moats" style="position: absolute; top: -110px;"></a>
      <div class="rv-native-header">
        <h2>Monopoles / Economic Moats</h2>
        <span class="rv-tooltip-wrapper">
          <span class="rv-tooltip-icon" aria-label="Information">ⓘ</span>
          <span class="rv-tooltip-content">
            <strong>Economic Moats</strong><br>
            This section highlights companies with durable competitive advantages (moats) that create barriers to entry. These are educational examples of structural market positions. No financial advice. Data source: Public company information. Update: Static educational content.
          </span>
        </span>
      </div>
      <div class="rv-native-body rv-card">
        <div class="rv-moats-content">
          <p class="rv-moats-intro">
            Economic moats are structural advantages that protect a company's market position and profitability over time. 
            This section highlights examples of durable competitive advantages in US-tradable markets. 
            Understanding moats helps identify companies with sustainable business models, though disruption risks always exist.
          </p>
          
          <div class="rv-moats-category">
            <h3>Payment Rails</h3>
            <div class="rv-moats-examples">
              <div class="rv-moats-item">
                <strong>Visa (V) / Mastercard (MA)</strong>
                <p><strong>Warum Moat:</strong> Network effects create a two-sided marketplace where merchants and cardholders both benefit from more participants. High switching costs and regulatory barriers protect the duopoly.</p>
                <p><strong>Disruption-Risiko:</strong> Digital wallets (Apple Pay, Google Pay) and blockchain-based payments could bypass traditional rails, though adoption remains limited.</p>
              </div>
            </div>
          </div>
          
          <div class="rv-moats-category">
            <h3>Semiconductor Chokepoints</h3>
            <div class="rv-moats-examples">
              <div class="rv-moats-item">
                <strong>ASML (ASML)</strong>
                <p><strong>Warum Moat:</strong> Monopoly on extreme ultraviolet (EUV) lithography equipment required for cutting-edge chip manufacturing. Decades of R&D and capital intensity create insurmountable barriers.</p>
                <p><strong>Disruption-Risiko:</strong> Alternative lithography technologies or geopolitical restrictions could impact demand, though no viable competitor exists today.</p>
              </div>
            </div>
          </div>
          
          <div class="rv-moats-category">
            <h3>Foundry Dominance</h3>
            <div class="rv-moats-examples">
              <div class="rv-moats-item">
                <strong>TSMC (TSM)</strong>
                <p><strong>Warum Moat:</strong> Leading-edge semiconductor manufacturing requires massive capital investment ($20B+ per fab) and decades of process expertise. TSMC's scale and technology leadership create a near-monopoly on advanced nodes.</p>
                <p><strong>Disruption-Risiko:</strong> Geopolitical tensions (Taiwan risk) and potential government subsidies for competitors (Intel, Samsung) could shift market share over time.</p>
              </div>
            </div>
          </div>
          
          <div class="rv-moats-category">
            <h3>GPU Compute</h3>
            <div class="rv-moats-examples">
              <div class="rv-moats-item">
                <strong>NVIDIA (NVDA)</strong>
                <p><strong>Warum Moat:</strong> Dominance in AI/ML training infrastructure (CUDA ecosystem) creates software lock-in. Hardware performance leadership in data center GPUs drives pricing power.</p>
                <p><strong>Disruption-Risiko:</strong> AMD (AMD) and custom silicon (Google TPU, Amazon Trainium) are gaining traction, though CUDA's ecosystem remains the standard.</p>
              </div>
            </div>
          </div>
          
          <div class="rv-moats-category">
            <h3>Search & Advertising</h3>
            <div class="rv-moats-examples">
              <div class="rv-moats-item">
                <strong>Google (GOOGL)</strong>
                <p><strong>Warum Moat:</strong> Search engine market share (>90%) creates data network effects. Advertisers must be where users are, creating a self-reinforcing cycle.</p>
                <p><strong>Disruption-Risiko:</strong> Regulatory pressure (antitrust), AI-powered search (ChatGPT, Perplexity), and privacy changes (cookie deprecation) could erode the moat.</p>
              </div>
            </div>
          </div>
          
          <div class="rv-moats-category">
            <h3>OS & Enterprise Software</h3>
            <div class="rv-moats-examples">
              <div class="rv-moats-item">
                <strong>Microsoft (MSFT)</strong>
                <p><strong>Warum Moat:</strong> Windows OS dominance in enterprise creates switching costs. Office 365 and Azure cloud services create recurring revenue and ecosystem lock-in.</p>
                <p><strong>Disruption-Risiko:</strong> Open-source alternatives (Linux, LibreOffice) and cloud-native competitors (Google Workspace) exist, though enterprise inertia protects market share.</p>
              </div>
            </div>
          </div>
          
          <div class="rv-moats-category">
            <h3>Duopole / Tripole Examples</h3>
            <div class="rv-moats-examples">
              <div class="rv-moats-item">
                <strong>Boeing (BA) / Airbus (EADSY)</strong>
                <p><strong>Warum Moat:</strong> Commercial aircraft manufacturing requires massive capital, regulatory certification, and decades of expertise. The duopoly benefits from high barriers to entry.</p>
                <p><strong>Disruption-Risiko:</strong> Chinese competitor (COMAC) and potential new entrants (SpaceX, Boom Supersonic) could challenge the duopoly over decades.</p>
              </div>
              <div class="rv-moats-item">
                <strong>Moody's (MCO) / S&P Global (SPGI) / Fitch</strong>
                <p><strong>Warum Moat:</strong> Credit rating agencies benefit from regulatory recognition and network effects. Issuers need ratings to access capital markets.</p>
                <p><strong>Disruption-Risiko:</strong> Regulatory changes (Dodd-Frank) and alternative credit assessment methods (AI, blockchain) could reduce reliance on traditional ratings.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Watchlist v1 -->
    <section
      class="rv-section rv-native-block"
      data-rv-block-name="My Watchlist"
    >
      <a id="watchlist" style="position: absolute; top: -110px;"></a>
      <div class="rv-native-header">
        <h2>My Watchlist</h2>
        <span class="rv-tooltip-wrapper">
          <span class="rv-tooltip-icon" aria-label="Information">ⓘ</span>
          <span class="rv-tooltip-content">
            <strong>Watchlist v1</strong><br>
            Add stocks to your personal watchlist. Data is stored locally in your browser (localStorage). Export/Import JSON to transfer between devices. No login required. Data source: Tech Signals snapshot. Update: Daily (EOD).
          </span>
        </span>
      </div>
      <div class="rv-native-body rv-card">
        <div class="rv-watchlist-content">
          <div class="rv-watchlist-controls">
            <input
              type="text"
              id="rv-watchlist-input"
              placeholder="Enter symbol (e.g., AAPL)"
              class="rv-watchlist-input"
            />
            <button type="button" id="rv-watchlist-add" class="rv-btn-primary">Add</button>
            <button type="button" id="rv-watchlist-export" class="rv-btn-secondary">Export JSON</button>
            <button type="button" id="rv-watchlist-import" class="rv-btn-secondary">Import JSON</button>
            <input type="file" id="rv-watchlist-file" accept=".json" style="display: none;" />
          </div>
          <div id="rv-watchlist-status" class="rv-native-note" style="display:none;"></div>
          <div id="rv-watchlist-list" class="rv-watchlist-list"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER (ohne Bild, nur Text + Links) -->
  <footer class="rv-footer">
    <div class="rv-footer-top">
      <div class="rv-footer-brand">
        <span>RubikVault</span>
      </div>
      <div class="rv-footer-links">
        <a href="imprint.html">Imprint</a>
        <a href="privacy.html">Privacy</a>
        <a href="disclaimer.html">Disclaimer</a>
      </div>
    </div>
    <p class="rv-footer-disclaimer">
      RubikVault provides educational content only and does not offer financial advice or brokerage services.
    </p>
    <p class="rv-footer-copy">
      &copy; <span id="rv-year">2025</span> RubikVault. All rights reserved.
    </p>
  <script>
    // kleines JS, falls du kein extra script.js nutzen willst
    document.getElementById('rv-year').textContent = new Date().getFullYear();
  </script>
  </footer>
  <script type="module" src="./market-clock.js"></script>
  <script type="module" src="./rv-loader.js"></script>
  <script>
    // Watchlist v1 Functionality
    (function() {
      const STORAGE_KEY = "rv_watchlist_local";
      const inputEl = document.getElementById("rv-watchlist-input");
      const addBtn = document.getElementById("rv-watchlist-add");
      const exportBtn = document.getElementById("rv-watchlist-export");
      const importBtn = document.getElementById("rv-watchlist-import");
      const fileInput = document.getElementById("rv-watchlist-file");
      const listEl = document.getElementById("rv-watchlist-list");
      const statusEl = document.getElementById("rv-watchlist-status");
      const MAX_SYMBOLS = 20;
      const SYMBOL_RE = /^[A-Z0-9.:-]{1,8}$/;

      function setStatus(message) {
        if (!statusEl) return;
        if (!message) {
          statusEl.textContent = "";
          statusEl.style.display = "none";
          return;
        }
        statusEl.textContent = message;
        statusEl.style.display = "block";
      }

      function normalizeSymbol(value) {
        return String(value || "").trim().toUpperCase().replace(/\s+/g, "").slice(0, 8);
      }

      function normalizeList(input) {
        const list = Array.isArray(input) ? input : [];
        const cleaned = list
          .map((s) => normalizeSymbol(s))
          .filter((s) => SYMBOL_RE.test(s));
        const deduped = Array.from(new Set(cleaned));
        deduped.sort((a, b) => a.localeCompare(b));
        return deduped.slice(0, MAX_SYMBOLS);
      }
      
      function loadWatchlist() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return normalizeList(raw ? JSON.parse(raw) : []);
        } catch (e) {
          return [];
        }
      }
      
      function saveWatchlist(symbols) {
        try {
          const normalized = normalizeList(symbols);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(normalized));
          if (window.RV_SHARED) {
            window.RV_SHARED.watchlist = normalized;
          }
        } catch (e) {
          console.error("Failed to save watchlist:", e);
        }
      }
      
      function renderWatchlist() {
        const symbols = loadWatchlist();
        if (!symbols.length) {
          listEl.innerHTML = '<div class="rv-native-empty">No symbols in watchlist. Add symbols above.</div>';
          setStatus('Tip: max 20 symbols. Format: AAPL, BRK.B, BTC-USD');
          return;
        }
        setStatus(`Saved locally: ${symbols.length}/${MAX_SYMBOLS}`);
        listEl.innerHTML = symbols.map(symbol => `
          <div class="rv-watchlist-item">
            <span>${symbol.toUpperCase()}</span>
            <button type="button" class="rv-watchlist-remove" data-symbol="${symbol}">Remove</button>
          </div>
        `).join("");
        
        // Attach remove handlers
        listEl.querySelectorAll(".rv-watchlist-remove").forEach(btn => {
          btn.addEventListener("click", () => {
            const symbol = btn.getAttribute("data-symbol");
            const symbols = loadWatchlist().filter(s => s.toUpperCase() !== symbol.toUpperCase());
            saveWatchlist(symbols);
            renderWatchlist();
          });
        });
      }
      
      if (addBtn && inputEl) {
        addBtn.addEventListener("click", () => {
          const symbol = normalizeSymbol(inputEl.value);
          if (!symbol) return;
          if (!SYMBOL_RE.test(symbol)) {
            setStatus('Invalid symbol. Allowed: A-Z 0-9 . : - (max 8 chars)');
            return;
          }
          const symbols = loadWatchlist();
          if (symbols.includes(symbol)) {
            setStatus(`Already in watchlist: ${symbol}`);
            inputEl.value = "";
            return;
          }
          if (symbols.length >= MAX_SYMBOLS) {
            setStatus(`Watchlist limit reached (max ${MAX_SYMBOLS}). Remove one first.`);
            return;
          }
          symbols.push(symbol);
          saveWatchlist(symbols);
          inputEl.value = "";
          renderWatchlist();
        });
        
        inputEl.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            addBtn.click();
          }
        });
      }
      
      if (exportBtn) {
        exportBtn.addEventListener("click", () => {
          const symbols = loadWatchlist();
          const dataStr = JSON.stringify(symbols, null, 2);
          const blob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          const day = new Date().toISOString().slice(0, 10);
          a.download = `rubikvault-watchlist-${day}.json`;
          a.click();
          URL.revokeObjectURL(url);
          setStatus(`Exported ${symbols.length} symbols.`);
        });
      }
      
      if (importBtn && fileInput) {
        importBtn.addEventListener("click", () => {
          fileInput.click();
        });
        
        fileInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;
          if (!/\.json$/i.test(file.name)) {
            setStatus('Please select a .json file.');
            fileInput.value = "";
            return;
          }
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const parsed = JSON.parse(event.target.result);
              const symbols = normalizeList(parsed);
              if (!symbols.length) {
                setStatus('Import failed: no valid symbols found.');
                return;
              }
              saveWatchlist(symbols);
              renderWatchlist();
              setStatus(`Imported ${symbols.length} symbols.`);
            } catch (e) {
              setStatus("Failed to parse JSON: " + e.message);
            }
          };
          reader.readAsText(file);
          fileInput.value = "";
        });
      }
      
      // Initial render
      if (listEl) {
        renderWatchlist();
      }
    })();
  </script>
  </body>
</html>
