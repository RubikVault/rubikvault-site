<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RubikVault â€” Learning Dashboard</title>
  <meta name="description"
    content="TÃ¤gliches Learning-Dashboard: Wie effektiv lernen die 4 RubikVault-Features bei Vorhersagen?">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0e1a;
      --surface: #111827;
      --card: #1a2035;
      --card-hover: #1f2847;
      --border: #1e293b;
      --text: #e2e8f0;
      --text-dim: #94a3b8;
      --accent: #3b82f6;
      --accent-glow: rgba(59, 130, 246, 0.15);
      --green: #22c55e;
      --green-bg: rgba(34, 197, 94, 0.12);
      --red: #ef4444;
      --red-bg: rgba(239, 68, 68, 0.12);
      --yellow: #eab308;
      --yellow-bg: rgba(234, 179, 8, 0.12);
      --gray: #6b7280;
      --radius: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 20px;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 28px;
    }

    .header-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent-glow);
      border: 1px solid rgba(59, 130, 246, 0.25);
      border-radius: 20px;
      padding: 4px 14px;
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, #fff 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 6px;
    }

    .header .subtitle {
      color: var(--text-dim);
      font-size: 14px;
    }

    /* Status Banner */
    .status-banner {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .status-banner .status-text {
      font-size: 16px;
      font-weight: 700;
    }

    .status-banner .status-meta {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: var(--text-dim);
      flex-wrap: wrap;
    }

    .status-banner .status-meta span {
      white-space: nowrap;
    }

    /* Feature Cards Grid */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px;
      margin-bottom: 20px;
    }

    .feature-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }

    .feature-card:hover {
      background: var(--card-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .card-icon {
      font-size: 20px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 700;
    }

    .card-type {
      font-size: 11px;
      color: var(--text-dim);
    }

    .card-phase {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
      margin-left: auto;
    }

    .phase-bootstrap {
      background: var(--accent-glow);
      color: var(--accent);
    }

    .phase-learning {
      background: var(--green-bg);
      color: var(--green);
    }

    .phase-active {
      background: var(--green-bg);
      color: var(--green);
    }

    .phase-stagnant {
      background: var(--yellow-bg);
      color: var(--yellow);
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    .metric-row:last-child {
      border-bottom: none;
    }

    .metric-label {
      font-size: 12px;
      color: var(--text-dim);
    }

    .metric-value {
      font-size: 13px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .trend-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    .trend-improving {
      background: var(--green-bg);
      color: var(--green);
    }

    .trend-declining {
      background: var(--red-bg);
      color: var(--red);
    }

    .trend-stable {
      background: var(--yellow-bg);
      color: var(--yellow);
    }

    .trend-nodata {
      background: rgba(107, 114, 128, 0.12);
      color: var(--gray);
    }

    /* Sparkline */
    .sparkline-container {
      margin-top: 10px;
      height: 40px;
      width: 100%;
    }

    .sparkline-container svg {
      width: 100%;
      height: 40px;
    }

    .sparkline-empty {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray);
      font-size: 10px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 6px;
      margin-top: 10px;
    }

    /* Progress Bar */
    .progress-bar-bg {
      height: 5px;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 1s ease;
    }

    /* Trend Chart Section */
    .chart-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
    }

    .chart-section h2 {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chart-area {
      height: 160px;
      position: relative;
    }

    .chart-area svg {
      width: 100%;
      height: 100%;
    }

    .chart-legend {
      display: flex;
      gap: 16px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: var(--text-dim);
    }

    .chart-legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .chart-empty {
      height: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--gray);
      font-size: 13px;
    }

    .chart-empty .chart-icon {
      font-size: 32px;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    /* Weekly Comparison */
    .comparison-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
    }

    .comparison-section h2 {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .comparison-table th {
      text-align: left;
      padding: 8px 12px;
      color: var(--text-dim);
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }

    .comparison-table td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .comparison-table tr:last-child td {
      border-bottom: none;
    }

    .delta-positive {
      color: var(--green);
      font-weight: 600;
    }

    .delta-negative {
      color: var(--red);
      font-weight: 600;
    }

    .delta-neutral {
      color: var(--gray);
    }

    /* Diagnose Section */
    .diagnose-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
    }

    .diagnose-section h2 {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .diagnose-feature {
      margin-bottom: 20px;
    }

    .diagnose-feature:last-child {
      margin-bottom: 0;
    }

    .diagnose-feature-header {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border);
    }

    .diagnose-card {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 3px solid;
    }

    .diagnose-card.sev-critical {
      border-left-color: var(--red);
      background: var(--red-bg);
    }

    .diagnose-card.sev-warning {
      border-left-color: var(--yellow);
      background: var(--yellow-bg);
    }

    .diagnose-card.sev-info {
      border-left-color: var(--accent);
      background: var(--accent-glow);
    }

    .diagnose-card.sev-ok {
      border-left-color: var(--green);
      background: var(--green-bg);
    }

    .diagnose-title {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .diagnose-text {
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .fix-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .fix-item {
      padding: 6px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.04);
      font-size: 12px;
    }

    .fix-item:first-child {
      border-top: none;
    }

    .fix-what {
      font-weight: 700;
      color: var(--text);
      margin-bottom: 2px;
    }

    .fix-how {
      color: var(--text-dim);
      line-height: 1.5;
    }

    .fix-file {
      font-family: 'SF Mono', Consolas, monospace;
      font-size: 10px;
      color: var(--accent);
      opacity: 0.8;
      margin-top: 2px;
      display: block;
    }

    .loading {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-dim);
    }

    .loading .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .error-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--red);
    }

    .footer {
      text-align: center;
      padding: 16px;
      font-size: 11px;
      color: var(--gray);
    }

    @media (max-width: 700px) {
      .header h1 {
        font-size: 22px;
      }

      .cards-grid {
        grid-template-columns: 1fr;
      }

      .status-banner {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="header-badge">ğŸ§  Machine Learning Monitor</div>
      <h1>Learning Dashboard</h1>
      <p class="subtitle">Wie effektiv lernen die 4 Features bei Vorhersagen?</p>
    </div>
    <div id="app">
      <div class="loading">
        <div class="spinner"></div>
        <p>Lade Learning Report...</p>
      </div>
    </div>
    <div class="footer">RubikVault Learning System â€” Report wird tÃ¤glich um 20:00 CET aktualisiert</div>
  </div>

  <script>
    const REPORT_URL = '/data/reports/learning-report-latest.json';
    const FEATURE_META = {
      forecast: { icon: 'ğŸ“ˆ', color: '#3b82f6', label: 'Kursrichtung + Wahrscheinlichkeit', metricKey: 'forecast_accuracy_7d' },
      scientific: { icon: 'ğŸ”¬', color: '#8b5cf6', label: 'Setup/Trigger â†’ Breakout', metricKey: 'scientific_hit_rate_7d' },
      elliott: { icon: 'ğŸŒŠ', color: '#06b6d4', label: 'Wave-Richtung (bullish/bearish)', metricKey: 'elliott_accuracy_7d' },
      stock_analyzer: { icon: 'ğŸ“Š', color: '#f59e0b', label: 'Ranking-StabilitÃ¤t', metricKey: 'stock_stability' },
    };

    function pct(v) { return v != null ? `${(v * 100).toFixed(1)}%` : 'â€”'; }
    function num(v) { return v != null ? v.toFixed(4) : 'â€”'; }
    function trendBadge(t) {
      const m = { improving: ['â†‘ Besser', 'trend-improving'], declining: ['â†“ Schlechter', 'trend-declining'], stable: ['â†’ Stabil', 'trend-stable'] };
      const [text, cls] = m[t] || ['â€” Keine Daten', 'trend-nodata'];
      return `<span class="trend-badge ${cls}">${text}</span>`;
    }

    function learningPhase(feat, daysActive) {
      if (feat.accuracy_7d == null && feat.hit_rate_7d == null && feat.stability == null) {
        return `<span class="card-phase phase-bootstrap">ğŸ“¡ Sammelt Daten (Tag ${daysActive})</span>`;
      }
      const trend = feat.trend_accuracy || feat.trend_brier;
      if (trend === 'improving') return `<span class="card-phase phase-learning">ğŸš€ Lernt aktiv</span>`;
      if (trend === 'declining') return `<span class="card-phase phase-stagnant">âš ï¸ RÃ¼ckgang</span>`;
      return `<span class="card-phase phase-active">âœ… Aktiv</span>`;
    }

    // â”€â”€â”€ SVG Sparkline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function sparklineSVG(values, color, w = 200, h = 36) {
      const valid = values.filter(v => v != null);
      if (valid.length < 2) return '';
      const min = Math.min(...valid) * 0.95;
      const max = Math.max(...valid) * 1.05 || 1;
      const range = max - min || 1;
      const step = w / (values.length - 1);
      const points = [];
      let lastY = h / 2;
      values.forEach((v, i) => {
        if (v != null) {
          lastY = h - ((v - min) / range) * h;
          points.push(`${i * step},${lastY}`);
        }
      });
      if (points.length < 2) return '';
      const linePoints = points.join(' ');
      // Gradient fill
      const areaPoints = `0,${h} ${linePoints} ${(values.length - 1) * step},${h}`;
      return `<div class="sparkline-container">
    <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
      <defs>
        <linearGradient id="grad-${color.replace('#', '')}" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="${color}" stop-opacity="0.3"/>
          <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
        </linearGradient>
      </defs>
      <polygon points="${areaPoints}" fill="url(#grad-${color.replace('#', '')})" />
      <polyline points="${linePoints}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="${points[points.length - 1].split(',')[0]}" cy="${points[points.length - 1].split(',')[1]}" r="3" fill="${color}"/>
    </svg>
  </div>`;
    }

    // â”€â”€â”€ Large Trend Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function trendChartSVG(history, keys, colors, w = 1000, h = 140) {
      // Find all valid values across all keys
      let allVals = [];
      keys.forEach(k => history.forEach(h => { if (h[k] != null) allVals.push(h[k]); }));
      if (!allVals.length) return '';

      const min = Math.min(...allVals) * 0.9;
      const max = Math.max(...allVals) * 1.1 || 1;
      const range = max - min || 1;
      const step = w / Math.max(1, history.length - 1);
      const pad = 4;

      let lines = '';
      keys.forEach((key, ki) => {
        const points = [];
        history.forEach((h, i) => {
          if (h[key] != null) {
            const x = i * step;
            const y = pad + (h - pad) - ((h[key] - min) / range) * (h - 2 * pad);
            points.push(`${x},${pad + (140 - 2 * pad) - ((h[key] - min) / range) * (140 - 2 * pad)}`);
          }
        });
        if (points.length >= 2) {
          const lastPt = points[points.length - 1].split(',');
          lines += `<polyline points="${points.join(' ')}" fill="none" stroke="${colors[ki]}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.9"/>`;
          lines += `<circle cx="${lastPt[0]}" cy="${lastPt[1]}" r="4" fill="${colors[ki]}"/>`;
        }
      });

      // Y-axis labels
      const yLabels = `
    <text x="${w - 5}" y="${pad + 8}" fill="#666" font-size="10" text-anchor="end">${(max * 100).toFixed(0)}%</text>
    <text x="${w - 5}" y="${h - pad}" fill="#666" font-size="10" text-anchor="end">${(min * 100).toFixed(0)}%</text>
  `;
      // Grid lines
      const grid = `
    <line x1="0" y1="${h / 2}" x2="${w}" y2="${h / 2}" stroke="#1e293b" stroke-width="1" stroke-dasharray="4"/>
    <line x1="0" y1="${pad}" x2="${w}" y2="${pad}" stroke="#1e293b" stroke-width="0.5"/>
    <line x1="0" y1="${h - pad}" x2="${w}" y2="${h - pad}" stroke="#1e293b" stroke-width="0.5"/>
  `;

      return `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">${grid}${lines}${yLabels}</svg>`;
    }

    // â”€â”€â”€ Deep Feature Diagnosis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Returns thorough, feature-specific analysis with concrete fix steps
    function deepDiagnosis(key, feat, daysActive, history) {
      const preds = feat.predictions_today ?? feat.rankings_today ?? 0;
      const acc = feat.accuracy_7d;
      const brier = feat.brier_7d;
      const hr = feat.hit_rate_7d;
      const trendAcc = feat.trend_accuracy;

      // Compute trend from history data
      const metricKey = FEATURE_META[key].metricKey;
      const histVals = (history || []).map(h => h[metricKey]).filter(v => v != null);
      const weekVals = histVals.slice(-5); // last 5 trading days
      const monthVals = histVals.slice(-22); // last ~month
      const weekTrend = weekVals.length >= 2 ? weekVals[weekVals.length - 1] - weekVals[0] : null;
      const monthTrend = monthVals.length >= 5 ? monthVals[monthVals.length - 1] - monthVals[0] : null;

      const sections = []; // {title, severity, text, fixes[]}

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FORECAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (key === 'forecast') {
        if (preds === 0) {
          sections.push({
            title: 'ğŸ”´ Keine Predictions heute',
            severity: 'critical',
            text: 'Die Forecast-Pipeline hat heute keine Vorhersagen geliefert. Das System kann nur lernen, wenn tÃ¤glich Predictions geschrieben werden.',
            fixes: [
              { what: 'Pipeline-Zeitplan prÃ¼fen', how: 'GitHub Actions â†’ forecast-daily.yml muss VOR dem Learning-Cycle (19:00 UTC) laufen', file: '.github/workflows/forecast-daily.yml' },
              { what: 'Ledger-Pfad verifizieren', how: 'PrÃ¼fen ob mirrors/forecast/ledger/forecasts/YYYY/MM.ndjson.gz existiert und aktuell ist', file: 'scripts/forecast/ledger_writer.mjs' },
              { what: 'EODHD API-Limit prÃ¼fen', how: 'Wenn API-Limit erreicht, werden keine Forecast-Daten generiert. Budget-Ledger prÃ¼fen', file: 'public/data/v3/system/budget-ledger.json' },
            ]
          });
        }
        if (acc != null && acc < 0.50) {
          sections.push({
            title: 'ğŸ”´ Accuracy unter 50% â€” Schlechter als MÃ¼nzwurf',
            severity: 'critical',
            text: `Aktuelle Accuracy: ${pct(acc)}. Das Modell trifft weniger als die HÃ¤lfte der Richtungs-Vorhersagen. Wahrscheinliche Ursache: Die Champion-Selektion im forecast_engine.mjs wÃ¤hlt ein Modell, das auf vergangene Marktphasen Ã¼berangepasst ist.`,
            fixes: [
              { what: 'Champion-Selektion Ã¼berarbeiten', how: 'Die Funktion selectChampion() nutzt aktuell nur historische Backtest-Scores. Ersetze durch Walk-Forward-Validation mit Out-of-Sample-Fenster der letzten 5 Tage', file: 'scripts/forecast/forecast_engine.mjs â†’ selectChampion()' },
              { what: 'Feature-Drift erkennen', how: 'Vergleiche die Feature-Verteilung der Trainings-Daten mit den aktuellen Live-Daten. Bei Drift > 2Ïƒ: Modell-Retrain triggern', file: 'scripts/forecast/evaluator.mjs' },
              { what: 'Marktregime-Filter einbauen', how: 'Wenn VIX > 25 oder SPY-Drawdown > 3%, Forecast-Confidence automatisch auf 0.50 setzen (kein Signal)', file: 'scripts/forecast/forecast_engine.mjs â†’ applyRegimeFilter()' },
              { what: 'Probability-Calibration aktivieren', how: 'Isotonic Regression auf die letzten 30 Tage Predictions vs. Outcomes anwenden. Aktuell gibt das Modell systematisch Ã¼ber/unter-konfidente Wahrscheinlichkeiten aus', file: 'scripts/learning/lib/metrics.mjs â†’ calibrate()' },
            ]
          });
        } else if (acc != null && acc < 0.55) {
          sections.push({
            title: 'ğŸŸ¡ Accuracy 50-55% â€” Kaum besser als Zufall',
            severity: 'warning',
            text: `Accuracy: ${pct(acc)}. Das System hat minimale Vorhersagekraft. Die Wahrscheinlichkeits-Outputs sind wahrscheinlich schlecht kalibriert.`,
            fixes: [
              { what: 'Platt Scaling aktivieren', how: 'Logistic Regression auf Raw-Scores trainieren (sigmoid fit). Confidence-Output wird dadurch zuverlÃ¤ssiger', file: 'scripts/forecast/forecast_engine.mjs â†’ calibrateOutput()' },
              { what: 'Sector-spezifische Modelle testen', how: 'Tech-Aktien und Commodities haben unterschiedliche Momentum-Profile. Separate Modelle pro GICS-Sektor trainieren', file: 'scripts/forecast/forecast_engine.mjs' },
            ]
          });
        } else if (acc != null && acc >= 0.60) {
          sections.push({
            title: 'ğŸŸ¢ Accuracy Ã¼ber 60% â€” Gute Performance',
            severity: 'ok',
            text: `Accuracy: ${pct(acc)}. Das Modell arbeitet signifikant besser als Zufall. Fokus auf StabilitÃ¤t und Brier-Score-Optimierung.`,
            fixes: []
          });
        }
        if (brier != null && brier > 0.25) {
          sections.push({
            title: 'ğŸŸ¡ Brier Score zu hoch â€” Wahrscheinlichkeiten unzuverlÃ¤ssig',
            severity: 'warning',
            text: `Brier Score: ${num(brier)} (Ziel: < 0.20). Das Modell sagt zwar oft die richtige Richtung, aber die ausgegebenen Wahrscheinlichkeiten spiegeln nicht die tatsÃ¤chliche Trefferquote wider. Bei p_up=0.80 treffen Vorhersagen nicht 80% der FÃ¤lle.`,
            fixes: [
              { what: 'Calibration-Kurve berechnen', how: 'Vorhersagen in 10 Bins (0.0-0.1, 0.1-0.2, ...) gruppieren und tatsÃ¤chliche Trefferquote pro Bin berechnen. Abweichung > 5% zeigt Fehlkalibration', file: 'scripts/learning/lib/metrics.mjs â†’ buildCalibrationCurve()' },
              { what: 'Temperature Scaling', how: 'Einen einzigen Parameter T (Temperature) lernen, der alle Logits durch T teilt. Minimiert Brier Score auf Validierungsdaten', file: 'scripts/forecast/forecast_engine.mjs' },
            ]
          });
        }
        if (trendAcc === 'declining') {
          sections.push({
            title: 'ğŸ”´ Accuracy-Trend fallend â€” Feature verschlechtert sich',
            severity: 'critical',
            text: 'Die 7d-Accuracy sinkt im Vergleich zum Vorzeitraum. Das deutet auf Feature-Drift oder einen Marktregimewechsel hin.',
            fixes: [
              { what: 'Regime-Detektion implementieren', how: 'HMM (Hidden Markov Model) oder Bollinger-Band-Regime-Klassifikation einbauen. Bei Regime-Wechsel: Modell-Ensemble umschalten', file: 'scripts/forecast/forecast_engine.mjs' },
              { what: 'Rolling-Retrain aktivieren', how: 'Modell alle 5 Tage auf den letzten 60 Tagen neu trainieren statt statisches Modell zu verwenden', file: 'scripts/forecast/run_daily.mjs' },
            ]
          });
        }
        // Bootstrap state
        if (!acc && preds > 0) {
          sections.push({
            title: 'ğŸ“¡ Bootstrap-Phase â€” Daten werden gesammelt',
            severity: 'info',
            text: `${preds.toLocaleString()} Predictions heute geloggt. Erste Accuracy-Metriken erscheinen morgen (Horizont 1 Tag). Bis dahin wird der Ledger gefÃ¼llt.`,
            fixes: [
              { what: 'NÃ¤chster Schritt', how: 'Morgen nach dem nÃ¤chsten Learning-Cycle-Lauf prÃ¼fen, ob Accuracy-Werte erscheinen. Falls nicht: outcome-Resolution in run-daily-learning-cycle.mjs debuggen', file: 'scripts/learning/run-daily-learning-cycle.mjs â†’ resolveOutcomes()' },
            ]
          });
        }
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SCIENTIFIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (key === 'scientific') {
        if (preds === 0) {
          sections.push({
            title: 'ğŸ”´ Keine Scientific-Predictions',
            severity: 'critical',
            text: 'Keine Setup/Trigger-Signale aus dem Scientific Analyzer extrahiert.',
            fixes: [
              { what: 'Datenquelle prÃ¼fen', how: 'PrÃ¼fen ob public/data/supermodules/scientific-summary.json existiert und aktuell ist (Timestamp < 24h)', file: 'public/data/supermodules/scientific-summary.json' },
              { what: 'Supermodule-Pipeline prÃ¼fen', how: 'build-supermodules.mjs muss vor dem Learning-Cycle laufen', file: 'scripts/build-supermodules.mjs' },
            ]
          });
        }
        if (hr != null && hr < 0.30) {
          sections.push({
            title: 'ğŸ”´ Hit Rate unter 30% â€” Setup/Trigger zu freizÃ¼gig',
            severity: 'critical',
            text: `Hit Rate: ${pct(hr)}. Weniger als ein Drittel der Setups fÃ¼hrt zu einem â‰¥2% Breakout in der vorhergesagten Richtung. Die Signal-Schwellen filtern zu wenig.`,
            fixes: [
              { what: 'Signal-Strength-Schwelle erhÃ¶hen', how: 'In scientific-summary.json haben strong_signals ein signal_strength-Feld. Aktuell werden alle mit strength > 0 genommen. Schwelle auf > 70 erhÃ¶hen', file: 'scripts/build-scientific-summary.mjs â†’ filterSignals()' },
              { what: 'Trigger-Bedingungen verschÃ¤rfen', how: 'Trigger-Status (trigger.met=true) nur setzen wenn Volume > 1.5x Avg UND Price > Resistance. Aktuell reicht nur eines der Kriterien', file: 'scripts/supermodules/ â†’ trigger-evaluation' },
              { what: 'Breakout-Threshold dynamisch machen', how: '2%-Threshold ist fix. Besser: ATR(14)-basierter Threshold, da volatile Aktien andere Schwellen brauchen als low-vol Aktien', file: 'scripts/learning/run-daily-learning-cycle.mjs â†’ resolveOutcomes()' },
              { what: 'Sector-Filter einbauen', how: 'Biotech/Small-Cap Setups haben fundamental andere Breakout-Raten als Large-Cap. Separate Trigger-Schwellen pro Sektor definieren', file: 'scripts/build-scientific-summary.mjs' },
            ]
          });
        } else if (hr != null && hr < 0.40) {
          sections.push({
            title: 'ğŸŸ¡ Hit Rate 30-40% â€” Verbesserungspotenzial',
            severity: 'warning',
            text: `Hit Rate: ${pct(hr)}. Ordentlich, aber noch weit von 50%+ entfernt.`,
            fixes: [
              { what: 'Multi-Timeframe-BestÃ¤tigung', how: 'Setup nur triggern wenn Signal auf Daily UND Weekly Chart konsistent ist. Aktuell nur Daily', file: 'scripts/supermodules/' },
              { what: 'Volume-BestÃ¤tigung hinzufÃ¼gen', how: 'Breakouts ohne erhÃ¶htes Volumen scheitern hÃ¤ufiger. Volume > 2x 20d-Avg als Pflichtkriterium', file: 'scripts/build-scientific-summary.mjs' },
            ]
          });
        } else if (hr != null && hr >= 0.40) {
          sections.push({
            title: 'ğŸŸ¢ Hit Rate Ã¼ber 40% â€” Setup/Trigger filtert effektiv',
            severity: 'ok',
            text: `Hit Rate: ${pct(hr)}. Die Kombination aus Setup + Trigger produziert Ã¼berdurchschnittliche Breakout-Signale.`,
            fixes: []
          });
        }
        if (!hr && preds > 0) {
          sections.push({
            title: 'ğŸ“¡ Bootstrap-Phase â€” Warten auf Outcomes',
            severity: 'info',
            text: `${preds.toLocaleString()} Setup/Trigger-Signale geloggt. Hit Rate erscheint nach 5 Trading-Tagen, da Breakouts mit 5d-Horizont gemessen werden.`,
            fixes: [
              { what: 'NÃ¤chster Schritt', how: 'Nach 5 Trading-Tagen prÃ¼fen ob Hit Rate-Werte erscheinen. 40%+ = gut, < 30% = Trigger-Logik zu permissiv', file: 'scripts/learning/run-daily-learning-cycle.mjs â†’ resolveOutcomes()' },
            ]
          });
        }
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ELLIOTT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (key === 'elliott') {
        if (acc != null && acc < 0.50) {
          sections.push({
            title: 'ğŸ”´ Elliott-Accuracy unter 50% â€” Wave-Counts unzuverlÃ¤ssig',
            severity: 'critical',
            text: `Accuracy: ${pct(acc)}. Die Elliott-Wave-Richtungsvorhersagen sind schlechter als Zufall. Hauptproblem: Die automatische Wave-ZÃ¤hlung ist mehrdeutig â€” verschiedene Counts sind gleichzeitig valide.`,
            fixes: [
              { what: 'Confidence-Filter einbauen', how: 'Nur Predictions mit wave_confidence > 0.6 verwenden. Aktuell werden alle Wave-Counts als gleichwertig behandelt', file: 'scripts/learning/run-daily-learning-cycle.mjs â†’ extractElliottPredictions()' },
              { what: 'Alternative-Count-Logik', how: 'Wenn bullisher UND bearischer Count gleichzeitig valide sind â†’ Signal als "neutral" markieren statt willkÃ¼rlich einen zu wÃ¤hlen', file: 'functions/api/elliott-scanner.js' },
              { what: 'Zeitrahmen-Gewichtung', how: 'Daily-Waves geben kurzfristige Signale, Monthly-Waves langfristige. FÃ¼r 5d-Horizont nur Daily/Weekly Counts verwenden, Monthly ignorieren', file: 'scripts/learning/run-daily-learning-cycle.mjs â†’ extractElliottPredictions()' },
              { what: 'Invalidation-Levels nutzen', how: 'Jeder Wave-Count hat ein Invalidation-Level. Wenn Preis > Invalidation â†’ Count sofort als "falsch" werten und alternative ZÃ¤hlung aktivieren', file: 'functions/api/elliott-scanner.js' },
            ]
          });
        } else if (acc != null && acc < 0.55) {
          sections.push({
            title: 'ğŸŸ¡ Elliott-Accuracy 50-55% â€” Minimale Edge',
            severity: 'warning',
            text: `Accuracy: ${pct(acc)}. Leicht Ã¼ber Zufall, aber nicht signifikant. Das Volume an Predictions (${(feat.predictions_today || 0).toLocaleString()}) dilutiert wahrscheinlich die QualitÃ¤t.`,
            fixes: [
              { what: 'Top-Confidence-Filter', how: 'Statt alle 50k+ Wave-Counts zu werten: nur Top 200 mit hÃ¶chster Confidence auswÃ¤hlen. QualitÃ¤t > QuantitÃ¤t', file: 'scripts/learning/run-daily-learning-cycle.mjs â†’ extractElliottPredictions()' },
              { what: 'Wave-Completion-Score', how: 'Waves in fortgeschrittenem Stadium (Wave 3, Wave 5) haben klarere Richtung als Wave 1/2. Completion-Score als Gewicht nutzen', file: 'functions/api/elliott-scanner.js' },
            ]
          });
        }
        if (preds > 10000) {
          sections.push({
            title: 'âš ï¸ Zu viele Predictions â€” QualitÃ¤t leidet',
            severity: 'warning',
            text: `${preds.toLocaleString()} Predictions ist extrem viel. Die meisten sind wahrscheinlich Low-Confidence Wave-Counts. Das verwÃ¤ssert die Accuracy-Metrik.`,
            fixes: [
              { what: 'Prediction-Count reduzieren', how: 'Nur Ticker/Timeframe-Kombinationen mit wave_quality > 70 in das Ledger schreiben. Das reduziert auf ~500-2000 hochwertige Predictions', file: 'scripts/learning/run-daily-learning-cycle.mjs â†’ extractElliottPredictions()' },
            ]
          });
        }
        if (!acc && preds > 0) {
          sections.push({
            title: 'ğŸ“¡ Bootstrap-Phase â€” Warten auf 5d-Outcomes',
            severity: 'info',
            text: `${preds.toLocaleString()} Wave-Direction-Predictions geloggt. Accuracy erscheint nach 5 Trading-Tagen. Bei so vielen Predictions: sofort Top-Confidence-Filter einbauen.`,
            fixes: [
              { what: 'DRINGEND: Volume reduzieren', how: 'Vor dem nÃ¤chsten Cycle: extractElliottPredictions() um Confidence-Filter erweitern, sonst werden 50k+ Outcomes berechnet was extrem langsam ist', file: 'scripts/learning/run-daily-learning-cycle.mjs â†’ extractElliottPredictions()' },
            ]
          });
        }
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STOCK ANALYZER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (key === 'stock_analyzer') {
        if (feat.stability != null && feat.stability < 0.70) {
          sections.push({
            title: 'ğŸ”´ Ranking instabil â€” Top-50 wechselt zu stark',
            severity: 'critical',
            text: `StabilitÃ¤t: ${pct(feat.stability)}. Weniger als 70% der Top-50-Aktien von gestern sind heute noch in den Top 50. Das deutet auf rauschende Scores hin.`,
            fixes: [
              { what: 'Score-Smoothing einbauen', how: 'Exponential Moving Average (Î±=0.3) Ã¼ber score_0_100 der letzten 5 Tage anwenden. Jeet-Wechsel werden geglÃ¤ttet', file: 'scripts/universe-v7/build-stock-ssot.mjs' },
              { what: 'Minimum-Halteperiode', how: 'Aktie muss 3 Tage in Folge Score > Threshold haben bevor sie in Top-50 aufsteigt. Verhindert One-Day-Spikes', file: 'scripts/universe-v7/build-stock-ssot.mjs' },
              { what: 'Score-Komponenten analysieren', how: 'PrÃ¼fen welche Teilscores am meisten flickern (Momentum? Volume? Earnings?). Den instabilsten Teilscore mit geringerem Gewicht versehen', file: 'scripts/universe-v7/build-stock-ssot.mjs â†’ computeScore()' },
            ]
          });
        } else if (feat.stability != null && feat.stability < 0.85) {
          sections.push({
            title: 'ğŸŸ¡ Ranking-StabilitÃ¤t akzeptabel aber verbesserbar',
            severity: 'warning',
            text: `StabilitÃ¤t: ${pct(feat.stability)}. Normaler Bereich, aber hÃ¶here StabilitÃ¤t (>85%) wÃ¤re fÃ¼r Portfolio-Tauglichkeit wÃ¼nschenswert.`,
            fixes: [
              { what: 'Hysterese-Band einbauen', how: 'Aktie fÃ¤llt erst aus Top-50 wenn Score unter Rang 65 fÃ¤llt (nicht 51). Vermeidet Flip-Flopping an der Grenze', file: 'scripts/universe-v7/build-stock-ssot.mjs' },
            ]
          });
        } else if (feat.stability != null && feat.stability >= 0.85) {
          sections.push({
            title: 'ğŸŸ¢ Ranking stabil â€” Scores sind konsistent',
            severity: 'ok',
            text: `StabilitÃ¤t: ${pct(feat.stability)}. Die Rankings sind Ã¼ber Tage hinweg konsistent. Portfolio auf Basis dieser Rankings wÃ¤re handelbar.`,
            fixes: []
          });
        }
        if (feat.stability == null) {
          sections.push({
            title: 'ğŸ“¡ Ranking-StabilitÃ¤t noch nicht messbar',
            severity: 'info',
            text: `${preds} Rankings geloggt. StabilitÃ¤t wird ab Tag 2 berechnet (Vergleich: heutige Top-50 vs. gestrige Top-50). Morgen erscheint der erste Wert.`,
            fixes: [
              { what: 'NÃ¤chster Schritt', how: 'Morgen prÃ¼fen ob StabilitÃ¤t erscheint. Zielwert: > 85%. Bei < 70%: Score-Smoothing implementieren', file: 'scripts/learning/run-daily-learning-cycle.mjs â†’ computeRankingStability()' },
            ]
          });
        }
      }

      // â”€â”€â”€â”€ General period-based analysis â”€â”€â”€â”€
      if (weekTrend != null && weekTrend < -0.02) {
        sections.push({
          title: `ğŸ“‰ Wochentrend: ${(weekTrend * 100).toFixed(1)}% RÃ¼ckgang`,
          severity: 'warning',
          text: `Die Hauptmetrik hat sich diese Woche um ${(Math.abs(weekTrend) * 100).toFixed(1)} Prozentpunkte verschlechtert.`,
          fixes: [
            { what: 'Markt-Kontext prÃ¼fen', how: 'Wurde das Marktregime gewechselt (Risk-On â†’ Risk-Off)? Bei ja: Feature-Parameter fÃ¼r neues Regime adjustieren', file: '' },
            { what: 'Overfitting-Check', how: 'Wenn die letzte Woche die erste Woche mit Live-Daten war: Backtest-Overfit wahrscheinlich. Walk-Forward-Validation einbauen', file: '' },
          ]
        });
      }
      if (monthTrend != null && monthTrend < -0.03) {
        sections.push({
          title: `ğŸ“‰ Monatstrend: ${(monthTrend * 100).toFixed(1)}% RÃ¼ckgang Ã¼ber 30 Tage`,
          severity: 'critical',
          text: `Anhaltender RÃ¼ckgang Ã¼ber den gesamten Monat. Das Feature lernt nicht effektiv oder verschlechtert sich aktiv.`,
          fixes: [
            { what: 'Fundamentales Redesign nÃ¶tig', how: 'Bei > 30 Tagen RÃ¼ckgang: Feature-Logik grundlegend Ã¼berdenken. Historische Analyse der fehlgeschlagenen Predictions auf Muster prÃ¼fen', file: '' },
          ]
        });
      }

      return sections;
    }

    // â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function render(report) {
      const r = report;
      const daysActive = r.days_active || 1;
      const history = r.history || [];

      const statusColor = r.summary.overall_status.includes('BESSER') ? 'var(--green)' :
        r.summary.overall_status.includes('SCHLECHTER') ? 'var(--red)' :
          r.summary.overall_status.includes('BOOTSTRAP') ? 'var(--accent)' : 'var(--yellow)';

      // Data freshness
      const genTime = new Date(r.generated_at);
      const ageMin = Math.round((Date.now() - genTime) / 60000);
      const freshness = ageMin < 60 ? `vor ${ageMin} Min` : ageMin < 1440 ? `vor ${Math.round(ageMin / 60)} Std` : `vor ${Math.round(ageMin / 1440)} Tagen`;

      // Feature Cards
      const featureOrder = ['forecast', 'scientific', 'elliott', 'stock_analyzer'];
      const cardsHTML = featureOrder.map(key => {
        const feat = r.features[key];
        if (!feat) return '';
        const meta = FEATURE_META[key];
        const isStock = key === 'stock_analyzer';

        // Sparkline data from history
        const sparkData = history.map(h => h[meta.metricKey]);
        const sparkHTML = sparkData.some(v => v != null) ? sparklineSVG(sparkData, meta.color)
          : `<div class="sparkline-empty">ğŸ“Š Trend erscheint nach ersten Outcomes</div>`;

        let metricsHTML = '';
        if (!isStock) {
          metricsHTML += metricRow('Accuracy (7d)', pct(feat.accuracy_7d), trendBadge(feat.trend_accuracy));
          metricsHTML += metricRow('Accuracy (30d)', pct(feat.accuracy_all));
          if (feat.brier_7d != null) metricsHTML += metricRow('Brier Score', num(feat.brier_7d), trendBadge(feat.trend_brier));
          if (feat.hit_rate_7d != null) metricsHTML += metricRow('Hit Rate (7d)', pct(feat.hit_rate_7d));
          metricsHTML += metricRow('Predictions', (feat.predictions_today ?? 0).toLocaleString());
        } else {
          metricsHTML += metricRow('StabilitÃ¤t', pct(feat.stability));
          metricsHTML += metricRow('Churn', feat.churn != null ? String(feat.churn) : 'â€”');
          metricsHTML += metricRow('Rankings', (feat.rankings_today ?? 0).toLocaleString());
        }

        const accVal = feat.accuracy_7d ?? feat.accuracy_all ?? feat.stability;
        const progressHTML = accVal != null ? `<div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${Math.min(100, accVal * 100)}%;background:${meta.color}"></div></div>` : '';

        return `<div class="feature-card">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:${meta.color};opacity:0.7"></div>
      <div class="card-header">
        <span class="card-icon">${meta.icon}</span>
        <div><div class="card-title">${feat.name}</div><div class="card-type">${meta.label}</div></div>
        ${learningPhase(feat, daysActive)}
      </div>
      ${metricsHTML}${progressHTML}${sparkHTML}
    </div>`;
      }).join('');

      // Trend Chart
      const hasHistoryData = history.some(h =>
        h.forecast_accuracy_7d != null || h.scientific_hit_rate_7d != null || h.elliott_accuracy_7d != null
      );
      const chartKeys = ['forecast_accuracy_7d', 'scientific_hit_rate_7d', 'elliott_accuracy_7d'];
      const chartColors = ['#3b82f6', '#8b5cf6', '#06b6d4'];
      const chartSVG = hasHistoryData ? trendChartSVG(history, chartKeys, chartColors) : '';

      const chartSection = `<div class="chart-section">
    <h2>ğŸ“‰ Entwicklung Ã¼ber Zeit (30 Tage)</h2>
    ${chartSVG ? `<div class="chart-area">${chartSVG}</div>
      <div class="chart-legend">
        <div class="chart-legend-item"><div class="chart-legend-dot" style="background:#3b82f6"></div> Forecast Accuracy</div>
        <div class="chart-legend-item"><div class="chart-legend-dot" style="background:#8b5cf6"></div> Scientific Hit Rate</div>
        <div class="chart-legend-item"><div class="chart-legend-dot" style="background:#06b6d4"></div> Elliott Accuracy</div>
      </div>` :
          `<div class="chart-empty"><div class="chart-icon">ğŸ“ˆ</div>
        <div>Trend-Chart erscheint nach den ersten Outcome-Daten</div>
        <div style="font-size:11px;margin-top:4px;color:var(--text-dim)">Forecast: nach 1 Tag Â· Scientific/Elliott: nach 5 Tagen</div>
      </div>`}
  </div>`;

      // Weekly Comparison
      const wc = r.weekly_comparison || {};
      const compRows = [
        { name: 'ğŸ“ˆ Forecast', ...wc.forecast },
        { name: 'ğŸ”¬ Scientific', ...wc.scientific },
        { name: 'ğŸŒŠ Elliott', ...wc.elliott },
      ].map(row => {
        const tw = row.this_week, lw = row.last_week;
        const delta = (tw != null && lw != null) ? tw - lw : null;
        const deltaClass = delta == null ? 'delta-neutral' : delta > 0.005 ? 'delta-positive' : delta < -0.005 ? 'delta-negative' : 'delta-neutral';
        const deltaText = delta != null ? `${delta > 0 ? '+' : ''}${(delta * 100).toFixed(1)}%` : 'â€”';
        return `<tr>
      <td>${row.name}</td>
      <td style="text-align:center;font-weight:600">${pct(tw)}</td>
      <td style="text-align:center">${pct(lw)}</td>
      <td style="text-align:center" class="${deltaClass}">${deltaText}</td>
    </tr>`;
      }).join('');

      const compSection = `<div class="comparison-section">
    <h2>ğŸ“Š Woche-Ã¼ber-Woche Vergleich</h2>
    <table class="comparison-table">
      <tr><th>Feature</th><th>Diese Woche</th><th>Letzte Woche</th><th>VerÃ¤nderung</th></tr>
      ${compRows}
    </table>
  </div>`;

      // Deep Diagnosis per Feature
      const diagHTML = featureOrder.map(key => {
        const feat = r.features[key];
        if (!feat) return '';
        const meta = FEATURE_META[key];
        const sections = deepDiagnosis(key, feat, daysActive, history);
        if (!sections.length) return '';

        const cardsHTML = sections.map(s => {
          const fixesHTML = s.fixes.length ? `<ul class="fix-list">${s.fixes.map(f =>
            `<li class="fix-item">
          <div class="fix-what">â†’ ${f.what}</div>
          <div class="fix-how">${f.how}</div>
          ${f.file ? `<span class="fix-file">ğŸ“ ${f.file}</span>` : ''}
        </li>`).join('')}</ul>` : '';
          return `<div class="diagnose-card sev-${s.severity}">
        <div class="diagnose-title">${s.title}</div>
        <div class="diagnose-text">${s.text}</div>
        ${fixesHTML}
      </div>`;
        }).join('');

        return `<div class="diagnose-feature">
      <div class="diagnose-feature-header" style="color:${meta.color}">${meta.icon} ${feat.name}</div>
      ${cardsHTML}
    </div>`;
      }).join('');

      document.getElementById('app').innerHTML = `
    <div class="status-banner">
      <div><div class="status-text" style="color:${statusColor}">${r.summary.overall_status}</div></div>
      <div class="status-meta">
        <span>ğŸ“… ${formatDate(r.date)}</span>
        <span>ğŸ“¡ Tag ${daysActive}</span>
        <span>ğŸ”® ${r.summary.total_predictions_today.toLocaleString()} Vorhersagen</span>
        <span>ğŸ• ${freshness}</span>
      </div>
    </div>
    <div class="cards-grid">${cardsHTML}</div>
    ${chartSection}
    ${compSection}
    <div class="diagnose-section">
      <h2>ğŸ” Diagnose & Konkrete Nachbesserungen pro Feature</h2>
      ${diagHTML}
    </div>`;
    }

    function metricRow(label, value, extra = '') {
      return `<div class="metric-row"><span class="metric-label">${label}</span><span class="metric-value">${value} ${extra}</span></div>`;
    }

    function formatDate(ds) {
      const m = ['Jan', 'Feb', 'MÃ¤r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
      const [y, mo, d] = ds.split('-');
      return `${parseInt(d)}. ${m[parseInt(mo) - 1]} ${y}`;
    }

    async function loadAndRender() {
      try {
        const res = await fetch(REPORT_URL);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        render(await res.json());
      } catch {
        document.getElementById('app').innerHTML = `<div class="error-state">
      <p style="font-size:18px;margin-bottom:8px">âš ï¸ Report nicht verfÃ¼gbar</p>
      <p style="font-size:13px;color:var(--text-dim)">Starte zuerst:<br>
        <code style="background:var(--card);padding:4px 8px;border-radius:4px;margin-top:8px;display:inline-block">
          node scripts/learning/run-daily-learning-cycle.mjs</code></p></div>`;
      }
    }
    loadAndRender();
  </script>
</body>

</html>