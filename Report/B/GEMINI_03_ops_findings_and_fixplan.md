# OPS Findings & Fix Plan (Audit v1.1)

## 1. RUNTIME_MODE Semantic Mismatch (P0)

### Symptom
On the LIVE production environment (`https://d86f7e35.rubikvault-site.pages.dev`), the Ops UI reports `Runtime mode: PREVIEW`.
User expects: `PRODUCTION`.

### Root Cause
The function `detectPreviewMode` in `functions/api/mission-control/summary.js` (lines 744-756) strictly re-verifies production status based on hostname allowances:
```javascript
  const isProd = hostname === 'rubikvault.com' || hostname === 'www.rubikvault.com';
  // ...
  return {
    isPreview: isPages || isLocalhost, // .pages.dev is considered PREVIEW
    isProduction: isProd,
    // ...
  };
```
The logic assumes only the custom domain `rubikvault.com` constitutes "Production". Cloudflare Pages `*.pages.dev` domains are treated as Preview/Development environments, even if they are the main branch deployment.

### Expected Semantics (SSOT)
Production deployments should be identified either by:
1.  **Environment Variable:** `CF_PAGES_BRANCH === 'main'` (Standard Cloudflare).
2.  **Hostname Allowlist:** Update allowlist to include `rubikvault-site.pages.dev` (if that is the canonical prod url).
3.  **Binding Check:** If `CRON_TRIGGER` and `RV_KV` (WRITE) are bound, implied Production capability.

### Fix Plan
**Location:** `functions/api/mission-control/summary.js` : `detectPreviewMode`.

**Fix:**
```javascript
function detectPreviewMode(url, env) {
   // ...
   const isMainBranch = env.CF_PAGES_BRANCH === 'main'; // Requires env var to be exposed
   // OR
   const isProdPages = hostname === 'rubikvault-site.pages.dev'; // Hardcode known prod URL
   const isProd = hostname === 'rubikvault.com' || isProdPages;
   // ...
}
```

## 2. API Code Visibility
The file `functions/api/mission-control/summary.js` implements the complex logic for the OPS summary. It was initially hard to locate because standard naming conventions might suggest `functions/api/mission-control.js` handles it, but it is a separate file handling a specific sub-resource. This is valid but not immediately obvious without directory inspection.

## 3. Baseline Divergence
The file `public/data/ops-daily.json` (generated by `build-ops-daily.mjs`) serves as a *baseline*, but the live API (`summary.js`) overrides almost all fields with fresher runtime data (KV telemetry, latest snapshot reads). This is **CORRECT** design (Static Baseline + Runtime Overlay), but explains why `ops-daily.json` content does not match the live API response exactly.

## 4. Middleware Transparency
The `functions/api/_middleware.js` correctly handles fallbacks but does not interfere with the logic in `summary.js`. The `meta` fields in the response come directly from `summary.js` (lines 1591+), not the middleware.


## Appendix: Raw Live Evidence Excerpts

### LIVE_URL/api/mission-control/summary?debug=1
```json
{"schema_version":"1.0","module":"mission-control","served_from":"ASSET", ... "meta":{"status":"fresh","provider":"unknown"}}
```

(Note: Full response captured in audit log but not stored as file per constraints)
