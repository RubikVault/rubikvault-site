# Forensic CI/CD Audit Analysis

**Date:** 2026-02-10
**Audit Scope:** 20+ Workflows
**Status:** COMPLETE

## 1. Root Cause Clusters (ACTIVE_BROKEN)

Analysis of failure logs reveals three distinct failure patterns affecting critical workflows.

### Cluster A: Cloudflare WAF Blocking (HTTP 403)
**Workflows:** `Scheduler_Kick`, `Monitor_Production_Artifacts`
**Evidence:** 
- `Scheduler_Kick` log shows Cloudflare "Just a moment..." challenge HTML page.
- `Monitor_Production_Artifacts` fails with `curl: (22) ... error: 403`.
**Root Cause:** GitHub Actions runners are being flagged as bots by Cloudflare when hitting public endpoints (`rubikvault.com/api/...`).
**Impact:** Scheduler is not triggering, leading to stale data updates. Monitoring is blind.

### Cluster B: Data Safety Interlocks
**Workflows:** `EOD_Latest__NASDAQ_100_`
**Evidence:** `FAIL: expected=100 but fetched=0 (empty artifact generation blocked)`
**Root Cause:** The script `build-eod-latest.mjs` correctly prevented an empty update from overwriting valid data. The underlying issue is likely upstream data fetch returning 0 results (e.g. EODHD API or Universe file issue).
**Impact:** Daily stock data is stuck/stale.

### Cluster C: Missing Artifact Dependencies
**Workflows:** `v3_Finalizer`, `v3_Scrape_Template`
**Evidence:** `ENOENT: no such file or directory ... public/data/registry/modules.json`
**Root Cause:** `v3_Finalizer` expects a file generated by a previous step or workflow (`v3_Scrape_Template`?), which is not present. This suggests a broken chain of artifacts between workflows.

### Cluster D: Ops Instability
**Workflows:** `Ops_Daily_Snapshot`
**Evidence:** 6% success rate (28/30 failed). Logs were inaccessible for the failed run analyzed, but the high failure rate correlates with the data pipeline issues (EOD_Latest failing).
**Impact:** Operational dashboards are unreliable.

---

## 2. Prioritized Repair Roadmap

### Phase 1: Critical Fixes (P0) - Rescue Data Pipeline
1.  **Fix Scheduler Access (Cluster A):**
    - **Action:** Rotate/Update `RV_ADMIN_TOKEN` and ensure it's passed in headers `x-admin-token`.
    - **Alternate:** If WAF is blocking despite token, allow-list GitHub Actions (hard) OR switch to triggering via Cloudflare Access Service Token OR use a Worker-to-Worker trigger.
2.  **Debug EOD Fetch (Cluster B):**
    - **Action:** Run `scripts/eod/build-eod-latest.mjs` locally with verbose logging to see *why* it fetches 0 items. Check `public/data/universe/nasdaq100.json` content.
    - **Fix:** Ensure universe file is populated and API keys are valid.

### Phase 2: Stabilization (P1)
3.  **Repair v3 Dependency Chain (Cluster C):**
    - **Action:** Verify where `registry/modules.json` should come from. If `v3_Scrape_Template` generates it, fix that workflow first (it is also failing).
    - **Fix:** Ensure `upload-artifact` and `download-artifact` are correctly used to pass state between jobs/workflows.

### Phase 3: Monitoring & Cleanup (P2)
4.  **Fix Monitor (Cluster A):**
    - **Action:** Same as Scheduler; usage of `curl` against public endpoints is fragile. Update to use internal checks or authenticated headers.
5.  **Deprecate Stale Workflows:**
    - `Forecast_Monthly_Report`, `Forecast_Rollback` have 0 runs.
    - `Universe_Refresh` (1 run, success) - verify if needed or should be scheduled.

---

## 3. Risk Assessment: Legacy Deletion

**Candidates:** `v3_Finalizer`, `v3_Scrape_Template` (if abandoned), `WP16_Manual...`
**Assessment:**
- `v3_*` workflows seem to be part of an "old" or "alternative" pipeline that is currently broken (0% success).
- **Risk:** High. They might be the *intended* future pipeline that never launched, or the old one.
- **Recommendation:** Do NOT delete yet. Fix `v3_Finalizer` dependency error first to see if they pass. If they are truly legacy (replaced by `EOD_Latest` etc.), then deprecate.
- **Verdict:** Mark as `BROKEN_HOLD` rather than `LEGACY_DELETE` until EOD pipeline is stable.

## 4. Dependency Impact Analysis

- **`EOD_Latest`** is the linchpin. It feeds `Ops_Daily_Snapshot`.
- **`Scheduler_Kick`** triggers the timed events. Its failure means *nothing* runs automatically unless triggered by cron (if configured) or manual dispatch.
- **`Ops_Daily_Snapshot`** failure blinds the dashboard.

**Conclusion:** The entire automation chain is effectively stalled because the `Scheduler` is blocked and the Data extraction (`EOD`) is returning empty. 

**Immediate Action:** Fix `Scheduler_Kick` headers/WAF bypass and debug `EOD` data fetch.
